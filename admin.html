<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NATS Admin Portal</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
    }

    .login-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: #0d0d0d;
    }

    .login-box {
      background: #2a2a2a;
      padding: 40px;
      border-radius: 8px;
      width: 100%;
      max-width: 400px;
      border: 1px solid #404040;
    }

    .login-box h1 {
      color: #fff;
      margin-bottom: 8px;
      font-size: 28px;
    }

    .login-box p {
      color: #999;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: #e0e0e0;
      font-size: 14px;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      background: #1a1a1a;
      border: 1px solid #404040;
      border-radius: 4px;
      color: #e0e0e0;
      font-size: 14px;
    }

    .form-group input:focus {
      outline: none;
      border-color: #0066cc;
      background: #242424;
    }

    .login-btn {
      width: 100%;
      padding: 12px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .login-btn:hover {
      background: #0052a3;
    }

    .error-message {
      color: #ff6b6b;
      margin-bottom: 20px;
      padding: 12px;
      background: #3d2020;
      border-radius: 4px;
      border: 1px solid #cc3333;
      display: none;
      font-size: 14px;
    }

    /* Admin Dashboard */
    .admin-wrapper {
      display: none;
      min-height: 100vh;
      background: #0d0d0d;
    }

    .admin-header {
      background: #1a1a1a;
      border-bottom: 1px solid #404040;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .admin-header h1 {
      color: #fff;
      font-size: 24px;
    }

    .logout-btn {
      padding: 10px 20px;
      background: #d32f2f;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }

    .logout-btn:hover {
      background: #b71c1c;
    }

    .admin-tabs {
      display: flex;
      gap: 10px;
      padding: 0 20px;
      border-bottom: 1px solid #404040;
      background: #1a1a1a;
      position: sticky;
      top: 60px;
      z-index: 50;
    }

    .tab-btn {
      padding: 15px 20px;
      background: transparent;
      color: #999;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }

    .tab-btn:hover {
      color: #e0e0e0;
    }

    .tab-btn.active {
      color: #0066cc;
      border-bottom-color: #0066cc;
    }

    .admin-content {
      padding: 20px;
      max-width: 1600px;
      margin: 0 auto;
    }

    .filters-bar {
      background: #1a1a1a;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #404040;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .filters-bar input,
    .filters-bar select {
      padding: 10px;
      background: #2a2a2a;
      border: 1px solid #404040;
      border-radius: 4px;
      color: #e0e0e0;
      font-size: 14px;
    }

    .filters-bar input:focus,
    .filters-bar select:focus {
      outline: none;
      border-color: #0066cc;
    }

    .search-btn {
      padding: 10px 20px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }

    .search-btn:hover {
      background: #0052a3;
    }

    .table-wrapper {
      background: #1a1a1a;
      border-radius: 8px;
      border: 1px solid #404040;
      overflow-x: auto;
      overflow-y: auto;
      max-height: 600px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      min-width: 2000px;
    }

    th {
      background: #242424;
      padding: 6px 4px;
      text-align: left;
      font-weight: 600;
      color: #e0e0e0;
      border-bottom: 1px solid #404040;
      position: sticky;
      top: 0;
      white-space: nowrap;
      height: 30px;
      line-height: 1;
    }

    td {
      padding: 4px 4px;
      border-bottom: 1px solid #303030;
      color: #e0e0e0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 120px;
      height: 28px;
      line-height: 1.2;
    }

    .editable-cell {
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease;
    }

    .editable-cell:hover {
      background: #2a2a2a;
      outline: 1px solid #0066cc;
    }

    .edit-input {
      width: 100%;
      padding: 2px 4px;
      background: #1a1a1a;
      border: 2px solid #0066cc;
      color: #e0e0e0;
      border-radius: 3px;
      font-size: 11px;
    }

    .edit-input:focus {
      outline: none;
      border-color: #00aa00;
    }

    .edit-select {
      width: 100%;
      padding: 2px 4px;
      background: #1a1a1a;
      border: 2px solid #0066cc;
      color: #e0e0e0;
      border-radius: 3px;
      font-size: 11px;
    }

    tr:hover {
      background: #242424;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-approved {
      background: #1b5e20;
      color: #4caf50;
    }

    .status-pending {
      background: #4d3a00;
      color: #ffc107;
    }

    .status-paid {
      background: #0d47a1;
      color: #42a5f5;
    }

    .status-unpaid {
      background: #b71c1c;
      color: #ff6b6b;
    }

    .class-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      color: white;
      white-space: nowrap;
    }

    .class-cadet {
      background: #d32f2f;
    }

    .class-mini-rok-u10 {
      background: #f57c00;
    }

    .action-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
    }

    .action-badge {
      background: #1a3a52;
      color: #42a5f5;
    }

    .class-mini-rok {
      background: #fbc02d;
      color: #000;
    }

    .class-ok-j {
      background: #388e3c;
    }

    .class-ok-n {
      background: #1976d2;
    }

    .class-kz2 {
      background: #7b1fa2;
    }

    .action-buttons {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 6px 10px;
      font-size: 12px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .edit-btn {
      background: #0066cc;
      color: white;
    }

    .edit-btn:hover {
      background: #0052a3;
    }

    .delete-btn {
      background: #dc2626;
      color: white;
      margin-left: 8px;
    }

    .delete-btn:hover {
      background: #b91c1c;
    }

    .reset-btn {
      background: #ff9800;
      color: white;
    }

    .reset-btn:hover {
      background: #e68900;
    }

    .delete-btn {
      background: #dc3545;
      color: white;
    }

    .delete-btn:hover {
      background: #c82333;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: #1a1a1a;
      padding: 30px;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      border: 1px solid #404040;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-content h2 {
      margin-bottom: 20px;
      color: #fff;
      font-size: 20px;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px;
      background: #2a2a2a;
      border: 1px solid #404040;
      border-radius: 4px;
      color: #e0e0e0;
      font-size: 14px;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #0066cc;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .modal-buttons button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }

    .save-btn {
      background: #4caf50;
      color: white;
    }

    .save-btn:hover {
      background: #388e3c;
    }

    .cancel-btn {
      background: #404040;
      color: #e0e0e0;
    }

    .cancel-btn:hover {
      background: #505050;
    }

    /* Message Styles */
    .message-item {
      padding: 16px;
      border-left: 4px solid #404040;
      background: #242424;
      margin-bottom: 12px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .message-item.msg-unread {
      border-left-color: #ff6b6b;
      background: #2a2424;
    }

    .message-item.msg-read {
      border-left-color: #404040;
      background: #1a1a1a;
      opacity: 0.8;
    }

    .message-item:hover {
      background: #2a2a2a;
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 15px;
    }

    .message-body {
      word-break: break-word;
      line-height: 1.5;
      color: #d0d0d0;
      white-space: pre-wrap;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 4px;
      color: white;
      z-index: 2000;
      animation: slideIn 0.3s ease-out;
      font-size: 14px;
    }

    .toast.success {
      background: #4caf50;
    }

    .toast.error {
      background: #d32f2f;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes successBorderFlash {
      0% {
        border: 4px solid #10b981;
        box-shadow: inset 0 0 0 4px #10b981;
      }
      50% {
        border: 4px solid #10b981;
        box-shadow: inset 0 0 20px rgba(16, 185, 129, 0.6);
      }
      100% {
        border: 4px solid transparent;
        box-shadow: none;
      }
    }

    body.success-flash {
      animation: successBorderFlash 0.8s ease-out;
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-wrapper" id="loginWrapper">
    <div class="login-box">
      <h1>NATS Admin</h1>
      <p>Driver Management Portal</p>
      <div class="error-message" id="errorMessage"></div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="adminPassword" placeholder="Enter password">
      </div>
      <button class="login-btn" onclick="adminLogin()">Sign In</button>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div class="admin-wrapper" id="adminWrapper">
    <div class="admin-header">
      <h1>Driver Management</h1>
      <button class="logout-btn" onclick="adminLogout()">Logout</button>
    </div>

    <div class="admin-tabs">
      <button class="tab-btn active" onclick="switchTab('drivers')">Drivers</button>
      <button class="tab-btn" onclick="switchTab('events')">Events</button>
      <button class="tab-btn" onclick="switchTab('raceEntries')">Race Entries</button>
      <button class="tab-btn" onclick="switchTab('messages')">Messages <span id="msgBadge" style="background:#ef4444; color:white; padding:2px 6px; border-radius:4px; font-size:12px; margin-left:6px;"></span></button>
      <button class="tab-btn" onclick="switchTab('audit')">Audit Trail</button>
    </div>

    <!-- Drivers Tab -->
    <div id="driversTab" class="admin-content">
      <div class="filters-bar">
        <input type="text" id="searchEmail" placeholder="Search email...">
        <input type="text" id="searchName" placeholder="Search name...">
        <select id="filterStatus">
          <option value="">All Status</option>
          <option value="Approved">Approved</option>
          <option value="Pending">Pending</option>
        </select>
        <select id="filterPaid">
          <option value="">All Payment</option>
          <option value="Paid">Paid</option>
          <option value="Unpaid">Unpaid</option>
        </select>
        <button class="search-btn" onclick="loadDrivers()">Search</button>
        <button class="search-btn" onclick="exportDriversCSV()" style="background: #4caf50;">Export CSV</button>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Email</th>
              <th>Name</th>
              <th>DOB</th>
              <th>Nationality</th>
              <th>Gender</th>
              <th>Championship</th>
              <th>Class</th>
              <th>Race #</th>
              <th>Team</th>
              <th>Coach</th>
              <th>Kart Brand</th>
              <th>Transponder</th>
              <th>License #</th>
              <th>Guardian Name</th>
              <th>Contact Phone</th>
              <th>Allergies</th>
              <th>Medical Conditions</th>
              <th>Medication</th>
              <th>Doctor Phone</th>
              <th>Status</th>
              <th>Paid</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="driversTable">
            <tr><td colspan="22" class="loading">Loading drivers...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Events Tab -->
    <div id="eventsTab" class="admin-content" style="display: none;">
      <div class="filters-bar">
        <button class="search-btn" onclick="showCreateEventModal()" style="background: #22c55e; margin-right: 10px;">+ New Event</button>
        <button class="search-btn" onclick="loadEvents()">Refresh Events</button>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Event Name</th>
              <th>Date</th>
              <th>Location</th>
              <th>Entry Fee</th>
              <th>Registration Deadline</th>
              <th>Registrations</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="eventsTable">
            <tr><td colspan="8" class="loading">Loading events...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Race Entries Tab -->
    <div id="raceEntriesTab" class="admin-content" style="display: none;">
      <div class="filters-bar">
        <select id="filterRace">
          <option value="">Loading events...</option>
        </select>
        <button class="search-btn" onclick="loadRaceEntries()">Load Entries</button>
        <button class="search-btn" onclick="exportRaceEntriesCSV()" style="background: #4caf50;">Export CSV</button>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Race</th>
              <th>Email</th>
              <th>Name</th>
              <th>Class</th>
              <th>Entry Fee</th>
              <th>Tyres</th>
              <th>Transponder</th>
              <th>Engine</th>
              <th>Total Amount</th>
              <th>Payment Status</th>
              <th>Team Code</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="raceEntriesTable">
            <tr><td colspan="12" class="loading">Loading race entries...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Messages Tab -->
    <div id="messagesTab" class="admin-content" style="display: none;">
      <div style="margin-bottom: 20px;">
        <button class="search-btn" onclick="loadMessages()" style="margin-right: 10px;">Refresh Messages</button>
        <button class="search-btn" style="background: #666;" onclick="clearReadMessages()">Clear Read</button>
      </div>
      <div id="messagesList" style="background: #2a2a2a; border-radius: 8px;">
        <div class="loading">Loading messages...</div>
      </div>
    </div>

    <!-- Audit Trail Tab -->
    <div id="auditTab" class="admin-content" style="display: none;">
      <div class="filters-bar">
        <input type="text" id="auditSearchDriver" placeholder="Search driver...">
        <select id="auditActionFilter">
          <option value="">All Actions</option>
          <option value="RACE_ENTRY_REGISTERED">Race Entry Registered</option>
          <option value="RACE_ENTRY_CANCELLED">Race Entry Cancelled</option>
          <option value="RACE_ENTRY_UPDATED">Race Entry Updated</option>
          <option value="PASSWORD_SET">Password Set</option>
          <option value="DRIVER_UPDATED">Driver Updated</option>
        </select>
        <button class="search-btn" onclick="loadAuditTrail()">Search</button>
        <button class="search-btn" onclick="exportAuditCSV()" style="background: #4caf50;">Export CSV</button>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Action</th>
              <th>Driver</th>
              <th>Email</th>
              <th>Field</th>
              <th>Old Value</th>
              <th>New Value</th>
              <th>IP Address</th>
            </tr>
          </thead>
          <tbody id="auditTable">
            <tr><td colspan="8" class="loading">Loading audit trail...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <h2>Edit Driver</h2>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="editEmail">
      </div>
      <div class="form-group">
        <label>First Name</label>
        <input type="text" id="editFirstName">
      </div>
      <div class="form-group">
        <label>Last Name</label>
        <input type="text" id="editLastName">
      </div>
      <div class="form-group">
        <label>Class</label>
        <input type="text" id="editClass">
      </div>
      <div class="form-group">
        <label>Race Number</label>
        <input type="text" id="editRaceNumber">
      </div>
      <div class="form-group">
        <label>License Number</label>
        <input type="text" id="editLicenseNumber">
      </div>
      <div class="form-group">
        <label>Transponder Number</label>
        <input type="text" id="editTransponderNumber">
      </div>
      <div class="form-group">
        <label>Team Name</label>
        <input type="text" id="editTeamName">
      </div>
      <div class="form-group">
        <label>Coach Name</label>
        <input type="text" id="editCoachName">
      </div>
      <div class="form-group">
        <label>Kart Brand</label>
        <input type="text" id="editKartBrand">
      </div>
      <div class="form-group">
        <label>Season Engine Rental Status</label>
        <select id="editEngineRentalStatus">
          <option value="N">Not Paid</option>
          <option value="Y">Paid</option>
        </select>
        <small style="display: block; margin-top: 6px; color: #666; font-size: 11px;">For cash payments: Set to "Paid" if driver has paid season engine rental fee</small>
      </div>
      <div class="form-group">
        <label>Next Race Entry Status</label>
        <select id="editNextRaceEntry">
          <option value="Not Registered">Not Registered</option>
          <option value="Registered">Registered</option>
          <option value="Confirmed">Confirmed</option>
        </select>
        <small style="display: block; margin-top: 6px; color: #666; font-size: 11px;">For cash payments: Set based on whether driver has paid for next race</small>
      </div>
      <div class="form-group">
        <label>Next Race Engine Rental Status</label>
        <select id="editNextRaceEngineRental">
          <option value="No">Not Renting</option>
          <option value="Yes">Renting Engine</option>
        </select>
        <small style="display: block; margin-top: 6px; color: #666; font-size: 11px;">For cash payments: Set to "Renting Engine" if driver rented engine for this race</small>
      </div>
      <div class="form-group">
        <label>Status</label>
        <select id="editStatus">
          <option value="Pending">Pending</option>
          <option value="Approved">Approved</option>
        </select>
      </div>
      <div class="form-group">
        <label>Paid Status</label>
        <select id="editPaid">
          <option value="Unpaid">Unpaid</option>
          <option value="Paid">Paid</option>
        </select>
      </div>

      <!-- Guardian / Entrant Contact Section -->
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
        <h3 style="margin: 0 0 12px 0; font-size: 14px; color: #374151;">Guardian / Entrant Contact</h3>
        <div class="form-group">
          <label>Guardian Name</label>
          <input type="text" id="editContactName" readonly style="background: #f3f4f6; color: #666;">
        </div>
        <div class="form-group">
          <label>Relationship</label>
          <input type="text" id="editContactRelationship" readonly style="background: #f3f4f6; color: #666;">
        </div>
        <div class="form-group">
          <label>Contact Phone</label>
          <input type="text" id="editContactPhone" readonly style="background: #f3f4f6; color: #666;">
        </div>
        <div class="form-group">
          <label>Emergency Contact?</label>
          <input type="text" id="editContactEmergency" readonly style="background: #f3f4f6; color: #666;">
        </div>
        <div class="form-group">
          <label>Consent Contact?</label>
          <input type="text" id="editContactConsent" readonly style="background: #f3f4f6; color: #666;">
        </div>
      </div>

      <!-- Medical & Consent Section -->
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
        <h3 style="margin: 0 0 12px 0; font-size: 14px; color: #374151;">Medical & Consent</h3>
        <div class="form-group">
          <label>Allergies</label>
          <input type="text" id="editMedicalAllergies" readonly style="background: #f3f4f6; color: #666;">
        </div>
        <div class="form-group">
          <label>Medical Conditions</label>
          <input type="text" id="editMedicalConditions" readonly style="background: #f3f4f6; color: #666;">
        </div>
        <div class="form-group">
          <label>Medication</label>
          <input type="text" id="editMedicalMedication" readonly style="background: #f3f4f6; color: #666;">
        </div>
        <div class="form-group">
          <label>Doctor Phone</label>
          <input type="text" id="editMedicalDoctorPhone" readonly style="background: #f3f4f6; color: #666;">
        </div>
        <div class="form-group">
          <label>Data Processing Consent</label>
          <input type="text" id="editMedicalConsentSigned" readonly style="background: #f3f4f6; color: #666;">
        </div>
        <div class="form-group">
          <label>Media Release</label>
          <input type="text" id="editMediaReleaseSigned" readonly style="background: #f3f4f6; color: #666;">
        </div>
      </div>

      <!-- Driver Documents Section -->
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
        <h3 style="margin: 0 0 12px 0; font-size: 14px; color: #374151;">Medical & Consent</h3>
        <div class="form-group">
          <label>Driver License</label>
          <div id="driverLicenseSection" style="padding: 8px 12px; background: #f3f4f6; border-radius: 4px; font-size: 13px;">
            <button type="button" id="viewLicenseBtn" class="btn" style="background: #3b82f6; color: white; padding: 4px 8px; border: none; border-radius: 3px; cursor: pointer; margin-right: 8px;">View License</button>
            <span id="licenseStatus" style="color: #666;">No license uploaded</span>
          </div>
        </div>
        <div class="form-group">
          <label>Profile Photo</label>
          <div id="profilePhotoSection" style="padding: 8px 12px; background: #f3f4f6; border-radius: 4px; font-size: 13px;">
            <button type="button" id="viewPhotoBtn" class="btn" style="background: #3b82f6; color: white; padding: 4px 8px; border: none; border-radius: 3px; cursor: pointer; margin-right: 8px;">View Photo</button>
            <span id="photoStatus" style="color: #666;">No photo uploaded</span>
          </div>
        </div>
      </div>

      <div class="modal-buttons">
        <button class="cancel-btn" onclick="closeEditModal()">Cancel</button>
        <button class="save-btn" onclick="resendWelcomeEmail()" style="background: #10b981;">Resend Welcome Email</button>
        <button class="save-btn" onclick="saveDriver()">Save</button>
      </div>
    </div>
  </div>

  <!-- Event Modal -->
  <div class="modal" id="eventModal">
    <div class="modal-content" style="max-width: 500px;">
      <h2 id="eventModalTitle">Create Event</h2>
      <div class="form-group">
        <label>Event Name</label>
        <input type="text" id="eventName" placeholder="e.g., Northern Regions Crown">
      </div>
      <div class="form-group">
        <label>Event Date</label>
        <input type="date" id="eventDate">
      </div>
      <div class="form-group">
        <label>Location</label>
        <input type="text" id="eventLocation" placeholder="e.g., Redstar Raceway">
      </div>
      <div class="form-group">
        <label>Entry Fee (R)</label>
        <input type="number" id="eventEntryFee" placeholder="e.g., 2950" step="0.01">
      </div>
      <div class="form-group">
        <label>Registration Deadline</label>
        <input type="date" id="eventDeadline">
      </div>
      <div class="modal-buttons">
        <button class="cancel-btn" onclick="closeEventModal()">Cancel</button>
        <button id="eventDeleteBtn" class="cancel-btn" style="background: #ef4444; display: none;" onclick="deleteEvent()">Delete</button>
        <button class="save-btn" onclick="saveEvent()">Save Event</button>
      </div>
    </div>
  </div>

  <script>
    const ADMIN_PASSWORD = 'natsadmin2026';
    let currentDriver = null;
    let allDrivers = [];

    function adminLogin() {
      const pwEl = document.getElementById('adminPassword');
      if (!pwEl) {
        console.error('adminPassword element not found');
        return;
      }
      
      const password = pwEl.value;
      if (password === ADMIN_PASSWORD) {
        const loginWrapper = document.getElementById('loginWrapper');
        const adminWrapper = document.getElementById('adminWrapper');
        if (loginWrapper) loginWrapper.style.display = 'none';
        if (adminWrapper) adminWrapper.style.display = 'block';
        loadDrivers();
      } else {
        const errorMsg = document.getElementById('errorMessage');
        if (errorMsg) {
          errorMsg.textContent = 'Invalid password';
          errorMsg.style.display = 'block';
        }
      }
    }

    // Add Enter key handler for password input
    document.addEventListener('DOMContentLoaded', function() {
      const pwEl = document.getElementById('adminPassword');
      if (pwEl) {
        pwEl.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            adminLogin();
          }
        });
      }
    });

    function adminLogout() {
      const loginWrapper = document.getElementById('loginWrapper');
      const adminWrapper = document.getElementById('adminWrapper');
      const pwEl = document.getElementById('adminPassword');
      const errorMsg = document.getElementById('errorMessage');
      
      if (loginWrapper) loginWrapper.style.display = 'flex';
      if (adminWrapper) adminWrapper.style.display = 'none';
      if (pwEl) pwEl.value = '';
      if (errorMsg) errorMsg.style.display = 'none';
    }

    async function loadDrivers() {
      try {
        const payload = {
          email: document.getElementById('searchEmail').value,
          name: document.getElementById('searchName').value,
          status: document.getElementById('filterStatus').value,
          paid: document.getElementById('filterPaid').value
        };

        console.log('Loading drivers with payload:', payload);

        const response = await fetch('/api/getAllDrivers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        console.log('Response status:', response.status);
        const result = await response.json();
        console.log('Response data:', result);

        if (!response.ok || !result.success) {
          throw new Error(result.error?.message || 'Failed to load drivers');
        }

        allDrivers = result.data.drivers || [];
        console.log('Drivers loaded:', allDrivers.length);
        displayDrivers(allDrivers);
      } catch (err) {
        console.error('Error:', err);
        showToast(err.message, 'error');
        const table = document.getElementById('driversTable');
        if (table) {
          table.innerHTML = '<tr><td colspan="10" class="loading">Error loading drivers: ' + err.message + '</td></tr>';
        }
      }
    }

    function displayDrivers(drivers) {
      const table = document.getElementById('driversTable');
      if (!table) {
        console.error('driversTable element not found');
        return;
      }
      
      console.log('displayDrivers called with', drivers.length, 'drivers');
      
      if (!drivers || drivers.length === 0) {
        console.log('No drivers to display');
        table.innerHTML = '<tr><td colspan="22" class="loading">No drivers found</td></tr>';
        return;
      }

      let html = '';
      drivers.forEach((driver, index) => {
        console.log(`Processing driver ${index}:`, driver);
        const email = driver.driver_email || driver.email || '-';
        const name = `${driver.first_name || ''} ${driver.last_name || ''}`.trim() || '-';
        const status = driver.status || 'Pending';
        const paidStatus = driver.paid_status || 'Unpaid';

        html += `
          <tr>
            <td>${email}</td>
            <td>${name}</td>
            <td>${driver.date_of_birth || '-'}</td>
            <td>${driver.nationality || '-'}</td>
            <td>${driver.gender || '-'}</td>
            <td>${driver.championship || '-'}</td>
            <td>${driver.class ? `<span class="class-badge ${getClassBadgeClass(driver.class)}">${driver.class}</span>` : '-'}</td>
            <td>${driver.race_number || '-'}</td>
            <td>${driver.team_name || '-'}</td>
            <td>${driver.coach_name || '-'}</td>
            <td>${driver.kart_brand || '-'}</td>
            <td>${driver.transponder_number || '-'}</td>
            <td>${driver.license_number || '-'}</td>
            <td>${driver.contact_name || '-'}</td>
            <td>${driver.contact_phone || '-'}</td>
            <td>${driver.medical_allergies || '-'}</td>
            <td>${driver.medical_conditions || '-'}</td>
            <td>${driver.medical_medication || '-'}</td>
            <td>${driver.medical_doctor_phone || '-'}</td>
            <td><span class="status-badge status-${status.toLowerCase()}">${status}</span></td>
            <td>${paidStatus}</td>
            <td>
              <div class="action-buttons">
                <button class="action-btn edit-btn" onclick="openEditModal('${driver.driver_id}')">Edit</button>
                <button class="action-btn reset-btn" onclick="resetPassword('${driver.driver_id}')">Reset PW</button>
                <button class="action-btn delete-btn" onclick="deleteDriver('${driver.driver_id}', '${driver.first_name} ${driver.last_name}')">Delete</button>
              </div>
            </td>
          </tr>
        `;
      });

      console.log('Generated HTML length:', html.length);
      console.log('Setting innerHTML to table');
      table.innerHTML = html;
      console.log('Table innerHTML set successfully');
    }

    function getClassBadgeClass(className) {
      if (!className) return '';
      const classMap = {
        'CADET': 'class-cadet',
        'MINI ROK U/10': 'class-mini-rok-u10',
        'MINI ROK': 'class-mini-rok',
        'OK-J': 'class-ok-j',
        'OK-N': 'class-ok-n',
        'KZ2': 'class-kz2'
      };
      return classMap[className] || '';
    }

    function openEditModal(driverId) {
      if (!driverId) {
        showToast('No driver ID provided', 'error');
        return;
      }
      
      const driver = allDrivers.find(d => d.driver_id == driverId);
      if (!driver) {
        showToast('Driver not found in list', 'error');
        return;
      }
      
      currentDriver = driver;
      
      // Set form values safely - handle undefined/null fields
      const setVal = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.value = (value || '');
      };
      setVal('editEmail', driver.driver_email || driver.email || '');
      setVal('editFirstName', driver.first_name);
      setVal('editLastName', driver.last_name);
      setVal('editClass', driver.class);
      setVal('editRaceNumber', driver.race_number);
      setVal('editLicenseNumber', driver.license_number);
      setVal('editTransponderNumber', driver.transponder_number);
      setVal('editTeamName', driver.team_name);
      setVal('editCoachName', driver.coach_name);
      setVal('editKartBrand', driver.kart_brand);
      setVal('editEngineRentalStatus', driver.paid_engine_fee || 'N');
      setVal('editNextRaceEntry', driver.next_race_entry_status || 'Not Registered');
      setVal('editNextRaceEngineRental', driver.next_race_engine_rental_status || 'No');
      setVal('editStatus', driver.status || 'Pending');
      setVal('editPaid', driver.paid_status || 'Unpaid');
      
      // Set contact fields (read-only)
      setVal('editContactName', driver.contact_name || '(not provided)');
      setVal('editContactRelationship', driver.contact_relationship || '(not provided)');
      setVal('editContactPhone', driver.contact_phone || '(not provided)');
      setVal('editContactEmergency', driver.contact_emergency ? 'Yes' : 'No');
      setVal('editContactConsent', driver.contact_consent ? 'Yes' : 'No');
      
      // Set medical fields (read-only)
      setVal('editMedicalAllergies', driver.medical_allergies || '(not provided)');
      setVal('editMedicalConditions', driver.medical_conditions || '(not provided)');
      setVal('editMedicalMedication', driver.medical_medication || '(not provided)');
      setVal('editMedicalDoctorPhone', driver.medical_doctor_phone || '(not provided)');
      setVal('editMedicalConsentSigned', driver.medical_consent_signed || '(not provided)');
      setVal('editMediaReleaseSigned', driver.media_release_signed ? 'Yes' : 'No');
      
      // Update document status display
      const licenseStatus = document.getElementById('licenseStatus');
      const photoStatus = document.getElementById('photoStatus');
      if (driver.license_document) {
        licenseStatus.textContent = 'âœ“ License uploaded';
        licenseStatus.style.color = '#10b981';
      } else {
        licenseStatus.textContent = 'No license uploaded';
        licenseStatus.style.color = '#666';
      }
      if (driver.profile_photo) {
        photoStatus.textContent = 'âœ“ Photo uploaded';
        photoStatus.style.color = '#10b981';
      } else {
        photoStatus.textContent = 'No photo uploaded';
        photoStatus.style.color = '#666';
      }
      
      // Add event listeners for file download buttons
      const viewLicenseBtn = document.getElementById('viewLicenseBtn');
      const viewPhotoBtn = document.getElementById('viewPhotoBtn');
      
      if (viewLicenseBtn) {
        viewLicenseBtn.onclick = () => viewDriverFile(driver.driver_id, 'license');
      }
      if (viewPhotoBtn) {
        viewPhotoBtn.onclick = () => viewDriverFile(driver.driver_id, 'photo');
      }
      
      const modal = document.getElementById('editModal');
      if (modal) {
        modal.classList.add('show');
      }
    }

    async function viewDriverFile(driverId, fileType) {
      try {
        const response = await fetch('/api/downloadDriverFile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ driver_id: driverId, file_type: fileType })
        });
        const result = await response.json();
        
        if (!result.success) throw new Error(result.error.message);
        
        const { b64, fileName, mimeType } = result.data;
        
        // Open in new window or download depending on type
        if (mimeType.startsWith('image/')) {
          // For images, open in new tab to view
          const imgWindow = window.open();
          imgWindow.document.write(`<img src="data:${mimeType};base64,${b64}" style="max-width:100%; padding:20px;">`);
        } else {
          // For PDFs or other files, download
          const link = document.createElement('a');
          link.href = `data:${mimeType};base64,${b64}`;
          link.download = fileName || `${fileType}.pdf`;
          link.click();
        }
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    function closeEditModal() {
      const modal = document.getElementById('editModal');
      if (modal) {
        modal.classList.remove('show');
      }
    }

    async function saveDriver() {
      try {
        // Validate currentDriver exists
        if (!currentDriver || !currentDriver.driver_id) {
          showToast('No driver selected', 'error');
          return;
        }
        
        // Safely get element values
        const getVal = (id) => {
          const el = document.getElementById(id);
          return el ? (el.value || '') : '';
        };
        
        const payload = {
          driver_id: currentDriver.driver_id,
          email: getVal('editEmail'),
          first_name: getVal('editFirstName'),
          last_name: getVal('editLastName'),
          class: getVal('editClass'),
          race_number: getVal('editRaceNumber'),
          license_number: getVal('editLicenseNumber'),
          transponder_number: getVal('editTransponderNumber'),
          team_name: getVal('editTeamName'),
          coach_name: getVal('editCoachName'),
          kart_brand: getVal('editKartBrand'),
          paid_engine_fee: getVal('editEngineRentalStatus'),
          next_race_entry_status: getVal('editNextRaceEntry'),
          next_race_engine_rental_status: getVal('editNextRaceEngineRental'),
          status: getVal('editStatus'),
          paid_status: getVal('editPaid')
        };
        
        console.log('Saving with payload:', payload);
        
        const response = await fetch('/api/updateDriver', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error('HTTP ' + response.status);
        }
        
        const result = await response.json();
        if (!result.success) throw new Error(result.error?.message || 'Update failed');

        showToast('Driver updated successfully', 'success');
        closeEditModal();
        loadDrivers();
      } catch (err) {
        console.error('saveDriver error:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    async function resetPassword(driverId) {
      if (!driverId) {
        showToast('No driver ID provided', 'error');
        return;
      }
      
      if (!confirm('Send password reset email to this driver?')) return;

      try {
        const response = await fetch('/api/sendPasswordReset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ driver_id: driverId })
        });

        if (!response.ok) throw new Error('HTTP ' + response.status);

        const result = await response.json();
        if (!result.success) throw new Error(result.error?.message || 'Failed to send email');

        showToast('Password reset email sent', 'success');
      } catch (err) {
        console.error('resetPassword error:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    async function resendWelcomeEmail() {
      if (!currentDriver || !currentDriver.driver_id) {
        showToast('No driver selected', 'error');
        return;
      }

      const email = document.getElementById('editEmail')?.value?.trim();
      if (!email) {
        showToast('No email address found', 'error');
        return;
      }
      
      if (!confirm(`Send welcome email to ${email}?`)) return;

      try {
        const response = await fetch('/api/admin/resendWelcomeEmail', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            driver_id: currentDriver.driver_id,
            email: email
          })
        });

        if (!response.ok) throw new Error('HTTP ' + response.status);

        const result = await response.json();
        if (!result.success) throw new Error(result.error?.message || 'Failed to send email');

        showToast('Welcome email sent successfully', 'success');
      } catch (err) {
        console.error('resendWelcomeEmail error:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    async function deleteDriver(driverId, driverName) {
      if (!driverId) {
        showToast('No driver ID provided', 'error');
        return;
      }
      
      if (!confirm(`âš ï¸ WARNING: This will permanently delete ${driverName}. This cannot be undone!\n\nAre you sure?`)) return;

      try {
        const response = await fetch('/api/admin/deleteDriver', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ driver_id: driverId })
        });

        if (!response.ok) throw new Error('HTTP ' + response.status);

        const result = await response.json();
        if (!result.success) throw new Error(result.error?.message || 'Failed to delete driver');

        showToast(`Driver ${driverName} deleted successfully`, 'success');
        
        // Reload the driver list
        setTimeout(() => {
          loadDrivers();
        }, 500);
      } catch (err) {
        console.error('deleteDriver error:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    async function exportDriversCSV() {
      try {
        console.log('Initiating CSV export...');
        showToast('Preparing CSV export...', 'info');
        
        const response = await fetch('/api/admin/exportDriversCSV', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ includeDeleted: false })
        });

        if (!response.ok) throw new Error('HTTP ' + response.status);

        // Get the CSV content
        const csvText = await response.text();
        
        // Create blob and download
        const blob = new Blob([csvText], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `drivers-export-${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        console.log('CSV export successful');
        showToast('CSV export downloaded successfully', 'success');
      } catch (err) {
        console.error('exportDriversCSV error:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    // Load events into Race Entries dropdown
    async function loadRaceEntriesDropdown() {
      try {
        const response = await fetch('/api/getAvailableEvents');
        const data = await response.json();
        
        if (data.success && data.data) {
          const dropdown = document.getElementById('filterRace');
          dropdown.innerHTML = '<option value="">Select an event...</option>';
          
          data.data.forEach(event => {
            const option = document.createElement('option');
            option.value = event.event_id;
            const eventDate = new Date(event.event_date).toLocaleDateString('en-ZA');
            option.textContent = `${event.event_name} (${eventDate})`;
            dropdown.appendChild(option);
          });
        }
      } catch (err) {
        console.error('Error loading events:', err);
        document.getElementById('filterRace').innerHTML = '<option value="">Error loading events</option>';
      }
    }

    // Load race entries for selected event
    async function loadRaceEntries() {
      try {
        const eventId = document.getElementById('filterRace').value;
        if (!eventId) {
          showToast('Please select an event', 'info');
          return;
        }

        const response = await fetch('/api/getRaceEntries', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ eventId: eventId })
        });

        const result = await response.json();
        
        if (!response.ok || !result.success) {
          throw new Error(result.error?.message || 'Failed to load race entries');
        }

        displayRaceEntries(result.data?.entries || []);
      } catch (err) {
        console.error('Error loading race entries:', err);
        showToast(err.message, 'error');
        const table = document.getElementById('raceEntriesTable');
        if (table) {
          table.innerHTML = '<tr><td colspan="12" class="loading">Error loading race entries: ' + err.message + '</td></tr>';
        }
      }
    }

    function displayRaceEntries(entries) {
      const table = document.getElementById('raceEntriesTable');
      if (!table) return;
      
      if (!entries || entries.length === 0) {
        table.innerHTML = '<tr><td colspan="12" class="loading">No entries found</td></tr>';
        return;
      }

      console.log('ðŸ“Š displayRaceEntries - Received entries:', entries);
      if (entries.length > 0) {
        console.log('ðŸ” First entry object keys:', Object.keys(entries[0]));
        console.log('ðŸ” First entry data:', entries[0]);
      }

      let html = '';
      entries.forEach((entry) => {
        const itemsArray = entry.entry_items ? JSON.parse(typeof entry.entry_items === 'string' ? entry.entry_items : JSON.stringify(entry.entry_items)) : [];
        
        // Tyres: Show âœ“ if selected, "No" if not selected
        const tyres = itemsArray.some(i => i.name && i.name.toLowerCase().includes('tyre')) ? 'âœ“' : 'No';
        
        // Transponder: Show âœ“ if selected, otherwise check driver's transponder_number
        let transponderDisplay = '';
        const transponderSelected = itemsArray.some(i => i.name && (i.name.toLowerCase().includes('transponder') || i.name.toLowerCase().includes('rent')));
        if (transponderSelected) {
          transponderDisplay = 'âœ“';
        } else if (entry.transponder_number) {
          transponderDisplay = entry.transponder_number;
        } else {
          transponderDisplay = '<span style="color: red; font-weight: bold;">REQUIRED</span>';
        }
        
        // Check both the entry_items array AND the new engine column
        const hasEngineFromItems = itemsArray.some(i => i.name && i.name.toLowerCase().includes('engine'));
        const hasEngineFromColumn = entry.engine === 1 || entry.engine === '1';
        const engineDisplay = (hasEngineFromItems || hasEngineFromColumn) ? 'âœ“' : '';
        
        console.log(`Entry: ${entry.driver_email || 'N/A'} - Engine from items: ${hasEngineFromItems}, Engine column: ${entry.engine}, Display: ${engineDisplay}`);
        
        const driverName = `${entry.driver_first_name || ''} ${entry.driver_last_name || ''}`.trim();
        const eventDate = entry.event_date ? new Date(entry.event_date).toLocaleDateString('en-ZA') : (entry.created_at ? new Date(entry.created_at).toLocaleDateString('en-ZA') : '-');
        const entryId = entry.race_entry_id || entry.entry_id;
        
        html += `
          <tr data-entry-id="${entryId}">
            <td>${eventDate}</td>
            <td>${entry.driver_email || '-'}</td>
            <td>${driverName || '-'}</td>
            <td><span class="class-badge">${entry.race_class || entry.driver_class || '-'}</span></td>
            <td class="editable-cell" onclick="editCell(this, '${entryId}', 'amount_paid', ${entry.amount_paid || 0})">R${parseFloat(entry.amount_paid || entry.entry_fee || 0).toLocaleString('en-ZA', {minimumFractionDigits: 2})}</td>
            <td>${tyres}</td>
            <td class="editable-cell" onclick="editCell(this, '${entryId}', 'transponder_number', '${entry.transponder_number || ''}')">${transponderDisplay}</td>
            <td class="editable-cell" onclick="editCell(this, '${entryId}', 'engine', ${hasEngineFromColumn ? 1 : 0})">${engineDisplay}</td>
            <td class="editable-cell" onclick="editCell(this, '${entryId}', 'amount_paid', ${entry.amount_paid || 0})"><strong>R${parseFloat(entry.amount_paid || entry.entry_fee || 0).toLocaleString('en-ZA', {minimumFractionDigits: 2})}</strong></td>
            <td class="editable-cell" onclick="editCell(this, '${entryId}', 'payment_status', '${entry.payment_status || 'Pending'}')"  data-type="select">
              <span class="status-badge status-${(entry.payment_status || 'pending').toLowerCase()}">${entry.payment_status || 'Pending'}</span>
            </td>
            <td class="editable-cell" onclick="editCell(this, '${entryId}', 'team_code', '${entry.team_code || ''}')">${entry.team_code ? entry.team_code : '-'}</td>
            <td>
              <button class="action-btn edit-btn" onclick="confirmRaceEntry('${entryId}')">Confirm</button>
              <button class="action-btn delete-btn" onclick="deleteRaceEntry('${entryId}', '${driverName}')">Delete</button>
            </td>
          </tr>
        `;
      });

      table.innerHTML = html;
    }

    async function editCell(cellElement, entryId, fieldName, currentValue) {
      // Prevent editing if already in edit mode
      if (cellElement.querySelector('input, select')) return;

      const originalContent = cellElement.innerHTML;
      const isCheckbox = fieldName === 'engine';
      const isSelect = cellElement.getAttribute('data-type') === 'select';
      
      let inputElement;
      
      if (isCheckbox) {
        // Toggle checkbox for engine field
        inputElement = document.createElement('input');
        inputElement.type = 'checkbox';
        inputElement.checked = currentValue === 1 || currentValue === true;
        inputElement.className = 'edit-input';
      } else if (isSelect) {
        // Dropdown for payment status
        inputElement = document.createElement('select');
        inputElement.className = 'edit-select';
        const statuses = ['Pending', 'Completed', 'Confirmed', 'Failed'];
        statuses.forEach(status => {
          const option = document.createElement('option');
          option.value = status;
          option.textContent = status;
          option.selected = currentValue === status;
          inputElement.appendChild(option);
        });
      } else if (fieldName === 'amount_paid') {
        // Number input for amounts
        inputElement = document.createElement('input');
        inputElement.type = 'number';
        inputElement.step = '0.01';
        inputElement.value = parseFloat(currentValue) || 0;
        inputElement.className = 'edit-input';
      } else {
        // Text input for other fields
        inputElement = document.createElement('input');
        inputElement.type = 'text';
        inputElement.value = currentValue || '';
        inputElement.className = 'edit-input';
      }

      cellElement.innerHTML = '';
      cellElement.appendChild(inputElement);
      inputElement.focus();

      // Save on blur or Enter key
      const saveEdit = async () => {
        let newValue = isCheckbox ? inputElement.checked : inputElement.value;
        
        if (newValue === currentValue) {
          cellElement.innerHTML = originalContent;
          return;
        }

        try {
          showToast('Saving...', 'info');
          
          const response = await fetch('/api/updateRaceEntry', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              race_entry_id: entryId,
              field: fieldName,
              value: newValue
            })
          });

          const result = await response.json();
          
          if (!response.ok || !result.success) {
            throw new Error(result.error?.message || 'Failed to save');
          }

          showToast(`${fieldName} updated successfully!`, 'success');
          
          // Reload the table to show updated data
          loadRaceEntries();
        } catch (err) {
          console.error('Error saving edit:', err);
          showToast(err.message, 'error');
          cellElement.innerHTML = originalContent;
        }
      };

      inputElement.addEventListener('blur', saveEdit);
      inputElement.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          saveEdit();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          cellElement.innerHTML = originalContent;
        }
      });
    }

    async function confirmRaceEntry(entryId) {
      try {
        const response = await fetch('/api/confirmRaceEntry', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ race_entry_id: entryId })
        });

        const result = await response.json();
        
        if (!response.ok || !result.success) {
          throw new Error(result.error?.message || 'Failed to confirm entry');
        }

        showToast('Race entry confirmed!', 'success');
        loadRaceEntries();
      } catch (err) {
        console.error('Error confirming race entry:', err);
        showToast(err.message, 'error');
      }
    }

    async function deleteRaceEntry(entryId, driverName) {
      // Confirm deletion
      if (!confirm(`Are you sure you want to delete the race entry for ${driverName}? This action cannot be undone.`)) {
        return;
      }

      try {
        showToast('Deleting entry...', 'info');
        
        const response = await fetch('/api/deleteRaceEntry', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ entry_id: entryId })
        });

        const result = await response.json();
        
        if (!response.ok || !result.success) {
          throw new Error(result.error?.message || 'Failed to delete entry');
        }

        showToast('Race entry deleted successfully!', 'success');
        loadRaceEntries();
      } catch (err) {
        console.error('Error deleting race entry:', err);
        showToast(err.message, 'error');
      }
    }

    async function exportRaceEntriesCSV() {
      try {
        const race = document.getElementById('filterRace').value;
        if (!race) {
          showToast('Please select a race', 'info');
          return;
        }

        showToast('Preparing CSV export...', 'info');
        
        const response = await fetch('/api/exportRaceEntriesCSV', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ race_event: race })
        });

        if (!response.ok) throw new Error('HTTP ' + response.status);

        const csvText = await response.text();
        const blob = new Blob([csvText], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `race-entries-${race.replace(/[\/\s]/g, '-')}-${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('CSV export downloaded successfully', 'success');
      } catch (err) {
        console.error('exportRaceEntriesCSV error:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }


    function showToast(message, type) {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      // Trigger border flash on success
      if (type === 'success') {
        document.body.classList.add('success-flash');
        setTimeout(() => {
          document.body.classList.remove('success-flash');
        }, 800);
      }
      
      setTimeout(() => toast.remove(), 3000);
    }

    // Tab switching
    function switchTab(tabName) {
      const driversTab = document.getElementById('driversTab');
      const eventsTab = document.getElementById('eventsTab');
      const raceEntriesTab = document.getElementById('raceEntriesTab');
      const messagesTab = document.getElementById('messagesTab');
      const auditTab = document.getElementById('auditTab');
      const tabs = document.querySelectorAll('.tab-btn');

      if (tabName === 'drivers') {
        driversTab.style.display = 'block';
        eventsTab.style.display = 'none';
        raceEntriesTab.style.display = 'none';
        messagesTab.style.display = 'none';
        auditTab.style.display = 'none';
        tabs[0].classList.add('active');
        tabs[1].classList.remove('active');
        tabs[2].classList.remove('active');
        tabs[3].classList.remove('active');
        tabs[4].classList.remove('active');
      } else if (tabName === 'events') {
        driversTab.style.display = 'none';
        eventsTab.style.display = 'block';
        raceEntriesTab.style.display = 'none';
        messagesTab.style.display = 'none';
        auditTab.style.display = 'none';
        tabs[0].classList.remove('active');
        tabs[1].classList.add('active');
        tabs[2].classList.remove('active');
        tabs[3].classList.remove('active');
        tabs[4].classList.remove('active');
        loadEvents();
      } else if (tabName === 'raceEntries') {
        driversTab.style.display = 'none';
        eventsTab.style.display = 'none';
        raceEntriesTab.style.display = 'block';
        messagesTab.style.display = 'none';
        auditTab.style.display = 'none';
        tabs[0].classList.remove('active');
        tabs[1].classList.remove('active');
        tabs[2].classList.add('active');
        tabs[3].classList.remove('active');
        tabs[4].classList.remove('active');
        loadRaceEntriesDropdown();
      } else if (tabName === 'messages') {
        driversTab.style.display = 'none';
        eventsTab.style.display = 'none';
        raceEntriesTab.style.display = 'none';
        messagesTab.style.display = 'block';
        auditTab.style.display = 'none';
        tabs[0].classList.remove('active');
        tabs[1].classList.remove('active');
        tabs[2].classList.remove('active');
        tabs[3].classList.add('active');
        tabs[4].classList.remove('active');
        loadMessages();
      } else if (tabName === 'audit') {
        driversTab.style.display = 'none';
        eventsTab.style.display = 'none';
        raceEntriesTab.style.display = 'none';
        messagesTab.style.display = 'none';
        auditTab.style.display = 'block';
        tabs[0].classList.remove('active');
        tabs[1].classList.remove('active');
        tabs[2].classList.remove('active');
        tabs[3].classList.remove('active');
        tabs[4].classList.add('active');
        loadAuditTrail();
      }
    }

    // Load messages from backend
    async function loadMessages() {
      try {
        const response = await fetch('/api/getAdminMessages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });

        const result = await response.json();
        if (!result.success) throw new Error(result.error?.message || 'Failed to load messages');

        const messages = result.data.messages || [];
        displayMessages(messages);

        // Update badge
        const unreadCount = messages.filter(m => !m.read_status).length;
        const badge = document.getElementById('msgBadge');
        if (badge) {
          badge.textContent = unreadCount > 0 ? unreadCount : '';
        }
      } catch (err) {
        console.error('loadMessages error:', err);
        const msgList = document.getElementById('messagesList');
        if (msgList) {
          msgList.innerHTML = '<div style="padding: 20px; color: #ef4444;">Error loading messages: ' + err.message + '</div>';
        }
      }
    }

    // Display messages
    function displayMessages(messages) {
      const msgList = document.getElementById('messagesList');
      if (!msgList) return;

      if (!messages || messages.length === 0) {
        msgList.innerHTML = '<div style="padding: 40px; text-align: center; color: #666;">No messages yet</div>';
        return;
      }

      let html = '';
      messages.forEach((msg) => {
        const readClass = msg.read_status ? 'msg-read' : 'msg-unread';
        const createdDate = new Date(msg.created_at).toLocaleString();
        html += `
          <div class="message-item ${readClass}">
            <div class="message-header">
              <div style="flex: 1;">
                <div style="font-weight: 600; color: #fff; margin-bottom: 6px;">${msg.subject}</div>
                <div style="font-size: 13px; color: #0066cc; font-weight: 500; margin-bottom: 2px;"><strong>Account:</strong> ${msg.registered_email}</div>
                <div style="font-size: 12px; color: #ffa500; margin-bottom: 4px;"><strong>Provided:</strong> ${msg.driver_email}</div>
                <div style="font-size: 12px; color: #999;">From: ${msg.driver_name}</div>
                <div style="font-size: 12px; color: #999;">${createdDate}</div>
              </div>
              <button class="msg-btn" onclick="markMessageRead(${msg.id})" style="background: #0066cc; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Mark Read</button>
            </div>
            <div class="message-body" style="margin-top: 10px; padding: 12px; background: #1a1a1a; border-radius: 4px; border-left: 3px solid #0066cc;">
              ${msg.message.replace(/\n/g, '<br />')}
            </div>
            <div style="margin-top: 8px; font-size: 12px; color: #666;">
              ${msg.driver_phone ? '<strong>Phone:</strong> ' + msg.driver_phone + '<br />' : ''}
            </div>
          </div>
        `;
      });

      msgList.innerHTML = html;
    }

    // Mark message as read
    async function markMessageRead(messageId) {
      try {
        const response = await fetch('/api/markMessageAsRead', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message_id: messageId })
        });

        const result = await response.json();
        if (!result.success) throw new Error(result.error?.message || 'Failed to mark message');

        loadMessages();
      } catch (err) {
        console.error('markMessageRead error:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    // Clear read messages
    function clearReadMessages() {
      if (!confirm('Delete all read messages? This cannot be undone.')) return;
      // Could implement if needed
      showToast('Feature coming soon', 'error');
    }

    // ============= EVENT MANAGEMENT FUNCTIONS =============

    let currentEvent = null;

    async function loadEvents() {
      try {
        const response = await fetch('/api/getAllEvents');
        const data = await response.json();
        
        if (!data.success) throw new Error(data.message || 'Failed to load events');
        
        displayEvents(data.events || []);
      } catch (err) {
        console.error('loadEvents error:', err);
        document.getElementById('eventsTable').innerHTML = `<tr><td colspan="8" style="color: #ef4444;">Error: ${err.message}</td></tr>`;
      }
    }

    function displayEvents(events) {
      const tbody = document.getElementById('eventsTable');
      if (events.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">No events found</td></tr>';
        return;
      }

      tbody.innerHTML = events.map(event => {
        const eventDate = new Date(event.event_date).toLocaleDateString('en-ZA');
        const deadline = new Date(event.registration_deadline).toLocaleDateString('en-ZA');
        const created = new Date(event.created_at).toLocaleDateString('en-ZA');
        const registrationsCount = event.registration_count || 0;

        return `
          <tr>
            <td>${event.event_name}</td>
            <td>${eventDate}</td>
            <td>${event.location || '-'}</td>
            <td>R${parseFloat(event.entry_fee).toLocaleString('en-ZA')}</td>
            <td>${deadline}</td>
            <td><strong>${registrationsCount}</strong></td>
            <td>${created}</td>
            <td>
              <button class="action-btn" onclick="editEvent('${event.event_id}')" style="margin-right: 5px;">Edit</button>
              <button class="action-btn" onclick="viewRegistrations('${event.event_id}')" style="background: #3b82f6;">Registrations</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function showCreateEventModal() {
      currentEvent = null;
      document.getElementById('eventModalTitle').textContent = 'Create Event';
      document.getElementById('eventName').value = '';
      document.getElementById('eventDate').value = '';
      document.getElementById('eventLocation').value = '';
      document.getElementById('eventEntryFee').value = '';
      document.getElementById('eventDeadline').value = '';
      document.getElementById('eventDeleteBtn').style.display = 'none';
      document.getElementById('eventModal').style.display = 'flex';
    }

    async function editEvent(eventId) {
      try {
        const response = await fetch(`/api/getEvent/${eventId}`);
        const data = await response.json();

        if (!data.success) throw new Error(data.message || 'Failed to load event');

        const event = data.event;
        currentEvent = event;

        document.getElementById('eventModalTitle').textContent = 'Edit Event';
        document.getElementById('eventName').value = event.event_name;
        document.getElementById('eventDate').value = event.event_date.split('T')[0];
        document.getElementById('eventLocation').value = event.location || '';
        document.getElementById('eventEntryFee').value = event.entry_fee;
        document.getElementById('eventDeadline').value = event.registration_deadline.split('T')[0];
        document.getElementById('eventDeleteBtn').style.display = 'block';
        document.getElementById('eventModal').style.display = 'flex';
      } catch (err) {
        console.error('editEvent error:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    async function saveEvent() {
      const name = document.getElementById('eventName').value.trim();
      const date = document.getElementById('eventDate').value;
      const location = document.getElementById('eventLocation').value.trim();
      const fee = parseFloat(document.getElementById('eventEntryFee').value);
      const deadline = document.getElementById('eventDeadline').value;

      if (!name || !date || !location || !fee || !deadline) {
        showToast('Please fill in all fields', 'error');
        return;
      }

      try {
        const url = currentEvent ? `/api/updateEvent/${currentEvent.event_id}` : '/api/createEvent';
        const method = currentEvent ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            event_name: name,
            event_date: date,
            location,
            entry_fee: fee,
            registration_deadline: deadline
          })
        });

        const data = await response.json();
        if (!data.success) throw new Error(data.message || 'Failed to save event');

        showToast(currentEvent ? 'Event updated successfully' : 'Event created successfully', 'success');
        closeEventModal();
        loadEvents();
      } catch (err) {
        console.error('saveEvent error:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    async function deleteEvent() {
      if (!currentEvent) return;
      
      if (!confirm(`Are you sure you want to delete "${currentEvent.event_name}"? This cannot be undone.`)) {
        return;
      }

      try {
        const response = await fetch(`/api/deleteEvent/${currentEvent.event_id}`, {
          method: 'DELETE'
        });

        const data = await response.json();
        if (!data.success) throw new Error(data.message || 'Failed to delete event');

        showToast('Event deleted successfully', 'success');
        closeEventModal();
        loadEvents();
      } catch (err) {
        console.error('deleteEvent error:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    function closeEventModal() {
      document.getElementById('eventModal').style.display = 'none';
      currentEvent = null;
    }

    async function viewRegistrations(eventId) {
      try {
        const response = await fetch(`/api/getEventRegistrations/${eventId}`);
        const data = await response.json();

        if (!data.success) throw new Error(data.message || 'Failed to load registrations');

        const registrations = data.registrations || [];
        const event = data.event || {};

        let html = `<h3 style="margin-bottom: 20px;">${event.event_name} - Registrations (${registrations.length})</h3>`;
        
        if (registrations.length === 0) {
          html += '<p style="color: #999;">No registrations for this event yet</p>';
        } else {
          html += `
            <table>
              <thead>
                <tr>
                  <th>Driver Name</th>
                  <th>Email</th>
                  <th>Class</th>
                  <th>Amount Paid</th>
                  <th>Status</th>
                  <th>Entry Status</th>
                  <th>Registered</th>
                </tr>
              </thead>
              <tbody>
                ${registrations.map(reg => `
                  <tr>
                    <td>${reg.driver_first_name} ${reg.driver_last_name}</td>
                    <td>${reg.driver_email}</td>
                    <td>${reg.driver_class}</td>
                    <td>R${parseFloat(reg.amount_paid).toLocaleString('en-ZA')}</td>
                    <td>${reg.payment_status}</td>
                    <td>${reg.entry_status}</td>
                    <td>${new Date(reg.created_at).toLocaleDateString('en-ZA')}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }

        // Create a modal-like view
        const modal = document.createElement('div');
        modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px;';
        modal.innerHTML = `
          <div style="background: #2a2a2a; border-radius: 8px; max-width: 900px; width: 100%; max-height: 80vh; overflow-y: auto; padding: 20px; border: 1px solid #404040;">
            ${html}
            <button class="cancel-btn" onclick="this.parentElement.parentElement.remove()" style="margin-top: 20px;">Close</button>
          </div>
        `;
        document.body.appendChild(modal);
      } catch (err) {
        console.error('viewRegistrations error:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    // ============= END EVENT MANAGEMENT =============

    // ============= AUDIT TRAIL FUNCTIONS =============

    async function loadAuditTrail() {
      try {
        const driver = document.getElementById('auditSearchDriver').value.trim();
        const action = document.getElementById('auditActionFilter').value;

        const response = await fetch('/api/getAuditLog', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ driver, action, limit: 1000 })
        });

        const result = await response.json();
        if (!response.ok || !result.success) {
          throw new Error(result.error?.message || 'Failed to load audit trail');
        }

        displayAuditTrail(result.data.logs || []);
      } catch (err) {
        console.error('Error loading audit trail:', err);
        showToast(err.message, 'error');
        const table = document.getElementById('auditTable');
        if (table) {
          table.innerHTML = `<tr><td colspan="8" class="loading">Error: ${err.message}</td></tr>`;
        }
      }
    }

    function displayAuditTrail(logs) {
      const table = document.getElementById('auditTable');
      if (!table) return;

      if (!logs || logs.length === 0) {
        table.innerHTML = '<tr><td colspan="8" class="loading">No audit records found</td></tr>';
        return;
      }

      let html = '';
      logs.forEach(log => {
        const timestamp = log.created_at ? new Date(log.created_at).toLocaleString('en-ZA') : 'N/A';
        const action = log.action || 'N/A';
        const driverName = log.driver_first_name && log.driver_last_name 
          ? `${log.driver_first_name} ${log.driver_last_name}` 
          : 'System';
        const email = log.driver_email || '-';
        const field = log.field_name || '-';
        const oldValue = log.old_value || '-';
        const newValue = log.new_value || '-';
        const ip = log.ip_address || '-';

        html += `
          <tr>
            <td>${timestamp}</td>
            <td><span class="action-badge">${action}</span></td>
            <td>${driverName}</td>
            <td>${email}</td>
            <td>${field}</td>
            <td style="color: #ff9999;">${oldValue}</td>
            <td style="color: #99ff99;">${newValue}</td>
            <td style="font-size: 10px;">${ip}</td>
          </tr>
        `;
      });

      table.innerHTML = html;
    }

    async function exportAuditCSV() {
      try {
        const driver = document.getElementById('auditSearchDriver').value.trim();
        const action = document.getElementById('auditActionFilter').value;

        const response = await fetch('/api/exportAuditCSV', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ driver, action })
        });

        if (!response.ok) throw new Error('Export failed');

        const csvText = await response.text();
        const blob = new Blob([csvText], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `audit-trail-${new Date().toISOString().slice(0,10)}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('Audit trail exported successfully!', 'success');
      } catch (err) {
        console.error('Export error:', err);
        showToast(err.message, 'error');
      }
    }

    // ============= END AUDIT TRAIL FUNCTIONS =============

    
    const adminPasswordEl = document.getElementById('adminPassword');
    if (adminPasswordEl) {
      adminPasswordEl.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') adminLogin();
      });
    }
  </script>
</body>
</html>
