<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>NATS Driver Registry</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#000000">
  <meta name="description" content="ROK Cup South Africa - Driver Registration & Event Management">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ROK Cup SA">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="/rok-cup-favicon.png" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png">

  <style>
    :root{
      --summer:#facc15;
      --autumn:#f97316;
      --winter:#0ea5e9;
      --spring:#4ade80;

      --bg: #000000;
      --panel-bg:#0a0a0a;
      --ink:#ffffff;
      --muted:#9ca3af;

      --border-soft: rgba(255,255,255,0.08);
      --border-strong: rgba(255,255,255,0.15);

      --shadow: 0 18px 40px rgba(0,0,0,0.30), 0 0 0 1px rgba(255,255,255,0.05);
      --shadow-strong: 0 30px 90px rgba(0,0,0,0.50), 0 0 0 1px rgba(255,255,255,0.08);

      --radius:0px;
    }

    *{ box-sizing:border-box; margin:0; padding:0; }

    html{
      background: #000000;
      overscroll-behavior-y: none;
      overflow-x: hidden;
    }

    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
      background: #000000;
      color: var(--ink);
      -webkit-font-smoothing: antialiased;
      padding: 24px 18px;
      min-height: 100vh;
      touch-action: pan-y;
    }

    /* Mobile optimizations */
    @media (max-width: 768px){
      body{
        padding: 16px 12px;
      }

      .shell{
        padding: 16px 16px 14px;
      }

      .tabs{
        gap: 8px;
        margin-bottom: 12px;
      }

      .header{
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
      }

      .header-right{
        width: 100%;
        text-align: left;
      }
    }

    @media (max-width: 480px){
      body{
        padding: 12px 10px;
      }

      .shell{
        padding: 12px 12px 10px;
        box-shadow: 0 8px 16px rgba(15,23,42,0.12);
      }

      .title{
        font-size: 16px;
      }

      .sub{
        font-size: 14px;
      }
    }

    .wrap{ width:min(1180px, 100%); margin: 0 auto; position:relative; }

    /* ============= SEASONAL COLOR THEMING ============= */
    /* Body gets data-season attribute set by JavaScript */
    body[data-season="summer"] .tab.active,
    body[data-season="summer"] .tab.active::after {
      border-bottom-color: var(--summer) !important;
      color: var(--summer) !important;
    }
    body[data-season="summer"] .tab.active::after {
      background: var(--summer) !important;
    }
    body[data-season="summer"] .accentBar {
      background: var(--summer) !important;
    }
    body[data-season="summer"] .statusChip.wait {
      border-color: var(--summer) !important;
      color: var(--summer) !important;
      box-shadow: 0 0 24px rgba(250, 204, 21, 0.60) !important;
    }

    body[data-season="autumn"] .tab.active,
    body[data-season="autumn"] .tab.active::after {
      border-bottom-color: var(--autumn) !important;
      color: var(--autumn) !important;
    }
    body[data-season="autumn"] .tab.active::after {
      background: var(--autumn) !important;
    }
    body[data-season="autumn"] .accentBar {
      background: var(--autumn) !important;
    }
    body[data-season="autumn"] .statusChip.wait {
      border-color: var(--autumn) !important;
      color: var(--autumn) !important;
      box-shadow: 0 0 24px rgba(249, 115, 22, 0.60) !important;
    }

    body[data-season="winter"] .tab.active,
    body[data-season="winter"] .tab.active::after {
      border-bottom-color: var(--winter) !important;
      color: var(--winter) !important;
    }
    body[data-season="winter"] .tab.active::after {
      background: var(--winter) !important;
    }
    body[data-season="winter"] .accentBar {
      background: var(--winter) !important;
    }
    body[data-season="winter"] .statusChip.wait {
      border-color: var(--winter) !important;
      color: var(--winter) !important;
      box-shadow: 0 0 24px rgba(14, 165, 233, 0.60) !important;
    }

    body[data-season="spring"] .tab.active,
    body[data-season="spring"] .tab.active::after {
      border-bottom-color: var(--spring) !important;
      color: var(--spring) !important;
    }
    body[data-season="spring"] .tab.active::after {
      background: var(--spring) !important;
    }
    body[data-season="spring"] .accentBar {
      background: var(--spring) !important;
    }
    body[data-season="spring"] .statusChip.wait {
      border-color: var(--spring) !important;
      color: var(--spring) !important;
      box-shadow: 0 0 24px rgba(74, 222, 128, 0.60) !important;
    }

    .shell{
      position: relative;
      background: #0f0f0f;
      border-radius: var(--radius);
      box-shadow: var(--shadow-strong);
      border: 1px solid var(--border-strong);
      padding: 22px 22px 20px;
      overflow: hidden;
    }
    .shell::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        linear-gradient(135deg,
          rgba(255,255,255,0.18) 0%,
          rgba(0,0,0,0.04) 55%,
          rgba(255,255,255,0.12) 100%),
        repeating-linear-gradient(135deg,
          rgba(0,0,0,0.030) 0px,
          rgba(0,0,0,0.030) 1px,
          rgba(0,0,0,0.000) 1px,
          rgba(0,0,0,0.000) 7px);
      opacity: 0.35;
      mix-blend-mode: multiply;
    }

    .content{
      position: relative;
      z-index: 1;
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:18px;
      border-bottom: 1px solid var(--border-soft);
      padding-bottom: 12px;
    }

    .kicker{
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--muted);
    }
    .title{
      font-size: 18px;
      font-weight: 900;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      margin-top: 6px;
      color: var(--ink);
    }
    .sub{
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--ink);
      margin-top: 8px;
      max-width: 70ch;
      line-height: 1.6;
    }
    .header-right{
      text-align:right;
      font-size: 11px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--muted);
      line-height: 1.5;
    }
    /* Back link placement in header */
    .header-right .back-link-wrap { margin-top: 6px; }

    .tabs{
      display:flex;
      gap:0;
      flex-wrap: nowrap;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 24px;
    }

    /* Hide carousel on desktop */
    .tabs-carousel-container,
    .carousel-indicator {
      display: none !important;
    }

    .tab{
      border: none !important;
      background: transparent !important;
      border-radius: 0 !important;
      padding: 0 32px !important;
      height: 64px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      box-shadow: none !important;
      font-size: 15px !important;
      letter-spacing: 0.05em !important;
      text-transform: uppercase !important;
      cursor: pointer !important;
      color: #6b7280 !important;
      position: relative !important;
      overflow: visible !important;
      font-weight: 600 !important;
      transition: all 0.2s ease-out !important;
      border-bottom: 3px solid transparent !important;
    }

    .tab:hover{
      color: #9ca3af !important;
      background: transparent !important;
    }

    .tab.active{
      color: #ffffff !important;
      border-bottom-color: var(--winter);
      background: transparent !important;
    }

    .tab.active::after{
      content: '';
      position: absolute;
      bottom: -3px;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--winter);
      animation: tabSlideIn 0.3s ease-out;
    }

    @keyframes tabSlideIn {
      from {
        transform: scaleX(0);
      }
      to {
        transform: scaleX(1);
      }
    }

    .tab[data-tab="portal"].active::after,
    .tab[data-tab="portal"].active{
      border-bottom-color: var(--winter);
    }
    .tab[data-tab="portal"].active::after{
      background: var(--winter);
    }

    .tab[data-tab="register"].active::after,
    .tab[data-tab="register"].active{
      border-bottom-color: var(--spring);
    }
    .tab[data-tab="register"].active::after{
      background: var(--spring);
    }

    /* Mobile: Show tabs in responsive layout */
    @media (max-width: 480px){
      .shell .tabs{
        display: flex !important;
        gap: 0 !important;
        width: 100% !important;
        margin-bottom: 16px !important;
      }

      .shell .tab{
        flex: 1 !important;
        padding: 0 16px !important;
        height: 56px !important;
        font-size: 13px !important;
        min-width: 0 !important;
      }

      .tabs-carousel-container{
        display: none !important;
      }

      .tabs-carousel{
        width: 100%;
        height: 160px;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        scroll-behavior: smooth;
        display: flex;
        gap: 12px;
        padding: 0 12px;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
      }

      .tabs-carousel::-webkit-scrollbar{
        display: none;
      }

      .carousel-option{
        min-width: calc(100% - 24px);
        scroll-snap-align: center;
        scroll-snap-stop: always;
        display: flex;
        align-items: center;
        justify-content: center;
        perspective: 1000px;
        flex-shrink: 0;
      }

      .carousel-card{
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
        border: 2px solid var(--border-soft);
        border-radius: 16px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 12px;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative;
        overflow: hidden;
        box-shadow: 0 8px 24px rgba(15,23,42,0.12);
      }

      .carousel-card::before{
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at var(--x, 50%) var(--y, 50%), rgba(255,255,255,0.4) 0%, transparent 70%);
        opacity: 0;
        transition: opacity 0.4s ease;
      }

      .carousel-option:hover .carousel-card{
        border-color: var(--border-strong);
        box-shadow: 0 16px 32px rgba(15,23,42,0.15);
        transform: translateY(-4px) scale(1.02);
      }

      .carousel-option:hover .carousel-card::before{
        opacity: 1;
      }

      .carousel-icon{
        font-size: 48px;
        line-height: 1;
        animation: floatIcon 3s ease-in-out infinite;
      }

      .carousel-option[data-tab="portal"] .carousel-icon{
        animation-delay: 0s;
      }

      .carousel-option[data-tab="register"] .carousel-icon{
        animation-delay: 0.5s;
      }

      @keyframes floatIcon{
        0%, 100%{ transform: translateY(0px); }
        50%{ transform: translateY(-8px); }
      }

      .carousel-label{
        font-size: 13px;
        font-weight: 700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--ink);
        position: relative;
        z-index: 1;
      }

      .carousel-option.active .carousel-card{
        border-color: transparent;
        box-shadow: 0 20px 40px rgba(15,23,42,0.2);
        transform: translateY(-6px) scale(1.05);
      }

      .carousel-option[data-tab="portal"].active .carousel-card{
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        box-shadow: 0 20px 40px rgba(14, 165, 233, 0.35);
      }

      .carousel-option[data-tab="register"].active .carousel-card{
        background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
        box-shadow: 0 20px 40px rgba(34, 197, 94, 0.35);
      }

      .carousel-option.active .carousel-label{
        color: #fff;
      }

      .carousel-option.active .carousel-icon{
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
      }

      .carousel-indicator{
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .carousel-dot{
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: rgba(15,23,42,0.2);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .carousel-dot.active{
        background: var(--ink);
        width: 24px;
      }

      .carousel-dot[data-tab="portal"].active{
        background: #0ea5e9;
      }

      .carousel-dot[data-tab="register"].active{
        background: #4ade80;
      }
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    /* Ensure tabs are properly hidden */
    /* Tab visibility - hidden by default */
    #tab-portal {
      display: none !important;
      visibility: hidden !important;
    }
    
    #tab-register {
      display: none !important;
      visibility: hidden !important;
    }
    
    /* Show when active */
    #tab-portal.show {
      display: block !important;
      visibility: visible !important;
    }
    
    #tab-register.show {
      display: grid !important;
      grid-template-columns: 1fr 1fr !important;
      gap: 14px !important;
      visibility: visible !important;
    }

    .panel{
      background: var(--panel-bg);
      border: 1px solid var(--border-soft);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 14px 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      min-width: 0;
    }

    .panelTitle{
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      display:flex;
      align-items:center;
      gap: 10px;
      color: #ffffff;
    }

    .accentBar{ width: 4px; height: 14px; background: var(--summer); display:inline-block; }

    .hint{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.7;
    }

    label{
      font-size: 11px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #9ca3af;
      font-weight: 700;
      display:block;
      margin-bottom: 6px;
    }

    input, select, textarea{
      width:100%;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: var(--radius);
      padding: 10px 10px;
      font-size: 16px;
      background: #0a0a0a !important;
      color: #ffffff !important;
      outline: none;
      -webkit-text-fill-color: #ffffff !important;
    }
    /* Override browser autofill styles */
    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus,
    input:-webkit-autofill:active {
      -webkit-box-shadow: 0 0 0 30px #0a0a0a inset !important;
      -webkit-text-fill-color: #ffffff !important;
      caret-color: #ffffff !important;
      border: 1px solid rgba(255,255,255,0.12) !important;
    }
    select option{
      background: #1f2937;
      color: #ffffff;
      padding: 8px;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(255,255,255,0.25);
      background: #0a0a0a !important;
    }
    textarea{ min-height: 90px; resize: vertical; }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .btnbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .btn{
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: var(--radius);
      background: transparent;
      color: #ffffff;
      padding: 10px 14px 9px;
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      cursor:pointer;
      position: relative;
      overflow:hidden;
      font-weight: 600;
      transition: all 0.2s ease-out;
    }
    .btn:hover{
      border-color: rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.05);
    }
    .btn.primary{
      background: #ffffff;
      color: #000000;
      border-color: #ffffff;
    }
    .btn.primary:hover{
      background: rgba(255,255,255,0.9);
    }
    .btn:disabled{ opacity: .45; cursor: default; }

    /* Button loading state */
    .btn.loading{
      pointer-events:none;
      opacity: 0.92;
    }
    .btn.loading::after{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(90deg,
        rgba(255,255,255,0.00) 0%,
        rgba(255,255,255,0.10) 40%,
        rgba(255,255,255,0.00) 80%);
      transform: translateX(-110%);
      animation: btnSweep 0.95s linear infinite;
      mix-blend-mode: screen;
    }
    @keyframes btnSweep{
      to{ transform: translateX(110%); }
    }

    /* Inline spinner */
    .spinner{
      width: 16px; height: 16px;
      border: 2px solid rgba(15,23,42,0.18);
      border-top-color: rgba(15,23,42,0.72);
      border-radius: 999px;
      animation: spin 0.75s linear infinite;
      flex: 0 0 auto;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* Championship selector */
    .champ-selector{
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    .champ-selector-group{
      display: grid;
      grid-template-columns: 1fr;
      gap: 0;
    }
    .champ-option{
      padding: 16px 12px;
      border: 2px solid var(--border-soft);
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 600;
      font-size: 13px;
      background: rgba(255,255,255,0.05);
      color: #ffffff;
    }
    .champ-option:first-child{
      border-radius: var(--radius) var(--radius) 0 0;
    }
    .champ-option:last-child{
      border-radius: 0 0 var(--radius) var(--radius);
    }
    .champ-option:only-child{
      border-radius: var(--radius);
    }
    .champ-option:hover{
      border-color: var(--border-strong);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(15,23,42,0.12);
    }
    .champ-option.selected{
      color: #fff;
      border-color: var(--ink);
    }
    .champ-option.rok-nats.selected{
      background: #facc15;
      border-color: #facc15;
      color: #000;
    }
    .champ-option.rok-nc.selected{
      background: #0ea5e9;
      border-color: #0ea5e9;
    }
    .champ-option.rok-sc.selected{
      background: #06b6d4;
      border-color: #06b6d4;
    }
    .champ-option.all.selected{
      background: #22c55e;
      border-color: #22c55e;
    }

    /* ===== PREMIUM ANIMATIONS ===== */
    @media (prefers-reduced-motion: no-preference){

      /* Page load - fade in shell */
      .shell{
        animation: shellFadeIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) backwards;
      }

      /* Stagger panels */
      .panel{
        animation: panelSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) backwards;
      }
      .panel:nth-child(1){ animation-delay: 0.05s; }
      .panel:nth-child(2){ animation-delay: 0.1s; }
      .panel:nth-child(3){ animation-delay: 0.15s; }
      .panel:nth-child(4){ animation-delay: 0.2s; }
      .panel:nth-child(5){ animation-delay: 0.25s; }

      @keyframes shellFadeIn{
        from{
          opacity: 0;
          transform: translateY(12px);
        }
        to{
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes panelSlideIn{
        from{
          opacity: 0;
          transform: translateY(16px);
        }
        to{
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Input focus glow */
      input:focus, select:focus, textarea:focus{
        border-color: var(--ink);
        background: #fff;
        box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.08);
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      /* Button hover lift and glow */
      .btn{
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      .btn:not(:disabled):hover{
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.15);
        border-color: var(--ink);
      }
      .btn.primary:not(:disabled):hover{
        box-shadow: 0 12px 28px rgba(15, 23, 42, 0.25);
      }

      /* Championship option animations */
      .champ-option{
        transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative;
        overflow: hidden;
      }
      .champ-option::before{
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at var(--x, 50%) var(--y, 50%), rgba(255,255,255,0.4) 0%, transparent 70%);
        opacity: 0;
        transition: opacity 0.4s ease;
      }
      .champ-option:hover::before{
        opacity: 1;
      }
      .champ-option.selected{
        transform: scale(1.05);
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.2);
      }
      .champ-option.rok-nats.selected{
        box-shadow: 0 8px 24px rgba(250, 204, 21, 0.5);
      }
      .champ-option.rok-nc.selected{
        box-shadow: 0 8px 24px rgba(14, 165, 233, 0.4);
      }
      .champ-option.rok-sc.selected{
        box-shadow: 0 8px 24px rgba(6, 182, 212, 0.4);
      }
      .champ-option.all.selected{
        box-shadow: 0 8px 24px rgba(34, 197, 94, 0.4);
      }

      /* Toast slide in */
      .toast{
        animation: toastSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) backwards;
      }

      @keyframes toastSlideIn{
        from{
          opacity: 0;
          transform: translateX(-20px);
        }
        to{
          opacity: 1;
          transform: translateX(0);
        }
      }

      /* Modal fade and scale */
      #forgotPasswordModal{
        animation: modalFadeIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) backwards;
      }
      #forgotPasswordModal > div{
        animation: modalScaleIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) backwards;
      }

      @keyframes modalFadeIn{
        from{ opacity: 0; }
        to{ opacity: 1; }
      }

      @keyframes modalScaleIn{
        from{
          opacity: 0;
          transform: scale(0.92);
        }
        to{
          opacity: 1;
          transform: scale(1);
        }
      }

      @keyframes confirmScaleIn{
        from{
          opacity: 0;
          transform: scale(0.9);
        }
        to{
          opacity: 1;
          transform: scale(1);
        }
      }

      /* Status card animations */
      .statusCard{
        animation: statusCardSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) backwards;
      }

      @keyframes statusCardSlideIn{
        from{
          opacity: 0;
          transform: translateY(12px);
        }
        to{
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes tabBounce{
        0%, 100%{
          transform: translateY(0);
        }
        25%{
          transform: translateY(-8px);
        }
        50%{
          transform: translateY(0);
        }
        75%{
          transform: translateY(-4px);
        }
      }

      .ptab.bounce{
        animation: tabBounce 0.8s ease-in-out;
      }

      /* Spinner enhanced */
      .spinner{
        animation: spin 0.75s linear infinite;
        filter: drop-shadow(0 2px 4px rgba(15, 23, 42, 0.12));
      }

      /* Smooth hover for tabs */
      .ptab{
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      .ptab:not(.active):hover{
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.1);
      }
      .ptab.active{
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(15, 23, 42, 0.15);
      }

      /* Subtle glow on focus within forms */
      .panel:focus-within{
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08), 0 0 0 1px rgba(15,23,42,0.05);
        transition: box-shadow 0.3s ease;
      }

    } /* end prefers-reduced-motion */

    .toast{
      border: 1px solid var(--border-soft);
      background: rgba(0,0,0,0.5);
      padding: 10px 12px;
      font-size: 12px;
      line-height: 1.6;
      color: #ffffff;
    }
    .toast.good{ border-left: 4px solid var(--spring); }
    .toast.bad{ border-left: 4px solid #ef4444; }

    /* Toast positioning - inside panel container */
    #toast {
      position: static;
      max-width: 100%;
      pointer-events: auto;
      margin-bottom: 12px;
    }

    /* Centered error overlay */
    .error-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease;
    }

    .error-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .error-box {
      background: white;
      padding: 28px 36px;
      border: 3px solid #ef4444;
      max-width: 400px;
      width: 90%;
      text-align: center;
      animation: errorPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .error-box-icon {
      font-size: 36px;
      margin-bottom: 12px;
    }

    .error-box-title {
      font-size: 16px;
      font-weight: 800;
      color: #991b1b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    .error-box-message {
      font-size: 14px;
      color: #374151;
      line-height: 1.5;
    }

    @keyframes errorPop {
      from {
        transform: scale(0.8);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Portal tabs */
    .portalTabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      border: 1px solid var(--border-soft);
      background: #0a0a0a;
      padding: 10px;
      border-radius: var(--radius);
      box-shadow: 0 14px 30px rgba(0,0,0,0.5);
    }

    .ptab{
      border: 1px solid var(--border-soft);
      background: transparent;
      border-radius: var(--radius);
      padding: 10px 12px 9px;
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      cursor:pointer;
      color: #ffffff;
      position: relative;
      overflow:hidden;
      min-width: 160px;
      transition: transform .12s ease;
    }
    .ptab:active{ transform: translateY(1px); }

    .ptab .tabBar{
      position:absolute;
      left:0; right:0; top:0;
      height:3px;
      background: transparent;
      opacity: 0.95;
    }
    .ptab[data-accent="summer"] .tabBar{ background: var(--summer); }
    .ptab[data-accent="autumn"] .tabBar{ background: var(--autumn); }
    .ptab[data-accent="winter"] .tabBar{ background: var(--winter); }
    .ptab[data-accent="spring"] .tabBar{ background: var(--spring); }

    /* Action tabs (Logout, Home) - dark styling */
    .ptab-action {
      background: transparent !important;
      color: #ffffff !important;
      border-color: rgba(255,255,255,0.08) !important;
      min-width: 80px !important;
    }
    .ptab-action:hover {
      background: rgba(255,255,255,0.05) !important;
    }

    /* Glow accents on active portal tabs */
    .ptab.active{
      border-color: rgba(15,23,42,0.55);
      background: rgba(15,23,42,0.02);
      box-shadow:
        0 18px 40px rgba(15,23,42,0.10),
        0 0 0 1px rgba(15,23,42,0.05);
    }
    .ptab.active[data-accent="summer"]{ box-shadow: 0 18px 40px rgba(15,23,42,0.10), 0 0 0 1px rgba(15,23,42,0.05), 0 0 22px rgba(250,204,21,0.35); }
    .ptab.active[data-accent="autumn"]{ box-shadow: 0 18px 40px rgba(15,23,42,0.10), 0 0 0 1px rgba(15,23,42,0.05), 0 0 22px rgba(249,115,22,0.35); }
    .ptab.active[data-accent="winter"]{ box-shadow: 0 18px 40px rgba(15,23,42,0.10), 0 0 0 1px rgba(15,23,42,0.05), 0 0 22px rgba(14,165,233,0.35); }
    .ptab.active[data-accent="spring"]{ box-shadow: 0 18px 40px rgba(15,23,42,0.10), 0 0 0 1px rgba(15,23,42,0.05), 0 0 22px rgba(34,197,94,0.35); }

    /* Mobile Portal Sidebar Navigation */
    .portal-nav-toggle {
      display: none;
      position: fixed;
      top: 16px;
      left: 16px;
      z-index: 102;
      width: 48px;
      height: 48px;
      background: #0a0a0a;
      border: 1px solid #1f1f1f;
      border-radius: 0;
      cursor: pointer;
      padding: 0;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .portal-nav-toggle:hover {
      background: #111111;
      border-color: var(--spring);
    }

    .portal-nav-toggle-icon {
      width: 20px;
      height: 14px;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .portal-nav-toggle-icon span {
      width: 100%;
      height: 2px;
      background: #ffffff;
      transition: all 0.3s ease;
      display: block;
    }

    /* Seasonal colors for hamburger menu */
    body[data-season="summer"] .portal-nav-toggle-icon span {
      background: #facc15 !important;
    }
    body[data-season="autumn"] .portal-nav-toggle-icon span {
      background: #f97316 !important;
    }
    body[data-season="winter"] .portal-nav-toggle-icon span {
      background: #0ea5e9 !important;
    }
    body[data-season="spring"] .portal-nav-toggle-icon span {
      background: #4ade80 !important;
    }

    .portal-nav-toggle.active .portal-nav-toggle-icon span:nth-child(1) {
      transform: translateY(6px) rotate(45deg);
    }

    .portal-nav-toggle.active .portal-nav-toggle-icon span:nth-child(2) {
      opacity: 0;
    }

    .portal-nav-toggle.active .portal-nav-toggle-icon span:nth-child(3) {
      transform: translateY(-6px) rotate(-45deg);
    }

    .portal-nav-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
      z-index: 100;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .portal-nav-backdrop.active {
      opacity: 1;
    }

    .portal-sidebar {
      position: fixed;
      top: 0;
      left: -100%;
      width: 280px;
      height: 100vh;
      background: #0a0a0a;
      border-right: 1px solid #1f1f1f;
      box-shadow: 8px 0 24px rgba(0, 0, 0, 0.5);
      transition: left 0.3s ease;
      overflow-y: auto;
      padding: 80px 0 20px;
      z-index: 101;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .portal-sidebar.active {
      left: 0;
    }

    .portal-sidebar-item {
      padding: 12px 20px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      border: none;
      background: transparent;
      text-align: left;
      cursor: pointer;
      color: #9ca3af;
      border-left: 3px solid transparent;
      transition: all 0.2s ease-out;
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .portal-sidebar-item:hover {
      color: #ffffff;
      transform: translateX(4px);
      background: rgba(255, 255, 255, 0.03);
    }

    .portal-sidebar-item.active {
      color: #ffffff;
      background: #111111;
    }

    /* Color-coded left borders */
    .portal-sidebar-item[data-accent="summer"]:hover,
    .portal-sidebar-item[data-accent="summer"].active {
      border-left-color: #facc15;
    }

    .portal-sidebar-item[data-accent="autumn"]:hover,
    .portal-sidebar-item[data-accent="autumn"].active {
      border-left-color: #f97316;
    }

    .portal-sidebar-item[data-accent="winter"]:hover,
    .portal-sidebar-item[data-accent="winter"].active {
      border-left-color: #0ea5e9;
    }

    .portal-sidebar-item[data-accent="spring"]:hover,
    .portal-sidebar-item[data-accent="spring"].active {
      border-left-color: #4ade80;
    }

    /* Action items (Logout, Home) */
    .portal-sidebar-item.portal-sidebar-action {
      margin-top: 8px;
      padding-top: 16px;
      border-top: 1px solid #1f1f1f;
    }

    .portal-sidebar-item.portal-sidebar-action:hover {
      border-left-color: #ef4444;
    }

    /* Mobile Portal Menu - FAB + Expandable Accordion */
    @media (max-width: 768px){
      .portalTabs{
        display: none !important;
      }

      .portal-nav-toggle {
        display: flex;
      }

      #portalTabsCarousel{
        display: none !important;
      }
      
      /* Keep mobile carousel permanently hidden */
      body.logged-in #portalTabsCarousel {
        display: none !important;
      }

      .portalTab-current{
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        padding: 12px 14px;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 2px solid #e5e7eb;
        border-radius: 0;
        transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative;
        z-index: 20;
        gap: 12px;
        box-shadow: 0 2px 8px rgba(15,23,42,0.06);
        min-height: 52px;
      }

      .portalTab-current::before{
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: linear-gradient(180deg, #0ea5e9 0%, #0284c7 100%);
        transition: all 0.3s ease;
      }

      .portalTab-current-label{
        font-size: 15px;
        font-weight: 800;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        color: var(--ink);
        flex: 1;
        padding-left: 8px;
        line-height: 1.2;
      }

      .portalTab-fab{
        padding: 8px 16px;
        border-radius: 0;
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        flex-shrink: 0;
        position: relative;
        overflow: hidden;
        min-height: 36px;
      }

      .portalTab-fab::before{
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .portalTab-fab:hover::before{
        opacity: 1;
      }

      .portalTab-fab:hover{
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(14, 165, 233, 0.4);
      }

      .portalTab-fab:active{
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(14, 165, 233, 0.3);
      }

      .portalTab-fab-icon{
        font-size: 12px;
        color: #fff;
        font-weight: 800;
        line-height: 1;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        position: relative;
        z-index: 1;
      }

      /* Menu when expanded */
      .portalTab-menu{
        position: relative;
        display: flex;
        flex-direction: column;
        gap: 0;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.6s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.5s ease;
        z-index: 15;
        opacity: 0;
      }

      .portalTab-menu.expanded{
        max-height: 600px;
        opacity: 1;
      }

      .portalTab-menu-backdrop{
        position: absolute;
        inset: 0;
        background: rgba(15,23,42,0.02);
        border-radius: 12px;
        z-index: -1;
      }

      .portalTab-menu-grid{
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        padding: 12px;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border: 2px solid #e5e7eb;
        border-top: none;
        border-radius: 0;
        box-shadow: 0 4px 12px rgba(15,23,42,0.08);
      }

      .portalTab-option{
        padding: 14px 10px;
        background: #ffffff;
        border: 2px solid #e5e7eb;
        border-radius: 0;
        cursor: pointer;
        transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative;
        overflow: hidden;
        opacity: 0;
        transform: translateY(20px) scale(0.9);
        animation: slideInOption 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        box-shadow: 0 2px 4px rgba(15,23,42,0.04);
        min-height: 56px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .portalTab-option:nth-child(1){ animation-delay: 0.05s; }
      .portalTab-option:nth-child(2){ animation-delay: 0.1s; }
      .portalTab-option:nth-child(3){ animation-delay: 0.15s; }
      .portalTab-option:nth-child(4){ animation-delay: 0.2s; }
      .portalTab-option:nth-child(5){ animation-delay: 0.25s; }
      .portalTab-option:nth-child(6){ animation-delay: 0.3s; }
      .portalTab-option:nth-child(7){ animation-delay: 0.35s; }
      .portalTab-option:nth-child(8){ animation-delay: 0.4s; }
      .portalTab-option:nth-child(9){ animation-delay: 0.45s; }

      @keyframes slideInOption{
        0%{
          opacity: 0;
          transform: translateY(20px) scale(0.9);
        }
        70%{
          transform: translateY(-4px) scale(1.02);
        }
        to{
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .portalTab-option::before{
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(255,255,255,0.5) 0%, transparent 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .portalTab-option::after{
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 0;
        background: linear-gradient(90deg, #0ea5e9 0%, #0284c7 100%);
        transition: height 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .portalTab-option:hover{
        border-color: #cbd5e1;
        box-shadow: 0 8px 16px rgba(15,23,42,0.12);
        transform: translateY(-4px) scale(1.02);
      }

      .portalTab-option:hover::before{
        opacity: 1;
      }

      .portalTab-option:hover::after{
        height: 3px;
      }

      .portalTab-option:active{
        transform: translateY(-1px) scale(0.98);
      }

      .portalTab-option-label{
        font-size: 10px;
        font-weight: 800;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        color: var(--ink);
        position: relative;
        z-index: 1;
        display: block;
        word-wrap: break-word;
        overflow-wrap: break-word;
        line-height: 1.3;
        text-align: center;
      }

      /* Active option styling */
      .portalTab-option.active{
        border-color: transparent;
        box-shadow: 0 10px 24px rgba(15,23,42,0.18);
        transform: scale(1.02);
      }

      .portalTab-option.active::after{
        height: 4px;
      }

      .portalTab-option[data-ptab="driver"].active{
        background: linear-gradient(135deg, #fef08a 0%, #fde047 100%);
        box-shadow: 0 8px 20px rgba(253, 224, 71, 0.5), 0 0 0 2px rgba(250, 204, 21, 0.3);
      }

      .portalTab-option[data-ptab="contacts"].active{
        background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
        box-shadow: 0 8px 20px rgba(253, 186, 116, 0.5), 0 0 0 2px rgba(251, 146, 60, 0.3);
      }

      .portalTab-option[data-ptab="medical"].active{
        background: linear-gradient(135deg, #a5f3fc 0%, #67e8f9 100%);
        box-shadow: 0 8px 20px rgba(103, 232, 249, 0.5), 0 0 0 2px rgba(34, 211, 238, 0.3);
      }

      .portalTab-option[data-ptab="events"].active{
        background: linear-gradient(135deg, #86efac 0%, #4ade80 100%);
        box-shadow: 0 8px 20px rgba(74, 222, 128, 0.5), 0 0 0 2px rgba(34, 197, 94, 0.3);
      }

      .portalTab-option[data-ptab="points"].active{
        background: linear-gradient(135deg, #86efac 0%, #4ade80 100%);
        box-shadow: 0 8px 20px rgba(74, 222, 128, 0.5), 0 0 0 2px rgba(34, 197, 94, 0.3);
      }

      .portalTab-option[data-ptab="payments"].active{
        background: linear-gradient(135deg, #86efac 0%, #4ade80 100%);
        box-shadow: 0 8px 20px rgba(74, 222, 128, 0.5), 0 0 0 2px rgba(34, 197, 94, 0.3);
      }

      .portalTab-option[data-ptab="msa"].active{
        background: linear-gradient(135deg, #86efac 0%, #4ade80 100%);
        box-shadow: 0 8px 20px rgba(74, 222, 128, 0.5), 0 0 0 2px rgba(34, 197, 94, 0.3);
      }

      .portalTab-option[data-ptab="notifications"].active{
        background: linear-gradient(135deg, #a5f3fc 0%, #67e8f9 100%);
        box-shadow: 0 8px 20px rgba(103, 232, 249, 0.5), 0 0 0 2px rgba(34, 211, 238, 0.3);
      }

      .portalTab-option[data-ptab="requests"].active{
        background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
        box-shadow: 0 8px 20px rgba(253, 186, 116, 0.5), 0 0 0 2px rgba(251, 146, 60, 0.3);
      }

      .portalTab-option.active .portalTab-option-label{
        color: #1e293b;
        font-weight: 900;
        text-shadow: 0 1px 3px rgba(255,255,255,0.5);
      }

      /* Mobile responsive table fix */
      .table{
        font-size: 11px;
      }
      
      .table th, .table td{
        padding: 6px 4px;
        font-size: 10px;
      }

      .panel{
        padding: 10px 10px 8px;
      }

      .panelTitle{
        font-size: 11px;
      }
    }

    .portalSection{ display:none; }
    .portalSection.active{ display:block; }

    .table{
      width:100%;
      border-collapse: collapse;
      border: 1px solid var(--border-soft);
      max-width: 100%;
    }
    .table th, .table td{
      padding: 8px 8px;
      border-bottom: 1px solid var(--border-soft);
      font-size: 12px;
      white-space: nowrap;
    }

    /* Mobile table container with scroll */
    @media (max-width: 768px){
      .table-wrapper, #p_contactsTable, #p_pointsTable, #entriesTableContainer{
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        max-width: 100%;
      }
    }

    .table tbody tr{
      text-align:left;
      vertical-align: top;
    }
    .table th{
      font-size: 10px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 900;
      background: #0a0a0a;
    }

    /* Portal Status card */
    .statusCard{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding: 12px;
      border: 1px solid var(--border-soft);
      background: #000000;
    }
    .statusTop{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap: 10px;
      flex-wrap: wrap;
    }
    .statusTitle{
      font-size: 10px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 900;
    }
    .statusChip{
      font-size: 10px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      margin-left: auto;
      font-weight: 900;
      border: 1px solid var(--border-soft);
      padding: 8px 10px 7px;
      background: rgba(0,0,0,0.3);
      white-space: nowrap;
      display:flex;
      align-items:center;
      gap:8px;
      color: #ffffff;
    }
    .statusChip.ok{ 
      border-color: #22c55e; 
      box-shadow: 0 0 20px rgba(34,197,94,0.50), 0 0 40px rgba(34,197,94,0.30);
      color: #22c55e;
    }
    .statusChip.wait{ 
      border-color: #0ea5e9; 
      box-shadow: 0 0 24px rgba(14,165,233,0.60);
      color: #0ea5e9;
      animation: statusPulse 2s ease-in-out infinite;
    }
    .statusChip.bad{ 
      border-color: #ef4444; 
      box-shadow: 0 0 24px rgba(239,68,68,0.60);
      color: #ef4444;
      animation: statusPulse 2s ease-in-out infinite;
    }

    @keyframes statusPulse {
      0%, 100% {
        box-shadow: 0 0 24px rgba(14,165,233,0.40);
      }
      50% {
        box-shadow: 0 0 32px rgba(14,165,233,0.70), 0 0 48px rgba(14,165,233,0.40);
      }
    }

    .statusBody{
      display:flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .kv{
      border: none;
      background:transparent;
      padding: 0;
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .kv .k{
      font-size: 10px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #6b7280;
      font-weight: 700;
      margin-bottom: 0;
    }
    .kv .v{
      font-size: 12px;
      letter-spacing: 0;
      font-weight: 600;
      color: #ffffff;
      line-height: 1;
      word-break: break-word;
    }
    .kv .v span{
      display: inline-block !important;
      padding: 8px 16px !important;
      border-radius: 6px !important;
      font-weight: 700 !important;
      font-size: 13px !important;
      border: 2px solid !important;
      border-color: inherit !important;
    }
    .statusNote{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.7;
    }
    
    /* Notification History Styles */
    .notification-history-container {
      max-height: 500px;
      overflow-y: auto;
    }
    .notification-item {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 8px;
      padding: 14px;
      margin-bottom: 12px;
      transition: all 0.2s ease;
    }
    .notification-item:hover {
      border-color: #0ea5e9;
      box-shadow: 0 2px 8px rgba(14, 165, 233, 0.2);
      background: rgba(255,255,255,0.05);
    }
    .notification-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    .notification-item-title {
      font-weight: 600;
      color: #ffffff;
      font-size: 14px;
    }
    .notification-item-badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .notification-item-badge.event { background: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); }
    .notification-item-badge.registration { background: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); }
    .notification-item-badge.payment { background: rgba(251, 191, 36, 0.2); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.3); }
    .notification-item-badge.general { background: rgba(156, 163, 175, 0.2); color: #9ca3af; border: 1px solid rgba(156, 163, 175, 0.3); }
    .notification-item-body {
      font-size: 13px;
      color: #9ca3af;
      line-height: 1.5;
      margin-bottom: 8px;
    }
    .notification-item-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: #6b7280;
    }
    .notification-item-event {
      background: rgba(255,255,255,0.05);
      padding: 2px 8px;
      border-radius: 4px;
      color: #9ca3af;
    }
    .notification-group-header {
      font-size: 12px;
      font-weight: 700;
      color: #ffffff;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 10px 0;
      margin-top: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .notification-group-header:first-child {
      margin-top: 0;
    }
    .notification-empty {
      text-align: center;
      padding: 40px 20px;
      color: #9ca3af;
    }
    .notification-empty-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }
    
    /* Portal Status Buttons - HIDDEN, using inline buttons instead */
    .portal-status-buttons {
      display: none !important;
    }
    
    /* Inline status buttons in header - shown on both desktop and mobile when logged in */
    .status-inline-buttons {
      display: none;
      flex-direction: row;
      gap: 8px;
      align-items: center;
    }
    .status-inline-buttons .btn {
      padding: 6px 12px;
      font-size: 10px;
      background: var(--ink);
      color: #fff;
      border-color: var(--ink);
      font-weight: 600;
      white-space: nowrap;
    }
    .status-inline-buttons .btn:hover {
      background: #0f172a;
      border-color: #0f172a;
    }
    
    /* ROK logo - top right corner, always visible */
    .mobile-rok-logo {
      display: block;
      width: 60px;
      height: auto;
      object-fit: contain;
      opacity: 0.85;
    }

    /* Payment Cards */
    .paymentCard{
      background: #fff;
      border: 1px solid var(--border-soft);
      border-radius: 0;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      transition: all 0.2s ease;
    }
    .paymentCard:hover{
      border-color: #22c55e;
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.15);
    }
    .paymentCard-title{
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.04em;
      color: var(--ink);
    }
    .paymentCard-desc{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }
    .paymentCard-price{
      font-size: 20px;
      font-weight: 900;
      color: #22c55e;
      letter-spacing: 0.02em;
    }
    .paymentCard-btn{
      background: #22c55e;
      color: white;
      border: none;
      padding: 10px 16px;
      font-weight: 600;
      font-size: 13px;
      border-radius: 3px;
      cursor: pointer;
      transition: background 0.2s;
      text-align: center;
      text-decoration: none;
      display: block;
    }
    .paymentCard-btn:hover{
      background: #16a34a;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .row{ grid-template-columns: 1fr !important; }
      .header{ flex-direction:column; align-items:flex-start; }
      .header-right{ text-align:left; }
      .ptab{ min-width: 0; width: 100%; }
      
      /* Reduce sizes on mobile for better fit on larger phones */
      .shell{ padding: 12px !important; }
      .panel{ padding: 16px !important; }
      .panelTitle{ font-size: 14px !important; }
      label{ font-size: 12px !important; }
      input, select, textarea{ font-size: 14px !important; padding: 8px 10px !important; }
      .btn{ font-size: 13px !important; padding: 10px 14px !important; }
      .statusCard{ padding: 14px !important; }
      .statusTitle{ font-size: 13px !important; }
      .statusChip{ font-size: 11px !important; padding: 4px 10px !important; }
      .statusBody{ 
        flex-direction: column; 
        gap: 8px;
      }
      .kv{
        flex-direction: row;
        gap: 6px;
      }
      .kv .k{
        font-size: 9px;
        min-width: 60px;
      }
      .kv .v{
        font-size: 11px;
      }
      .kv .k{ font-size: 11px !important; }
      .kv .v{ font-size: 13px !important; }
      .statusNote{ font-size: 12px !important; }
      .hint{ font-size: 12px !important; }
      
      /* Hide championship buttons on mobile, show dropdown */
      #champ-buttons-container{ display: none !important; }
      #champ-select{ 
        display: block !important; 
        border: 1px solid var(--winter) !important;
        background: rgba(255,255,255,0.05) !important;
        color: #ffffff !important;
      }
      
      /* Hide desktop back-link-wrap on mobile */
      .back-link-wrap{ 
        display: none !important;
      }
      
      /* Smaller inline buttons on mobile */
      .status-inline-buttons .btn {
        padding: 6px 10px !important;
        font-size: 9px !important;
      }
      
      /* Single column registration form on mobile */
      #tab-register.show{ grid-template-columns: 1fr !important; }
      
      /* Green glow on panels when logged in */
      body.logged-in .panel {
        box-shadow: 0 0 20px rgba(34, 197, 94, 0.35), var(--shadow) !important;
        border-color: rgba(34, 197, 94, 0.4) !important;
      }
    }

    /* Mobile logged-in enhancements */
    @media (max-width: 980px) {
      /* Hide login/register tabs when logged in */
      body.logged-in .tabs {
        display: none !important;
      }
      
      /* Hide mode gate when logged in */
      body.logged-in #modeGate {
        display: none !important;
      }
      
      /* Make tab-portal a flex container for reordering */
      body.logged-in #tab-portal {
        display: flex !important;
        flex-direction: column !important;
      }
      
      /* Hide login panel completely when logged in */
      body.logged-in #loginPanel {
        display: none !important;
      }
      
      /* Hide the grid wrapper containing login/status - we'll show status separately */
      body.logged-in #tab-portal > .grid {
        display: contents !important;
      }
      
      /* Portal tabs carousel (Options button) - HIDDEN */
      body.logged-in #portalTabsCarousel {
        display: none !important;
      }
      
      /* Portal sections (content) second */
      body.logged-in #portalSections {
        order: 2 !important;
        margin-top: 14px !important;
      }
      
      /* Portal status at the very bottom */
      body.logged-in #portalStatusPanel {
        order: 99 !important;
        margin-top: 16px !important;
      }
      
      /* Green glow on statusCard when logged in */
      body.logged-in .statusCard {
        box-shadow: 0 0 25px rgba(34, 197, 94, 0.5) !important;
        border-color: rgba(34, 197, 94, 0.5) !important;
      }
      
      /* Green glow on portal tabs when logged in */
      body.logged-in .portalTabs,
      body.logged-in .portalTabs-carousel-container {
        box-shadow: 0 0 15px rgba(34, 197, 94, 0.3) !important;
      }
      
      /* Green glow on active tab content */
      body.logged-in #portalSections .panel {
        box-shadow: 0 0 18px rgba(34, 197, 94, 0.3), var(--shadow) !important;
        border-color: rgba(34, 197, 94, 0.35) !important;
      }
      
      /* Style portal status buttons - match primary button style */
      .portal-status-buttons {
        display: flex;
        gap: 10px;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #e5e7eb;
      }
      
      .portal-status-buttons .btn {
        flex: 1;
        background: var(--ink) !important;
        color: #fff !important;
        border-color: var(--ink) !important;
        font-weight: 600;
      }
      
      /* Mobile ROK logo in top right */
      .mobile-rok-logo {
        display: block;
        width: 45px;
        height: auto;
        object-fit: contain;
        opacity: 0.9;
      }
    }

    @media (max-width: 768px){
      .row{ grid-template-columns: 1fr !important; }
      #tab-register .row{ grid-template-columns: 1fr !important; }
      #tab-register.show{ grid-template-columns: 1fr !important; }
    }
    
    /* Skeleton Loading Animations */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 0%, #e0e0e0 50%, #f0f0f0 100%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s ease-in-out infinite;
      border-radius: 4px;
    }
    
    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    .skeleton-text {
      height: 14px;
      margin-bottom: 10px;
    }
    
    .skeleton-text-large {
      height: 20px;
      margin-bottom: 12px;
    }
    
    .skeleton-card {
      height: 120px;
      margin-bottom: 16px;
      border-radius: 8px;
    }
    
    .skeleton-table-row {
      height: 48px;
      margin-bottom: 8px;
      border-radius: 4px;
    }
    
    .skeleton-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
    }
    
    .skeleton-button {
      height: 40px;
      width: 120px;
      border-radius: 6px;
    }
    
    /* Skeleton container */
    .skeleton-container {
      padding: 20px;
      background: white;
      border-radius: 8px;
    }
    
    /* Responsive Tables - Card layout on mobile */
    @media (max-width: 768px) {
      /* Events table responsive */
      .table {
        display: block;
        width: 100%;
        overflow-x: visible !important;
      }
      
      .table thead {
        display: none;
      }
      
      .table tbody {
        display: block;
      }
      
      .table tr {
        display: block;
        margin-bottom: 16px;
        padding: 16px;
        background: #0a0a0a !important;
        border: 2px solid #1f1f1f !important;
        border-radius: 12px !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
      }
      
      .table td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0 !important;
        border: none !important;
        text-align: right !important;
      }
      
      .table td::before {
        content: attr(data-label);
        font-weight: 700;
        font-size: 11px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        text-align: left;
      }
      
      .table td:first-child {
        padding-top: 0 !important;
      }
      
      .table td:last-child {
        padding-bottom: 0 !important;
        border-bottom: none !important;
      }
      
      /* Notification cards - already mobile friendly, just adjust */
      .notification-history-container > div {
        margin-left: 0 !important;
        margin-right: 0 !important;
      }
      
      /* Make pull-to-refresh more prominent on mobile */
      #pullIndicator {
        width: 50px !important;
        height: 50px !important;
        font-size: 24px !important;
      }
    }
    
    /* Extra small screens - further optimize */
    @media (max-width: 480px) {
      .table tr {
        padding: 12px;
        margin-bottom: 12px;
      }
      
      .table td {
        padding: 8px 0 !important;
        font-size: 13px;
      }
      
      .table td::before {
        font-size: 10px;
      }

      /* Prevent horizontal overflow on small screens */
      * {
        max-width: 100%;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      div, section, article {
        max-width: 100vw;
      }
    }
  </style>
</head>

<body>
  <!-- Mobile Portal Navigation -->
  <button class="portal-nav-toggle" type="button" aria-label="Toggle navigation menu">
    <div class="portal-nav-toggle-icon">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </button>
  
  <div class="portal-nav-backdrop"></div>
  
  <nav class="portal-sidebar" aria-label="Driver portal navigation">
    <button class="portal-sidebar-item" data-ptab="driver" data-accent="summer" type="button">Driver Profile</button>
    <button class="portal-sidebar-item" data-ptab="contacts" data-accent="autumn" type="button">Entrant Details</button>
    <button class="portal-sidebar-item" data-ptab="medical" data-accent="winter" type="button">Medical & Consent</button>
    <button class="portal-sidebar-item" data-ptab="events" data-accent="spring" type="button">My Events</button>
    <button class="portal-sidebar-item" data-ptab="points" data-accent="spring" type="button">Points</button>
    <button class="portal-sidebar-item active" data-ptab="payments" data-accent="spring" type="button">Entries & Rentals</button>
    <button class="portal-sidebar-item" data-ptab="msa" data-accent="spring" type="button">MSA License</button>
    <button class="portal-sidebar-item" data-ptab="notifications" data-accent="winter" type="button">Notifications</button>
    <button class="portal-sidebar-item" data-ptab="requests" data-accent="autumn" type="button">Contact Admin</button>
    <button class="portal-sidebar-item portal-sidebar-action" onclick="document.getElementById('btnLogout').click()" type="button">Logout</button>
    <button class="portal-sidebar-item portal-sidebar-action" onclick="window.location.href='index.html'" type="button">Home</button>
  </nav>

  <div class="wrap">
    <div class="shell">
      <div class="content">

        <div class="header">
          <div>
            <div class="title">ROK CUP SOUTH AFRICA</div>
            <div class="sub">Driver Portal and Registration</div>
          </div>
          <div class="header-right">
            <img src="icons/rok-logo-original.png" alt="ROK" class="mobile-rok-logo" />
            <div class="back-link-wrap">
              <button class="btn" id="headerLogoutBtn" onclick="document.getElementById('btnLogout').click()" type="button" style="display:none;">Logout</button>
              <button class="btn" onclick="window.location.href='index.html'" type="button">Home</button>
            </div>
          </div>
        </div>

        <div class="tabs">
          <button class="tab" data-tab="portal" type="button">Login</button>
          <button class="tab" data-tab="register" type="button">New Registration</button>
        </div>

        <div id="modeGate" class="panel" style="display:flex; flex-direction:column; gap:10px;">
          <div class="panelTitle"><span class="accentBar" style="background:var(--winter)"></span>Select an option to continue</div>
          <div class="hint">
            Choose <b>Login</b> to access your driver account. Choose <b>New Registration</b> to create a new driver record.
          </div>
        </div>

        <div id="bodyArea" style="display:none;">

          <!-- Confirmation Modal -->
          <div id="confirmationModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 9999; align-items: center; justify-content: center;">
            <div style="background: white; padding: 32px; border-radius: 8px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); max-width: 400px; text-align: center; animation: confirmScaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); pointer-events: auto;" onclick="event.stopPropagation();">
              <div id="confirmIcon" style="font-size: 48px; margin-bottom: 16px;"></div>
              <h2 id="confirmTitle" style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #111827;">Profile Saved</h2>
              <p id="confirmMessage" style="font-size: 14px; color: #6b7280; margin-bottom: 24px; line-height: 1.5;">Your profile has been saved successfully!</p>
              <button id="confirmButton" style="background: #22c55e; color: white; border: none; padding: 10px 24px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 14px; transition: background 0.2s;" onmouseover="this.style.background='#16a34a'" onmouseout="this.style.background='#22c55e'">OK</button>
            </div>
          </div>

          <!-- LOGIN / PORTAL -->
          <div id="tab-portal">
            <div class="grid">
              <div class="panel" id="loginPanel">
                <div class="panelTitle"><span class="accentBar" style="background:var(--winter)"></span>Driver Login</div>

                <div class="row">
                  <div>
                    <label>Email Address</label>
                    <input id="login_identifier" placeholder="your.email@example.com" autocomplete="email" />
                  </div>
                  <div>
                    <label>Password</label>
                    <input id="login_password" placeholder="Your password" type="password" autocomplete="current-password" />
                  </div>
                </div>

                <div class="btnbar">
                  <button class="btn primary" id="btnLogin" type="button">Login</button>
                  <button class="btn" id="btnLogout" type="button" disabled>Logout</button>
                  <button class="btn" id="forgotPasswordLink" type="button">Forgot Password</button>
                </div>

                <div class="hint">Enter your email and password to access your driver portal.</div>
              </div>

              <div class="panel" id="portalStatusPanel" style="padding: 16px; background: #000000;">
                <div class="panelTitle" style="margin-bottom: 12px;"><span class="accentBar" style="background:var(--spring)"></span>Session</div>
                <div id="portalStatus">
                  <div id="toast"></div>
                  <div class="statusCard" style="display: flex; align-items: center; gap: 16px; padding: 0; border: none; background: transparent;">
                    <div class="statusChip wait" style="flex-shrink: 0;">Not logged in</div>
                    <div class="statusBody" style="display: flex; gap: 20px; flex: 1; grid-template-columns: none; font-size: 12px;">
                      <div class="kv" style="display: flex; gap: 6px; align-items: center;">
                        <div class="k" style="color: #6b7280; font-size: 10px;">NAME:</div>
                        <div class="v" style="color: #ffffff; font-weight: 600;"></div>
                      </div>
                      <div class="kv" style="display: flex; gap: 6px; align-items: center;">
                        <div class="k" style="color: #6b7280; font-size: 10px;">CLASS:</div>
                        <div class="v" style="color: #ffffff; font-weight: 600;"></div>
                      </div>
                      <div class="kv" style="display: flex; gap: 6px; align-items: center;">
                        <div class="k" style="color: #6b7280; font-size: 10px;">ID:</div>
                        <div class="v" style="color: #ffffff; font-weight: 600; font-size: 11px;"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Portal tabs -->
            <div id="portalTabs" class="portalTabs" style="display:none; margin-top:14px;">
              <button class="ptab" data-ptab="driver" data-accent="summer" type="button"><span class="tabBar"></span>Driver</button>
              <button class="ptab" data-ptab="contacts" data-accent="autumn" type="button"><span class="tabBar"></span>Entrant Details</button>
              <button class="ptab" data-ptab="medical" data-accent="winter" type="button"><span class="tabBar"></span>Medical & Consent</button>
              <button class="ptab" data-ptab="events" data-accent="spring" type="button"><span class="tabBar"></span>My Events</button>
              <button class="ptab" data-ptab="points" data-accent="spring" type="button"><span class="tabBar"></span>Points</button>
              <button class="ptab active" data-ptab="payments" data-accent="spring" type="button"><span class="tabBar"></span>Entries & Rentals</button>
              <button class="ptab" data-ptab="msa" data-accent="spring" type="button"><span class="tabBar"></span>MSA License</button>
              <button class="ptab" data-ptab="notifications" data-accent="winter" type="button"><span class="tabBar"></span>Notifications</button>
              <button class="ptab" data-ptab="requests" data-accent="autumn" type="button"><span class="tabBar"></span>Contact Admin</button>
              <!-- Logout and Home at end of portal tabs -->
              <button class="ptab ptab-action" onclick="document.getElementById('btnLogout').click()" type="button"><span class="tabBar" style="background:#ef4444"></span>Logout</button>
              <button class="ptab ptab-action" onclick="window.location.href='index.html'" type="button"><span class="tabBar" style="background:#3b82f6"></span>Home</button>
            </div>

            <!-- Portal tabs - Mobile 3D carousel -->
            <div id="portalTabsCarousel" class="portalTabs-carousel-container" style="display:none;">
              <!-- Current tab display -->
              <div class="portalTab-current">
                <span class="portalTab-current-label">Entries & Rentals</span>
                <button class="portalTab-fab" aria-label="Options">
                  <span class="portalTab-fab-icon">Options</span>
                </button>
              </div>

              <!-- Expandable menu -->
              <div class="portalTab-menu">
                <div class="portalTab-menu-backdrop"></div>
                <div class="portalTab-menu-grid">
                  <button class="portalTab-option" data-ptab="driver">
                    <span class="portalTab-option-label">Driver Profile</span>
                  </button>
                  <button class="portalTab-option" data-ptab="contacts">
                    <span class="portalTab-option-label">Entrant Details</span>
                  </button>
                  <button class="portalTab-option" data-ptab="medical">
                    <span class="portalTab-option-label">Medical & Consent</span>
                  </button>
                  <button class="portalTab-option" data-ptab="events">
                    <span class="portalTab-option-label">My Events</span>
                  </button>
                  <button class="portalTab-option" data-ptab="points">
                    <span class="portalTab-option-label">Points</span>
                  </button>
                  <button class="portalTab-option active" data-ptab="payments">
                    <span class="portalTab-option-label">Entries & Rentals</span>
                  </button>
                  <button class="portalTab-option" data-ptab="msa">
                    <span class="portalTab-option-label">MSA License</span>
                  </button>
                  <button class="portalTab-option" data-ptab="notifications">
                    <span class="portalTab-option-label">Notifications</span>
                  </button>
                  <button class="portalTab-option" data-ptab="requests">
                    <span class="portalTab-option-label">Contact Admin</span>
                  </button>
                </div>
              </div>
            </div>

            <!-- Portal sections -->
            <div id="portalSections" style="display:none; margin-top:14px;">

              <div class="portalSection" data-psection="driver">
                <div class="panel">
                  <div class="panelTitle"><span class="accentBar" style="background:var(--summer)"></span>Driver Profile</div>
                  <div class="hint">View your registered driver information. Contact admin for updates to identity or competition details.</div>

                  <div class="row">
                    <div>
                      <label>Email Address</label>
                      <input id="p_email" readonly />
                    </div>
                  </div>

                  <div class="row">
                    <div>
                      <label>First name</label>
                      <input id="p_first_name" />
                    </div>
                    <div>
                      <label>Last name</label>
                      <input id="p_last_name" />
                    </div>
                  </div>

                  <div class="row">
                    <div>
                      <label>Class</label>
                      <select id="p_class">
                        <option value="">Select a class...</option>
                        <option value="CADET">CADET</option>
                        <option value="MINI ROK U/10">MINI ROK U/10</option>
                        <option value="MINI ROK">MINI ROK</option>
                        <option value="OK-J">OK-J</option>
                        <option value="OK-N">OK-N</option>
                        <option value="KZ2">KZ2</option>
                      </select>
                    </div>
                    <div>
                      <label>Race number</label>
                      <input id="p_race_number" />
                    </div>
                  </div>

                  <div class="row">
                    <div>
                      <label>License number</label>
                      <input id="p_license_number" />
                    </div>
                    <div>
                      <label>Transponder number</label>
                      <input id="p_transponder_number" />
                    </div>
                  </div>

                  <div class="row">
                    <div>
                      <label>Kart brand</label>
                      <input id="p_kart_brand" />
                    </div>
                  </div>

                  <div class="row">
                    <div>
                      <label>Team name</label>
                      <input id="p_team_name" />
                    </div>
                    <div>
                      <label>Coach name</label>
                      <input id="p_coach_name" />
                    </div>
                  </div>

                  <div class="btnbar">
                    <button class="btn primary" id="btnSaveProfile" type="button" disabled>Save Changes</button>
                  </div>
                  
                  <!-- Push Notifications Toggle -->
                  <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                      <div>
                        <div style="font-weight: 600; color: #111827; margin-bottom: 4px;"> Push Notifications</div>
                        <div id="notificationStatus" style="font-size: 13px; color: #6b7280;">Checking status...</div>
                      </div>
                      <button id="notificationToggleBtn" class="btn" style="min-width: 100px;" onclick="togglePushNotifications()">Enable</button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="portalSection" data-psection="contacts">
                <div class="panel">
                  <div class="panelTitle"><span class="accentBar" style="background:var(--autumn)"></span>Entrant Details</div>
                  <div id="p_contactsTable" class="hint">No data loaded.</div>
                </div>
              </div>

              <div class="portalSection" data-psection="medical">
                <div class="panel">
                  <div class="panelTitle"><span class="accentBar" style="background:var(--winter)"></span>Medical & Consent</div>
                  <div id="p_medicalBlock" class="hint">No data loaded.</div>
                </div>
              </div>

              <div class="portalSection" data-psection="events">
                <div class="panel">
                  <div class="panelTitle"><span class="accentBar" style="background:var(--spring)"></span>My Events</div>
                  <div class="hint">View all events you've registered for and their status</div>
                  <div id="p_eventsBlock" style="margin-top: 20px;">
                    <div style="color: var(--muted); text-align: center; padding: 40px 20px;">Loading your events...</div>
                  </div>
                </div>
              </div>

              <div class="portalSection" data-psection="points">
                <div class="panel">
                  <div class="panelTitle"><span class="accentBar" style="background:var(--spring)"></span>Points</div>
                  <div id="p_pointsTable" class="hint">No points loaded.</div>
                </div>
              </div>

              <div class="portalSection" data-psection="race">
                <div class="panel">
                  <div class="panelTitle"><span class="accentBar" style="background:var(--winter)"></span>View Entries</div>
                  <div class="hint">Select an event to view all driver entries for that race.</div>

                  <div class="row">
                    <div>
                      <label>Select Event</label>
                      <select id="entriesEventSelect">
                        <option value="">Loading events...</option>
                      </select>
                    </div>
                  </div>

                  <div id="entriesTableContainer" style="margin-top: 20px;"></div>
                </div>
              </div>

              <div class="portalSection" data-psection="notifications">
                <div class="panel">
                  <div class="panelTitle"><span class="accentBar" style="background:var(--winter)"></span>Notification History</div>
                  <div class="hint">View your past notifications from ROK Cup SA. Notifications are grouped by type and event.</div>
                  
                  <!-- Filter options -->
                  <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <select id="notifFilterType" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #d1d5db; font-size: 13px;">
                      <option value="">All Types</option>
                      <option value="event">Event Updates</option>
                      <option value="registration">Registration</option>
                      <option value="payment">Payment</option>
                      <option value="general">General</option>
                    </select>
                    <select id="notifFilterEvent" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #d1d5db; font-size: 13px;">
                      <option value="">All Events</option>
                    </select>
                    <button class="btn" onclick="loadNotificationHistory()" style="padding: 8px 16px; font-size: 13px;">Refresh</button>
                  </div>
                  
                  <div id="notificationHistoryList" class="notification-history-container">
                    <div class="hint" style="text-align: center; padding: 30px;">
                      <div style="font-size: 40px; margin-bottom: 10px;"></div>
                      <div>Loading your notifications...</div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="portalSection" data-psection="requests">
                <div class="panel">
                  <div class="panelTitle"><span class="accentBar" style="background:var(--autumn)"></span>Contact Admin</div>
                  <div class="hint">Submit a request or message to our admin team. We'll review and respond promptly.</div>

                  <div class="row">
                    <div>
                      <label>Your name</label>
                      <input id="reqName" />
                    </div>
                    <div>
                      <label>Your email</label>
                      <input id="reqEmail" />
                    </div>
                  </div>
                  <div class="row">
                    <div>
                      <label>Your phone</label>
                      <input id="reqPhone" />
                    </div>
                    <div>
                      <label>Subject</label>
                      <input id="reqSubject" placeholder="e.g. Update race number" />
                    </div>
                  </div>

                  <label>Message</label>
                  <textarea id="reqMessage" placeholder="Write your request clearly."></textarea>

                  <div class="btnbar">
                    <button class="btn primary" id="btnSendRequest" type="button" disabled>Send to Admin</button>
                  </div>
                </div>
              </div>

              <div class="portalSection active" data-psection="payments">
                <!-- ENTER A RACE BUTTON - BLACK GLOWING CONTAINER -->
                <div class="panel">
                  <div id="enterRaceBox" style="padding: 20px; background: #000000; border-radius: 8px; border: 2px solid rgba(255,255,255,0.15); box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);">
                    <button id="btnQuickEntry" type="button" style="width: 100%; padding: 16px 24px; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; border: none; background: #3b82f6; color: white; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); position: relative; overflow: hidden; animation: slideInDown 0.5s ease-out;">
                      ENTER A RACE
                    </button>
                    <style>
                      @keyframes slideInDown {
                        from {
                          opacity: 0;
                          transform: translateY(-20px);
                        }
                        to {
                          opacity: 1;
                          transform: translateY(0);
                        }
                      }
                      #btnQuickEntry {
                        cursor: pointer;
                      }
                      #btnQuickEntry:hover {
                        background: #2563eb !important;
                        box-shadow: 0 0 25px rgba(59, 130, 246, 0.8) !important;
                        transform: translateY(-2px);
                      }
                      #btnQuickEntry:active {
                        transform: translateY(0);
                      }
                    </style>
                  </div>
                </div>

                <!-- NEXT RACE DETAILS SECTION -->
                <div class="panel">
                  <div class="panelTitle"><span class="accentBar" id="nextRaceAccentBar" style="background:#ef4444"></span>Next Race</div>
                  <div id="nextRaceBox" style="padding: 20px; background: #000000; border-radius: 8px; border: 2px solid #ef4444; box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);">
                    <div style="margin-bottom: 16px;">
                      <div style="font-size: 12px; color: #9ca3af; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px;">Upcoming Event</div>
                      <div style="font-size: 20px; font-weight: 700; color: #ffffff; text-transform: uppercase;" id="nextRaceTitle">14 FEBRUARY 2026 - REDSTAR RACEWAY (NORTHERN REGIONS CROWN)</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                      <div>
                        <div style="font-size: 12px; color: #9ca3af; margin-bottom: 4px; font-weight: 600;">Location</div>
                        <div style="font-size: 14px; color: #ffffff;" id="nextRaceLocation">Redstar Raceway</div>
                      </div>
                      <div>
                        <div style="font-size: 12px; color: #9ca3af; margin-bottom: 4px; font-weight: 600;">Entry Status</div>
                        <div id="nextRaceStatusBox" style="display: flex; align-items: center; gap: 8px;">
                          <div id="nextRaceStatusDot" style="width: 10px; height: 10px; background: #ef4444; border-radius: 50%; box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);"></div>
                          <span id="nextRaceStatusText" style="font-size: 14px; color: #ffffff; font-weight: 600;">Not Registered</span>
                        </div>
                      </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                      <div style="padding: 12px; border: 1px solid rgba(252, 165, 165, 0.3); border-radius: 6px; background: rgba(255,255,255,0.03);">
                        <div style="font-size: 11px; color: #9ca3af; font-weight: 600; margin-bottom: 4px;">ENTRY</div>
                        <div style="font-size: 12px; color: #ffffff; font-weight: 600;" id="nextRaceEntryStatus">Not Registered</div>
                      </div>
                      <div style="padding: 12px; border: 1px solid rgba(252, 165, 165, 0.3); border-radius: 6px; background: rgba(255,255,255,0.03);">
                        <div style="font-size: 11px; color: #9ca3af; font-weight: 600; margin-bottom: 4px;">ENGINE RENTAL</div>
                        <div style="font-size: 12px; color: #ffffff; font-weight: 600;" id="nextRaceEngineStatus">No</div>
                      </div>
                    </div>
                    <div id="nextRaceEntryDate" style="font-size: 11px; color: #9ca3af; margin-bottom: 12px;"></div>
                  </div>
                </div>

                <!-- PAYMENT STATUS SUMMARY -->
                <div class="panel" style="margin-top: 16px;">
                  <div class="panelTitle"><span class="accentBar" style="background:#3b82f6"></span>Payment & Entry Status</div>
                  
                  <div style="padding: 16px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.08); border-radius: 6px; background: rgba(255,255,255,0.03);">
                    <div style="font-size: 12px; color: #ffffff; margin-bottom: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Season Engine Rental (Pool)</div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <div style="font-size: 14px; color: #9ca3af;">Status:</div>
                      <div id="p_season_engine_rental_status" style="padding: 8px 16px; border-radius: 6px; font-weight: 600; color: white; background: #ef4444; display: inline-block;">
                        Not Registered
                      </div>
                    </div>
                  </div>

                  <div style="padding: 16px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.08); border-radius: 6px; background: rgba(255,255,255,0.03);">
                    <div style="font-size: 12px; color: #ffffff; margin-bottom: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Season Entry</div>
                    <div style="font-size: 12px; color: #9ca3af; margin-bottom: 8px;">(All entries, engine rental, tyres, fuel for all 8 rounds)</div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <div style="font-size: 14px; color: #9ca3af;">Status:</div>
                      <div id="p_season_entry_status" style="padding: 8px 16px; border-radius: 6px; font-weight: 600; color: white; background: #ef4444; display: inline-block;">
                        Not Registered
                      </div>
                    </div>
                  </div>

                  <div style="padding: 16px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.08); border-radius: 6px; background: rgba(255,255,255,0.03);">
                    <div style="font-size: 12px; color: #ffffff; margin-bottom: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;" id="nextRaceLabel">Next Race Entry</div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <div style="font-size: 14px; color: #9ca3af;">Status:</div>
                      <div id="p_next_race_entry_status" style="padding: 8px 16px; border-radius: 6px; font-weight: 600; color: white; background: #ef4444; display: inline-block;">
                        Not Registered
                      </div>
                    </div>
                  </div>

                  <div style="padding: 16px; border: 1px solid rgba(255,255,255,0.08); border-radius: 6px; background: rgba(255,255,255,0.03);">
                    <div style="font-size: 12px; color: #ffffff; margin-bottom: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Next Race Engine Rental</div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <div style="font-size: 14px; color: #9ca3af;">Status:</div>
                      <div id="p_engine_rental_status" style="padding: 8px 16px; border-radius: 6px; font-weight: 600; color: white; background: #ef4444; display: inline-block;">
                        No
                      </div>
                    </div>
                  </div>
                </div>

                <!-- PAYMENT OPTIONS -->
                <div class="panel">
                  <div class="panelTitle"><span class="accentBar" style="background:#22c55e"></span>POOL ENGINE RENTAL</div>
                  <div class="hint">Select and pay for engine rentals, race entries, or all-in packages for your competition.</div>

                  <div id="paymentsContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-top: 20px;">
                    <!-- Payment options will be populated here based on class -->
                  </div>
                </div>

                <!-- Payment History Section -->
                <div class="panel" style="margin-top: 24px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div class="panelTitle"><span class="accentBar" style="background:#22c55e"></span>Payment History</div>
                    <button onclick="loadDriverRaceEntries()" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                       Refresh
                    </button>
                  </div>
                  <div class="hint">Track all your payment transactions and statuses.</div>
                  <div id="paymentHistoryContainer" style="margin-top: 16px;">
                    <div style="color: #9ca3af; text-align: center; padding: 20px;">Loading payment history...</div>
                  </div>
                </div>
              </div>

              <div class="portalSection" data-psection="msa">
                <div class="panel">
                  <div class="panelTitle"><span class="accentBar" style="background:#8b5cf6"></span>MSA License Upload</div>
                  <div class="hint">Upload your Motor Sport Association license document. This helps us verify your racing credentials and maintains compliance records.</div>
                  
                  <div style="margin-top: 20px; padding: 20px; border: 2px dashed rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.03); text-align: center;">
                    <input type="file" id="msaFileInput" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" style="display: none;" onchange="handleMSAFileSelect(event)" />
                    <button class="btn primary" type="button" onclick="document.getElementById('msaFileInput').click()" style="margin-bottom: 12px;">
                       Choose File
                    </button>
                    <div style="font-size: 12px; color: #9ca3af; word-wrap: break-word;">PDF, Images, or Documents<br>(Max 10MB)</div>
                    <div id="selectedFileName" style="margin-top: 12px; font-weight: 600; color: #ffffff; min-height: 20px; word-wrap: break-word; overflow-wrap: break-word;"></div>
                  </div>

                  <div class="btnbar" style="margin-top: 16px;">
                    <button class="btn primary" id="btnUploadMSA" type="button" disabled>Upload License</button>
                  </div>

                  <div id="msaUploadStatus" style="margin-top: 16px; padding: 12px; border-radius: 6px; display: none; font-size: 14px;"></div>

                  <div style="margin-top: 24px;">
                    <div style="font-weight: 600; margin-bottom: 12px; color: #ffffff; font-size: 13px; letter-spacing: 0.05em;">CURRENT LICENSE:</div>
                    <div id="msaDocumentsList" style="padding: 16px; border: 1px solid rgba(255,255,255,0.08); border-radius: 6px; background: rgba(255,255,255,0.03); min-height: 60px;">
                      <div style="color: #9ca3af; text-align: center; font-size: 13px;">No document uploaded yet</div>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <!-- REGISTER -->
          <div id="tab-register">
            <div class="panel">
              <div class="panelTitle"><span class="accentBar" style="background:var(--summer)"></span>Driver Identity</div>
              <div class="row">
                <div>
                  <label>First name *</label>
                  <input id="r_first_name" />
                </div>
                <div>
                  <label>Last name *</label>
                  <input id="r_last_name" />
                </div>
              </div>
              <div class="row">
                <div>
                  <label>Date of birth *</label>
                  <input id="r_dob" type="date" />
                </div>
                <div>
                  <label>Nationality</label>
                  <input id="r_nat" placeholder="South African" />
                </div>
              </div>
              <div class="row">
                <div>
                  <label>ID / Passport *</label>
                  <input id="r_id" placeholder="ID or passport number" />
                </div>
                <div>
                  <label>Gender (optional)</label>
                  <input id="r_gender" placeholder="Optional" />
                </div>
              </div>
              <div class="row">
                <div>
                  <label>Driver Email *</label>
                  <input id="c_email" placeholder="driver@example.com" />
                </div>
              </div>
              <div class="hint" style="padding: 10px; background: rgba(250, 204, 21, 0.1); border-left: 3px solid #facc15; color: #9ca3af;">
                 Driver email is required for identity verification and communication
              </div>
            </div>

            <div class="panel">
              <div class="panelTitle"><span class="accentBar" style="background:var(--winter)"></span>Competition</div>
              <div style="margin-bottom: 16px;">
                <label style="display:block; font-weight:600; margin-bottom:10px; font-size:13px;">Championship *</label>
                <div class="champ-selector" id="champ-buttons-container">
                  <div class="champ-option rok-nats selected" data-champ="ROK NATS">ROK NATS</div>
                  <div class="champ-selector-group">
                    <div class="champ-option rok-nc" data-champ="ROK Northern Crown">Northern Crown</div>
                    <div class="champ-option rok-sc" data-champ="ROK Southern Crown">Southern Crown</div>
                  </div>
                </div>
                <div class="hint" style="font-size: 11px; margin-top: 8px; color: #6b7280;"> You can select multiple championships by clicking on each one</div>
                <select id="champ-select" style="display:none; width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:14px;" multiple size="3">
                  <option value="ROK NATS" selected>ROK NATS</option>
                  <option value="ROK Northern Crown">Northern Crown</option>
                  <option value="ROK Southern Crown">Southern Crown</option>
                </select>
                <input id="r_champ" type="hidden" value="ROK NATS" />
              </div>
              <div class="row">
                <div>
                  <label>Class</label>
                  <select id="r_class">
                    <option value="">Select class</option>
                    <option value="CADET">CADET</option>
                    <option value="MINI ROK U/10">MINI ROK U/10</option>
                    <option value="MINI ROK">MINI ROK</option>
                    <option value="OK-J">OK-J</option>
                    <option value="OK-N">OK-N</option>
                    <option value="KZ2">KZ2</option>
                  </select>
                </div>
                <div>
                  <label>Race number (optional)</label>
                  <input id="r_race" placeholder="e.g. 207" />
                </div>
              </div>
              <div class="row">
                <div>
                  <label>Team name</label>
                  <input id="r_team" />
                </div>
                <div>
                  <label>Coach name</label>
                  <input id="r_coach" />
                </div>
              </div>
              <div class="row">
                <div>
                  <label>Kart brand</label>
                  <input id="r_kart" placeholder="Tony Kart" />
                </div>
                <div>
                  <label>Transponder number</label>
                  <input id="r_transponder" />
                </div>
              </div>
            </div>

            <div class="panel" style="grid-column:1 / -1;">
              <div class="panelTitle"><span class="accentBar" style="background:var(--autumn)"></span>Entrant Details</div>
              <div style="margin-bottom:8px;"><label><input type="checkbox" id="entrant_same" /> Entrant is same as driver</label></div>
              <div class="row">
                <div>
                  <label>Primary guardian full name *</label>
                  <input id="c_name" />
                </div>
                <div>
                  <label>Relationship *</label>
                  <input id="c_rel" placeholder="Mother / Father / Guardian" />
                </div>
              </div>
              <div class="row">
                <div>
                  <label>Mobile phone *</label>
                  <input id="c_phone" placeholder="+27..." />
                </div>
              </div>
              <div class="row">
                <div>
                  <label>Emergency contact?</label>
                  <select id="c_emergency">
                    <option value="Y">Yes</option>
                    <option value="N">No</option>
                  </select>
                </div>
                <div>
                  <label>Consent contact?</label>
                  <select id="c_consent">
                    <option value="Y">Yes</option>
                    <option value="N">No</option>
                  </select>
                </div>
              </div>
              <div class="hint">Additional contacts can be added later via Admin. This MVP captures at least one entrant/guardian contact.</div>
            </div>

            <div class="panel">
              <div class="panelTitle"><span class="accentBar" style="background:var(--spring)"></span>Medical & Consent</div>
              <div class="row">
                <div>
                  <label>Allergies</label>
                  <input id="m_allergies" />
                </div>
                <div>
                  <label>Medical conditions</label>
                  <input id="m_conditions" />
                </div>
              </div>
              <div class="row">
                <div>
                  <label>Medication</label>
                  <input id="m_medication" />
                </div>
                <div>
                  <label>Doctor phone</label>
                  <input id="m_doctor_phone" />
                </div>
              </div>

              <div class="row">
                <div>
                  <label>Data processing consent *</label>
                  <select id="consent_signed">
                    <option value="Y">I agree</option>
                    <option value="N">I do not agree</option>
                  </select>
                </div>
                <div>
                  <label>Media release (optional)</label>
                  <select id="media_release_signed">
                    <option value="Y" selected>Yes</option>
                    <option value="N">No</option>
                  </select>
                </div>
              </div>

              <div class="hint">This system stores personal info of minors. Only operationally necessary data should be collected.</div>
            </div>

            <div class="panel">
              <div class="panelTitle"><span class="accentBar" style="background:var(--ink)"></span>Account Security</div>
              <div class="row">
                <div>
                  <label>Create a password *</label>
                  <input id="r_password" type="password" placeholder="Min 8 characters" />
                </div>
                <div>
                  <label>Confirm password *</label>
                  <input id="r_password_confirm" type="password" placeholder="Repeat password" />
                </div>
              </div>
              <div class="hint">Your password will be hashed and secured. You'll use this email and password to log in immediately after registration.</div>
            </div>

            <div class="panel" style="display: none;">
              <div class="panelTitle"><span class="accentBar" style="background:var(--winter)"></span>Documents</div>
              <div class="hint">Upload a profile photo and driver license. These help with race documentation and driver verification.</div>
              <div class="row">
                <div>
                  <label>Profile Photo</label>
                  <input id="r_profilePhoto" type="file" accept="image/*" />
                </div>
                <div>
                  <label>Driver License</label>
                  <input id="r_driverLicense" type="file" accept="image/*,.pdf" />
                </div>
              </div>
            </div>

            <div class="panel" style="grid-column:1 / -1;">
              <div class="panelTitle"><span class="accentBar" style="background:var(--green)"></span>Registration Result</div>
              <textarea id="regResult" style="min-height: 120px; resize: vertical;" placeholder="Registration results will appear here..." readonly></textarea>
            </div>

            <div class="panel" style="grid-column:1 / -1;">
              <div class="btnbar">
                <button class="btn primary" id="btnRegister" type="button">Submit Registration</button>
                <button class="btn" id="btnResetReg" type="button">Reset</button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- FORGOT PASSWORD MODAL -->
  <div id="forgotPasswordModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9999; flex-direction:column; align-items:center; justify-content:center;">
    <div style="background:#fff; padding:32px; border-radius:8px; max-width:400px; width:90%; box-shadow:0 10px 40px rgba(0,0,0,0.2);">
      <h2 style="margin:0 0 16px 0; font-size:18px; font-weight:700;">Reset Your Password</h2>
      <p style="margin:0 0 20px 0; color:#666; font-size:14px;">Enter the email address associated with your account. We'll send you a link to reset your password.</p>
      
      <div style="margin-bottom:16px;">
        <label style="display:block; font-weight:600; margin-bottom:6px; font-size:13px;">Email Address</label>
        <input id="forgotEmail" type="email" placeholder="your.email@example.com" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-family:inherit; font-size:14px;" />
      </div>

      <div id="forgotMessage" style="margin-bottom:16px; padding:12px; border-radius:4px; display:none; font-size:13px;"></div>

      <div style="display:flex; gap:10px;">
        <button id="btnSendReset" class="btn primary" type="button" style="flex:1;">Send Reset Link</button>
        <button id="btnCloseForgot" class="btn" type="button" style="flex:1;">Cancel</button>
      </div>
    </div>
  </div>

  <script>
  
    // Suppress browser extension message channel errors (harmless)
    window.addEventListener('unhandledrejection', function(event) {
      if (event.reason && event.reason.message && 
          event.reason.message.includes('message channel closed')) {
        event.preventDefault();
      }
    });
  
    // ====== NEW API ENDPOINT (Node.js Backend) ======
    const API_ENDPOINT = '/api';

    // ====== MD5 HASH FUNCTION FOR PAYFAST ======
    function md5(str) {
      // Simple MD5 implementation for PayFast signature
      // This is a basic implementation for client-side use
      function RotateLeft(lValue, iShiftBits) {
        return (lValue << iShiftBits) | (lValue >>> (32 - iShiftBits));
      }
      function AddUnsigned(lX, lY) {
        var lX4, lY4, lX8, lY8, lResult;
        lX8 = (lX & 0x80000000);
        lY8 = (lY & 0x80000000);
        lX4 = (lX & 0x40000000);
        lY4 = (lY & 0x40000000);
        lResult = (lX & 0x3FFFFFFF) + (lY & 0x3FFFFFFF);
        if (lX4 & lY4) {
          return (lResult ^ 0x80000000 ^ lX8 ^ lY8);
        }
        if (lX4 | lY4) {
          if (lResult & 0x40000000) {
            return (lResult ^ 0xC0000000 ^ lX8 ^ lY8);
          } else {
            return (lResult ^ 0x40000000 ^ lX8 ^ lY8);
          }
        } else {
          return (lResult ^ lX8 ^ lY8);
        }
      }
      function F(x, y, z) { return (x & y) | ((~x) & z); }
      function G(x, y, z) { return (x & z) | (y & (~z)); }
      function H(x, y, z) { return (x ^ y ^ z); }
      function I(x, y, z) { return (y ^ (x | (~z))); }
      function FF(a, b, c, d, x, s, ac) {
        a = AddUnsigned(a, AddUnsigned(AddUnsigned(F(b, c, d), x), ac));
        return AddUnsigned(RotateLeft(a, s), b);
      }
      function GG(a, b, c, d, x, s, ac) {
        a = AddUnsigned(a, AddUnsigned(AddUnsigned(G(b, c, d), x), ac));
        return AddUnsigned(RotateLeft(a, s), b);
      }
      function HH(a, b, c, d, x, s, ac) {
        a = AddUnsigned(a, AddUnsigned(AddUnsigned(H(b, c, d), x), ac));
        return AddUnsigned(RotateLeft(a, s), b);
      }
      function II(a, b, c, d, x, s, ac) {
        a = AddUnsigned(a, AddUnsigned(AddUnsigned(I(b, c, d), x), ac));
        return AddUnsigned(RotateLeft(a, s), b);
      }
      function ConvertToWordArray(str) {
        var lWordCount;
        var lMessageLength = str.length;
        var lNumberOfWords_temp1 = lMessageLength + 8;
        var lNumberOfWords_temp2 = (lNumberOfWords_temp1 - (lNumberOfWords_temp1 % 64)) / 64;
        var lNumberOfWords = (lNumberOfWords_temp2 + 1) * 16;
        var lWordArray = Array(lNumberOfWords - 1);
        var lBytePosition = 0;
        var lByteCount = 0;
        while (lByteCount < lMessageLength) {
          lWordCount = (lByteCount - (lByteCount % 4)) / 4;
          lBytePosition = (lByteCount % 4) * 8;
          lWordArray[lWordCount] = (lWordArray[lWordCount] | (str.charCodeAt(lByteCount) << lBytePosition));
          lByteCount++;
        }
        lWordCount = (lByteCount - (lByteCount % 4)) / 4;
        lBytePosition = (lByteCount % 4) * 8;
        lWordArray[lWordCount] = lWordArray[lWordCount] | (0x80 << lBytePosition);
        lWordArray[lNumberOfWords - 2] = lMessageLength << 3;
        lWordArray[lNumberOfWords - 1] = lMessageLength >>> 29;
        return lWordArray;
      }
      function WordToHex(lValue) {
        var WordToHexValue = "", lByte, lCount;
        for (lCount = 0; lCount <= 3; lCount++) {
          lByte = (lValue >>> (lCount * 8)) & 255;
          WordToHexValue += ((lByte < 16) ? "0" : "") + lByte.toString(16);
        }
        return WordToHexValue;
      }
      var x = ConvertToWordArray(str);
      var a = 0x67452301;
      var b = 0xefcdab89;
      var c = 0x98badcfe;
      var d = 0x10325476;
      for (var q = 0; q < x.length; q += 16) {
        var aa = a, bb = b, cc = c, dd = d;
        a = FF(a, b, c, d, x[q + 0], 7, 0xd76aa478);
        d = FF(d, a, b, c, x[q + 1], 12, 0xe8c7b756);
        c = FF(c, d, a, b, x[q + 2], 17, 0x242070db);
        b = FF(b, c, d, a, x[q + 3], 22, 0xc1bdceee);
        a = FF(a, b, c, d, x[q + 4], 7, 0xf57c0faf);
        d = FF(d, a, b, c, x[q + 5], 12, 0x4787c62a);
        c = FF(c, d, a, b, x[q + 6], 17, 0xa8304613);
        b = FF(b, c, d, a, x[q + 7], 22, 0xfd469501);
        a = FF(a, b, c, d, x[q + 8], 7, 0x698098d8);
        d = FF(d, a, b, c, x[q + 9], 12, 0x8b44f7af);
        c = FF(c, d, a, b, x[q + 10], 17, 0xffff5bb1);
        b = FF(b, c, d, a, x[q + 11], 22, 0x895cd7be);
        a = FF(a, b, c, d, x[q + 12], 7, 0x6b901122);
        d = FF(d, a, b, c, x[q + 13], 12, 0xfd987193);
        c = FF(c, d, a, b, x[q + 14], 17, 0xa679438e);
        b = FF(b, c, d, a, x[q + 15], 22, 0x49b40821);
        a = GG(a, b, c, d, x[q + 1], 5, 0xf61e2562);
        d = GG(d, a, b, c, x[q + 6], 9, 0xc040b340);
        c = GG(c, d, a, b, x[q + 11], 14, 0x265e5a51);
        b = GG(b, c, d, a, x[q + 0], 20, 0xe9b6c7aa);
        a = GG(a, b, c, d, x[q + 5], 5, 0xd62f105d);
        d = GG(d, a, b, c, x[q + 10], 9, 0x2441453);
        c = GG(c, d, a, b, x[q + 15], 14, 0xd8a1e681);
        b = GG(b, c, d, a, x[q + 4], 20, 0xe7d3fbc8);
        a = GG(a, b, c, d, x[q + 9], 5, 0x21e1cde6);
        d = GG(d, a, b, c, x[q + 14], 9, 0xc33707d6);
        c = GG(c, d, a, b, x[q + 3], 14, 0xf4d50d87);
        b = GG(b, c, d, a, x[q + 8], 20, 0x455a14ed);
        a = GG(a, b, c, d, x[q + 13], 5, 0xa9e3e905);
        d = GG(d, a, b, c, x[q + 2], 9, 0xfcefa3f8);
        c = GG(c, d, a, b, x[q + 7], 14, 0x676f02d9);
        b = GG(b, c, d, a, x[q + 12], 20, 0x8d2a4c8a);
        a = HH(a, b, c, d, x[q + 5], 4, 0xfffa3942);
        d = HH(d, a, b, c, x[q + 8], 11, 0x8771f681);
        c = HH(c, d, a, b, x[q + 11], 16, 0x6d9d6122);
        b = HH(b, c, d, a, x[q + 14], 23, 0xfde5380c);
        a = HH(a, b, c, d, x[q + 1], 4, 0xa4beea44);
        d = HH(d, a, b, c, x[q + 4], 11, 0x4bdecfa9);
        c = HH(c, d, a, b, x[q + 7], 16, 0xf6bb4b60);
        b = HH(b, c, d, a, x[q + 10], 23, 0xbebfbc70);
        a = HH(a, b, c, d, x[q + 13], 4, 0x289b7ec6);
        d = HH(d, a, b, c, x[q + 0], 11, 0xeaa127fa);
        c = HH(c, d, a, b, x[q + 3], 16, 0xd4ef3085);
        b = HH(b, c, d, a, x[q + 6], 23, 0x4881d05);
        a = HH(a, b, c, d, x[q + 9], 4, 0xd9d4d039);
        d = HH(d, a, b, c, x[q + 12], 11, 0xe6db99e5);
        c = HH(c, d, a, b, x[q + 15], 16, 0x1fa27cf8);
        b = HH(b, c, d, a, x[q + 2], 23, 0xc4ac5665);
        a = II(a, b, c, d, x[q + 0], 6, 0xf4292244);
        d = II(d, a, b, c, x[q + 7], 10, 0x432aff97);
        c = II(c, d, a, b, x[q + 14], 15, 0xab9423a7);
        b = II(b, c, d, a, x[q + 5], 21, 0xfc93a039);
        a = II(a, b, c, d, x[q + 12], 6, 0x655b59c3);
        d = II(d, a, b, c, x[q + 3], 10, 0x8f0ccc92);
        c = II(c, d, a, b, x[q + 10], 15, 0xffeff47d);
        b = II(b, c, d, a, x[q + 1], 21, 0x85845dd1);
        a = II(a, b, c, d, x[q + 8], 6, 0x6fa87e4f);
        d = II(d, a, b, c, x[q + 15], 10, 0xfe2ce6e0);
        c = II(c, d, a, b, x[q + 6], 15, 0xa3014314);
        b = II(b, c, d, a, x[q + 13], 21, 0x4e0811a1);
        a = II(a, b, c, d, x[q + 4], 6, 0xf7537e82);
        d = II(d, a, b, c, x[q + 11], 10, 0xbd3af235);
        c = II(c, d, a, b, x[q + 2], 15, 0x2ad7d2bb);
        b = II(b, c, d, a, x[q + 9], 21, 0xeb86d391);
        a = AddUnsigned(a, aa);
        b = AddUnsigned(b, bb);
        c = AddUnsigned(c, cc);
        d = AddUnsigned(d, dd);
      }
      var temp = WordToHex(a) + WordToHex(b) + WordToHex(c) + WordToHex(d);
      return temp.toLowerCase();
    }

    let currentDriverId = "";
    let currentEmail = "";
    let currentPassword = "";
    let currentProfile = null;
    let currentDriverData = {};
    let currentToken = localStorage.getItem('driverToken') || '';

    // Auto-login function - checks for saved credentials and logs in automatically
    async function attemptAutoLogin() {
      const savedEmail = localStorage.getItem('driverEmail');
      const savedPassword = localStorage.getItem('driverPassword');
      const savedToken = localStorage.getItem('driverToken');
      
      if (!savedEmail || !savedPassword || !savedToken) {
        console.log(' No saved credentials found');
        return false;
      }
      
      console.log(' Attempting auto-login for:', savedEmail);
      
      try {
        setStatusCard_({
          chipText: "Auto-login",
          chipKind: "wait",
          driver: "",
          klass: "",
          ident: savedEmail,
          status: "",
          note: "Restoring your session",
          spinner: true
        });
        
        const profile = await api('loginWithPassword', { email: savedEmail, password: savedPassword });
        
        if (profile && profile.driver) {
          let driverId = "";
          if (profile.driver.driver_id) {
            driverId = String(profile.driver.driver_id);
          } else if (profile.driver_id) {
            driverId = String(profile.driver_id);
          } else if (profile.id) {
            driverId = String(profile.id);
          }
          
          window.currentDriverId = driverId;
          currentDriverId = driverId;
          currentEmail = savedEmail;
          currentPassword = savedPassword;
          currentToken = savedToken;
          currentProfile = profile;
          
          renderPortal(profile, savedEmail);
          document.body.classList.add('logged-in');
          toast("good", "Welcome back! Session restored.");
          console.log(' Auto-login successful');
          return true;
        } else {
          throw new Error('Invalid session');
        }
      } catch (err) {
        console.log(' Auto-login failed:', err.message);
        // Clear invalid credentials
        localStorage.removeItem('driverEmail');
        localStorage.removeItem('driverPassword');
        localStorage.removeItem('driverToken');
        return false;
      }
    }
    
    // Run auto-login on page load
    window.addEventListener('DOMContentLoaded', () => {
      attemptAutoLogin();
      // Pull-to-refresh disabled to prevent scrolling interference
      // initPullToRefresh();
    });

    // Pull-to-refresh functionality for mobile
    function initPullToRefresh() {
      let startY = 0;
      let currentY = 0;
      let isDragging = false;
      let refreshThreshold = 80; // pixels to pull before triggering refresh
      
      const portalSections = document.getElementById('portalSections');
      if (!portalSections) return;
      
      // Create pull indicator
      const pullIndicator = document.createElement('div');
      pullIndicator.id = 'pullIndicator';
      pullIndicator.style.cssText = `
        position: fixed;
        top: -60px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        color: white;
        box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4);
        transition: top 0.3s ease, transform 0.3s ease;
        z-index: 10000;
        pointer-events: none;
      `;
      pullIndicator.innerHTML = '';
      document.body.appendChild(pullIndicator);
      
      portalSections.addEventListener('touchstart', (e) => {
        // Only enable if scrolled to top
        if (portalSections.scrollTop === 0) {
          startY = e.touches[0].clientY;
          isDragging = true;
        } else {
          isDragging = false;
        }
      }, { passive: true });
      
      portalSections.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        
        currentY = e.touches[0].clientY;
        const pullDistance = currentY - startY;
        
        // Only activate if pulling DOWN (positive distance) AND at the very top
        if (pullDistance > 10 && portalSections.scrollTop === 0) {
          // Prevent default scroll
          e.preventDefault();
          
          // Move indicator down
          const indicatorPos = Math.min(pullDistance - 20, refreshThreshold);
          pullIndicator.style.top = `${indicatorPos}px`;
          
          // Rotate arrow as you pull
          const rotation = Math.min((pullDistance / refreshThreshold) * 180, 180);
          pullIndicator.style.transform = `translateX(-50%) rotate(${rotation}deg)`;
          
          // Change to spinner icon when threshold reached
          if (pullDistance >= refreshThreshold) {
            pullIndicator.innerHTML = '';
            pullIndicator.style.animation = 'spin 1s linear infinite';
          } else {
            pullIndicator.innerHTML = '';
            pullIndicator.style.animation = 'none';
          }
        }
      }, { passive: false });
      
      portalSections.addEventListener('touchend', async (e) => {
        if (!isDragging) return;
        
        const pullDistance = currentY - startY;
        isDragging = false;
        
        if (pullDistance >= refreshThreshold) {
          // Trigger refresh
          pullIndicator.innerHTML = '';
          pullIndicator.style.animation = 'spin 1s linear infinite';
          
          try {
            // Refresh current tab data
            await refreshCurrentTab();
            
            // Show success
            pullIndicator.innerHTML = '';
            pullIndicator.style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
            pullIndicator.style.animation = 'none';
            
            setTimeout(() => {
              pullIndicator.style.top = '-60px';
              pullIndicator.style.transform = 'translateX(-50%) rotate(0deg)';
              
              setTimeout(() => {
                pullIndicator.style.background = 'linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%)';
                pullIndicator.innerHTML = '';
              }, 300);
            }, 800);
            
          } catch (error) {
            console.error('Refresh error:', error);
            pullIndicator.innerHTML = '';
            pullIndicator.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            pullIndicator.style.animation = 'none';
            
            setTimeout(() => {
              pullIndicator.style.top = '-60px';
              pullIndicator.style.transform = 'translateX(-50%) rotate(0deg)';
              
              setTimeout(() => {
                pullIndicator.style.background = 'linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%)';
                pullIndicator.innerHTML = '';
              }, 300);
            }, 800);
          }
        } else {
          // Reset indicator
          pullIndicator.style.top = '-60px';
          pullIndicator.style.transform = 'translateX(-50%) rotate(0deg)';
        }
        
        currentY = 0;
        startY = 0;
      });
      
      // Add spin animation
      const style = document.createElement('style');
      style.textContent = `
        @keyframes spin {
          from { transform: translateX(-50%) rotate(0deg); }
          to { transform: translateX(-50%) rotate(360deg); }
        }
      `;
      document.head.appendChild(style);
    }
    
    // Refresh data for currently active tab
    async function refreshCurrentTab() {
      const activeTab = document.querySelector('.portalSection.active');
      if (!activeTab) return;
      
      const section = activeTab.getAttribute('data-psection');
      
      console.log(` Refreshing tab: ${section}`);
      
      switch(section) {
        case 'driver':
          // Reload driver profile
          if (currentEmail && currentPassword) {
            const profile = await api('loginWithPassword', { email: currentEmail, password: currentPassword });
            if (profile && profile.driver) {
              renderPortalData(profile);
            }
          }
          break;
          
        case 'events':
          if (currentDriverId) {
            await loadDriverEvents(currentDriverId);
          }
          break;
          
        case 'points':
          if (currentDriverId && currentProfile && currentProfile.driver) {
            await loadDriverPoints(currentDriverId, currentProfile.driver.class, currentProfile.driver.championship);
          }
          break;
          
        case 'notifications':
          await loadNotificationHistory();
          break;
          
        case 'payments':
          await loadPaymentHistory();
          break;
          
        default:
          console.log(`No refresh handler for tab: ${section}`);
      }
      
      toast("good", "Refreshed!");
    }

    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    }

    function toast(type, msg){
      const el = document.getElementById("toast");
      if(!el) return;
      el.innerHTML = msg ? `<div class="toast ${type}">${escapeHtml(msg)}</div>` : "";
      
      // Show centered message for all types
      if (msg) {
        showCenteredMessage(type, msg);
      }
    }

    function showCenteredMessage(type, message) {
      // Create overlay if it doesn't exist
      let overlay = document.getElementById('errorOverlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'errorOverlay';
        overlay.className = 'error-overlay';
        overlay.innerHTML = `
          <div class="error-box">
            <div class="error-box-icon" id="messageIcon"></div>
            <div class="error-box-title" id="messageTitle">Error</div>
            <div class="error-box-message" id="errorMessage"></div>
          </div>
        `;
        document.body.appendChild(overlay);
        
        // Click to dismiss
        overlay.addEventListener('click', () => {
          overlay.classList.remove('show');
        });
      }

      // Set icon and title based on type
      const iconEl = document.getElementById('messageIcon');
      const titleEl = document.getElementById('messageTitle');
      if (type === 'good') {
        iconEl.textContent = '';
        titleEl.textContent = 'Success';
      } else if (type === 'info') {
        iconEl.textContent = '';
        titleEl.textContent = 'Info';
      } else {
        iconEl.textContent = '';
        titleEl.textContent = 'Error';
      }

      // Set message and show
      document.getElementById('errorMessage').textContent = message;
      overlay.classList.add('show');

      // Auto-hide after 2.5 seconds
      setTimeout(() => {
        overlay.classList.remove('show');
      }, 2500);
    }

    function showConfirmation(title, message, icon = "") {
      const modal = document.getElementById("confirmationModal");
      const titleEl = document.getElementById("confirmTitle");
      const messageEl = document.getElementById("confirmMessage");
      const iconEl = document.getElementById("confirmIcon");
      const btnEl = document.getElementById("confirmButton");

      titleEl.textContent = title;
      messageEl.textContent = message;
      iconEl.textContent = icon;

      modal.style.display = "flex";

      // Remove any existing listeners to prevent duplicates
      btnEl.replaceWith(btnEl.cloneNode(true));
      const newBtn = document.getElementById("confirmButton");

      return new Promise((resolve) => {
        const handleClose = () => {
          modal.style.display = "none";
          modal.onclick = null;
          resolve();
        };

        newBtn.onclick = handleClose;
        modal.onclick = (e) => {
          if (e.target === modal) {
            handleClose();
          }
        };
      });
    }

    // Updated API function for new server format
    async function api(action, payload) {
      const url = `${API_ENDPOINT}/${action}`;
      
      console.log(` API call: ${action}, payload size: ${JSON.stringify(payload).length} bytes`);
      
      try {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload || {})
        });

        console.log(` API response status: ${res.status} for ${action}`);

        const json = await res.json();
        console.log(` API response data:`, json);

        if (!json.success) throw new Error(json.error?.message || "Unknown server error");
        return json.data;
      } catch (err) {
        console.error(` API error for ${action}:`, err);
        throw err;
      }
    }

    function safeReplaceUrl_(url){
      try { history.replaceState(null, "", url); } catch(e) { /* ignore in srcdoc sandbox */ }
    }

    // Initialize - both tabs should be hidden by default
    const initReg = document.getElementById("tab-register");
    const initPortal = document.getElementById("tab-portal");
    
    if(initReg) {
      initReg.classList.remove("show");
    }
    if(initPortal) {
      initPortal.classList.remove("show");
    }
    console.log("Initialization complete. Portal shown:", initPortal?.classList.contains("show"), "Register shown:", initReg?.classList.contains("show"));

    function setMode(mode){
      console.log("setMode called with:", mode);
      
      const portal = document.getElementById("tab-portal");
      const reg = document.getElementById("tab-register");
      const gate = document.getElementById("modeGate");
      const body = document.getElementById("bodyArea");
      
      // Always update tab buttons
      document.querySelectorAll(".tab").forEach(b => {
        b.classList.remove("active");
      });

      // Update carousel indicators
      document.querySelectorAll(".carousel-option").forEach(b => {
        b.classList.remove("active");
      });
      document.querySelectorAll(".carousel-dot").forEach(b => {
        b.classList.remove("active");
      });
      
      if (mode) {
        const activeBtn = document.querySelector(`.tab[data-tab="${mode}"]`);
        if (activeBtn) {
          activeBtn.classList.add("active");
        }
        const activeOption = document.querySelector(`.carousel-option[data-tab="${mode}"]`);
        if (activeOption) {
          activeOption.classList.add("active");
        }
        const activeDot = document.querySelector(`.carousel-dot[data-tab="${mode}"]`);
        if (activeDot) {
          activeDot.classList.add("active");
        }
      }

      // First, always remove show from both tabs
      if (portal) portal.classList.remove("show");
      if (reg) reg.classList.remove("show");

      if (!mode) {
        // Return to mode selection
        console.log("Returning to mode selection");
        if (gate) gate.style.display = "flex";
        if (body) body.style.display = "none";
        toast("", "");
        safeReplaceUrl_(location.pathname + location.search);
        return;
      }

      // Showing a mode
      console.log("Showing mode:", mode);
      if (gate) gate.style.display = "none";
      if (body) body.style.display = "block";

      // Add show to the selected tab only
      if (mode === "portal" && portal) {
        portal.classList.add("show");
      } else if (mode === "register" && reg) {
        reg.classList.add("show");
      }

      console.log("setMode complete. Portal:", portal?.classList.contains("show") ? "shown" : "hidden", "Register:", reg?.classList.contains("show") ? "shown" : "hidden");
      safeReplaceUrl_(location.pathname + location.search + "#" + mode);
      toast("", "");
    }

    function setPortalTab(key){
      document.querySelectorAll(".ptab").forEach(b=>b.classList.remove("active"));
      const btn = document.querySelector(`.ptab[data-ptab="${key}"]`);
      if(btn) {
        btn.classList.add("active");
      }

      // Update mobile menu
      document.querySelectorAll(".portalTab-option").forEach(b=>b.classList.remove("active"));
      const mobileOption = document.querySelector(`.portalTab-option[data-ptab="${key}"]`);
      if(mobileOption) {
        mobileOption.classList.add("active");
      }

      // Update current tab display
      const currentLabel = document.querySelector(".portalTab-current-label");
      if(currentLabel) {
        const labels = {
          'driver': 'Driver',
          'contacts': 'Entrant',
          'medical': 'Medical',
          'events': 'Events',
          'points': 'Points',
          'payments': 'Entries',
          'msa': 'License',
          'notifications': 'Notifications',
          'requests': 'Admin'
        };
        currentLabel.textContent = labels[key] || 'Driver';
      }

      // Close menu after selection
      const menu = document.querySelector(".portalTab-menu");
      if(menu) menu.classList.remove("expanded");

      document.querySelectorAll(".portalSection").forEach(s=>s.classList.remove("active"));
      const sec = document.querySelector(`.portalSection[data-psection="${key}"]`);
      if(sec) {
        sec.classList.add("active");
      }
    }

    /* Mobile Portal Sidebar Navigation */
    function initPortalSidebar() {
      const toggle = document.querySelector('.portal-nav-toggle');
      const sidebar = document.querySelector('.portal-sidebar');
      const backdrop = document.querySelector('.portal-nav-backdrop');
      const sidebarItems = document.querySelectorAll('.portal-sidebar-item[data-ptab]');
      
      if (!toggle || !sidebar || !backdrop) return;
      
      function openSidebar() {
        sidebar.classList.add('active');
        backdrop.classList.add('active');
        backdrop.style.display = 'block';
        toggle.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
      
      function closeSidebar() {
        sidebar.classList.remove('active');
        backdrop.classList.remove('active');
        toggle.classList.remove('active');
        document.body.style.overflow = '';
        setTimeout(() => {
          if (!backdrop.classList.contains('active')) {
            backdrop.style.display = 'none';
          }
        }, 300);
      }
      
      toggle.addEventListener('click', function(e) {
        e.stopPropagation();
        if (sidebar.classList.contains('active')) {
          closeSidebar();
        } else {
          openSidebar();
        }
      });
      
      backdrop.addEventListener('click', closeSidebar);
      
      // Handle sidebar item clicks
      sidebarItems.forEach(item => {
        item.addEventListener('click', function() {
          const ptab = this.getAttribute('data-ptab');
          if (ptab) {
            // Update active state in sidebar
            document.querySelectorAll('.portal-sidebar-item').forEach(i => i.classList.remove('active'));
            this.classList.add('active');
            
            // Switch to the tab
            setPortalTab(ptab);
            
            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
              closeSidebar();
            }
          }
        });
      });
      
      // Close sidebar when window is resized to desktop
      window.addEventListener('resize', function() {
        if (window.innerWidth > 768) {
          closeSidebar();
        }
      });
      
      // Sync sidebar active state when desktop tabs are clicked
      document.querySelectorAll('.ptab[data-ptab]').forEach(tab => {
        tab.addEventListener('click', function() {
          const ptab = this.getAttribute('data-ptab');
          if (ptab) {
            document.querySelectorAll('.portal-sidebar-item').forEach(i => i.classList.remove('active'));
            const sidebarItem = document.querySelector(`.portal-sidebar-item[data-ptab="${ptab}"]`);
            if (sidebarItem) sidebarItem.classList.add('active');
          }
        });
      });
    }
    
    // Initialize sidebar on page load
    document.addEventListener('DOMContentLoaded', initPortalSidebar);

    /* Class colors mapping */
    const classColors = {
      'CADET': '#ec4899',
      'MINI ROK U/10': '#f59e0b',
      'MINI ROK': '#06b6d4',
      'OK-J': '#8b5cf6',
      'OK-N': '#6366f1',
      'KZ2': '#8b5cf6'
    };

    /* Status helpers */
    function setStatusCard_(opts){
      const {
        chipText="Not logged in",
        chipKind="wait",
        driver="",
        klass="",
        ident="",
        status="",
        note="Log in to load your portal. You will see your profile, entrant details, and NAT entry controls.",
        spinner=false
      } = (opts || {});

      const chipClass = (chipKind==="ok") ? "ok" : (chipKind==="bad") ? "bad" : "wait";
      const spinHtml = spinner ? `<span class="spinner" aria-hidden="true"></span>` : "";
      const klassColor = classColors[klass] || '#9ca3af';
      const klassDisplay = klass === "" ? "" : `<span style="display: inline-block; padding: 8px 16px; border: 2px solid ${klassColor}; color: ${klassColor}; border-radius: 6px; font-weight: 700; font-size: 13px; background: transparent;">${escapeHtml(klass)}</span>`;
      
      // Add bounce animation to Entries & Rentals tab on login
      if(chipKind === "ok") {
        setTimeout(() => {
          const paymentsTab = document.querySelector('.ptab[data-ptab="payments"]');
          if(paymentsTab) {
            paymentsTab.classList.add('bounce');
            setTimeout(() => {
              paymentsTab.classList.remove('bounce');
            }, 800);
          }
        }, 100);
      }

      document.getElementById("portalStatus").innerHTML = `
        <div class="statusCard">
          <div class="statusTop">
            <div class="statusTitle">Session</div>
            <div class="statusChip ${chipClass}">${spinHtml}${escapeHtml(chipText)}</div>
          </div>

          <div class="statusBody">
            <div class="kv"><div class="k">Driver</div><div class="v">${escapeHtml(driver)}</div></div>
            <div class="kv"><div class="k">Class</div><div class="v">${klassDisplay}</div></div>
            <div class="kv"><div class="k">Driver ID / Email</div><div class="v">${escapeHtml(ident)}</div></div>
            <div class="kv"><div class="k">Status</div><div class="v">${escapeHtml(status)}</div></div>
          </div>

          <div class="statusNote">${escapeHtml(note)}</div>
        </div>
      `;
    }

    function setButtonLoading_(btn, isLoading, labelWhenNotLoading){
      if(!btn) return;
      if(isLoading){
        btn.classList.add("loading");
        btn.dataset.prevText = btn.textContent;
        btn.textContent = "Working";
      }else{
        btn.classList.remove("loading");
        btn.textContent = labelWhenNotLoading || btn.dataset.prevText || btn.textContent;
      }
    }

    function clearPortal(){
      currentDriverId = "";
      window.currentDriverId = "";
      currentPin = "";
      currentProfile = null;
      currentEmail = "";
      currentPassword = "";
      // Clear saved session
      localStorage.removeItem('driverEmail');
      localStorage.removeItem('driverPassword');
      localStorage.removeItem('driverToken');
      document.body.classList.remove('logged-in'); // Hide mobile logged-in state

      document.getElementById("portalTabs").style.display = "none";
      document.getElementById("portalSections").style.display = "none";

      document.getElementById("btnLogout").disabled = true;
      document.getElementById("btnSaveProfile").disabled = true;
      document.getElementById("btnSendRequest").disabled = true;
      
      // Hide inline status buttons
      const inlineBtns = document.getElementById("statusInlineButtons");
      if (inlineBtns) inlineBtns.style.display = "none";

      setStatusCard_();

      ["p_first_name","p_last_name","p_class","p_race_number","p_license_number","p_transponder_number","p_kart_brand","p_team_name","p_coach_name"]
        .forEach(id => { const el = document.getElementById(id); if(el) el.value = ""; });

      document.getElementById("p_contactsTable").innerHTML = `<div class="hint">No data loaded.</div>`;
      document.getElementById("p_medicalBlock").innerHTML = `<div class="hint">No data loaded.</div>`;
      document.getElementById("p_pointsTable").innerHTML = `<div class="hint">No points loaded.</div>`;

      setPortalTab("driver");
    }

    function renderPortal(profile, identShown){
      const d = profile.driver || {};
      currentDriverData = d;  // Store in global for use in other functions
      const contacts = profile.contacts || [];
      const med = profile.medical || {};
      const points = profile.points || [];

      const driverName = `${(d.first_name||"").trim()} ${(d.last_name||"").trim()}`.trim() || "";

      setStatusCard_({
        chipText: "Logged in",
        chipKind: "ok",
        driver: driverName,
        klass: d.class || "",
        ident: identShown || d.driver_id || "",
        status: d.status || "Approved",
        note: "Portal loaded. Use the tabs above to review and manage your information."
      });

      document.getElementById("portalTabs").style.display = "flex";
      document.getElementById("portalSections").style.display = "block";
      document.getElementById("btnLogout").disabled = false;
      document.getElementById("btnSaveProfile").disabled = false;
      document.getElementById("btnSendRequest").disabled = false;
      
      // Show inline status buttons (Logout/Home in status card header)
      const inlineBtns = document.getElementById("statusInlineButtons");
      if (inlineBtns) inlineBtns.style.display = "flex";
      
      // Set the payments (Entries & Rentals) tab active by default
      setPortalTab("payments");
      
      // Load notification history when logged in
      loadNotificationHistory();

      document.getElementById("p_email").value = d.email || identShown || "";
      document.getElementById("p_first_name").value = d.first_name || "";
      document.getElementById("p_last_name").value = d.last_name || "";
      document.getElementById("p_class").value = d.class || "";
      document.getElementById("p_race_number").value = d.race_number || "";
      document.getElementById("p_license_number").value = d.license_number || "";
      document.getElementById("p_transponder_number").value = d.transponder_number || "";
      document.getElementById("p_kart_brand").value = d.kart_brand || "";
      document.getElementById("p_team_name").value = d.team_name || "";
      document.getElementById("p_coach_name").value = d.coach_name || "";

      // Update engine rental status based on pool engine rentals
      // If driver has season engine rental from pool, this is always Registered/Green
      const seasonEngineRentalEl = document.getElementById("p_season_engine_rental_status");
      const hasSeasonEngineRental = d.season_engine_rental === 'Y' ? true : false;
      if (seasonEngineRentalEl) {
        seasonEngineRentalEl.textContent = hasSeasonEngineRental ? 'Registered' : 'Not Registered';
        seasonEngineRentalEl.style.background = hasSeasonEngineRental ? '#10b981' : '#ef4444';
        seasonEngineRentalEl.style.boxShadow = hasSeasonEngineRental ? '0 0 12px 3px rgba(16, 185, 129, 0.6)' : 'none';
      }

      // Update season entry status
      const seasonEntryEl = document.getElementById("p_season_entry_status");
      if (seasonEntryEl) {
        const status = d.season_entry_status || 'Not Registered';
        const displayStatus = (status === 'Registered' || status === 'Confirmed') ? 'Registered' : 'Not Registered';
        seasonEntryEl.textContent = displayStatus;
        seasonEntryEl.style.background = displayStatus === 'Registered' ? '#10b981' : '#ef4444';
        seasonEntryEl.style.boxShadow = displayStatus === 'Registered' ? '0 0 12px 3px rgba(16, 185, 129, 0.6)' : 'none';
      }

      // Update next race entry status with dynamic date
      const nextRaceEl = document.getElementById("p_next_race_entry_status");
      const nextRaceLabel = document.getElementById("nextRaceLabel");
      if (nextRaceEl && nextRaceLabel) {
        const status = d.next_race_entry_status || 'Not Registered';
        const displayStatus = (status === 'Registered' || status === 'Confirmed') ? 'Registered' : 'Not Registered';
        nextRaceEl.textContent = displayStatus;
        nextRaceEl.style.background = displayStatus === 'Registered' ? '#10b981' : '#ef4444';
        nextRaceEl.style.boxShadow = displayStatus === 'Registered' ? '0 0 12px 3px rgba(16, 185, 129, 0.6)' : 'none';
        // Update label with next race date (14 Feb at Redstar)
        nextRaceLabel.textContent = 'Next Race Entry (14 Feb - Redstar)';
      }

      // Update engine rental status (Next Race Engine Rental)
      // If Season Engine Rental from pool is paid, this is always Registered/Green
      const engineRentalEl = document.getElementById("p_engine_rental_status");
      if (engineRentalEl) {
        if (hasSeasonEngineRental) {
          // Season engine rental is paid, so next race engine rental is always Registered
          engineRentalEl.textContent = 'Registered';
          engineRentalEl.style.background = '#10b981';
          engineRentalEl.style.boxShadow = '0 0 12px 3px rgba(16, 185, 129, 0.6)';
        } else {
          // No season rental, check if next race only rental is paid
          const nextRaceRentalStatus = d.next_race_engine_rental_status || 'No';
          const displayStatus = (nextRaceRentalStatus === 'Yes' || nextRaceRentalStatus === 'Paid') ? 'Registered' : 'Not Registered';
          engineRentalEl.textContent = displayStatus;
          engineRentalEl.style.background = displayStatus === 'Registered' ? '#10b981' : '#ef4444';
          engineRentalEl.style.boxShadow = displayStatus === 'Registered' ? '0 0 12px 3px rgba(16, 185, 129, 0.6)' : 'none';
        }
      }

      // Populate payment options based on class
      // populatePaymentOptions(d.class);  // Commented out - using pool engine rentals instead
      
      // Load payment history
      loadPaymentHistory();

      // Load pool engine rental options
      loadPoolEngineRentals();

      // Load events into View Entries dropdown
      loadEntriesEventDropdown();

      const rows = (contacts.length ? contacts : [{}]).map(c => `
        <tr>
          <td>${escapeHtml(c.relationship||"")}</td>
          <td>${escapeHtml(c.full_name||"")}</td>
          <td>${escapeHtml(c.email||"")}</td>
          <td>${escapeHtml(c.phone_mobile||"")}</td>
          <td>${escapeHtml([
            (c.emergency_contact==="Y"?"Emergency":""),
            (c.consent_contact==="Y"?"Consent":""),
            (c.billing_contact==="Y"?"Billing":"")
          ].filter(Boolean).join(" / "))}</td>
        </tr>
      `).join("");

      document.getElementById("p_contactsTable").innerHTML = `
        <table class="table">
          <thead><tr><th>Relationship</th><th>Name</th><th>Email</th><th>Mobile</th><th>Flags</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      document.getElementById("p_medicalBlock").innerHTML = `
        <div class="row">
          <div>
            <label>Allergies</label>
            <textarea id="p_allergies" rows="2" placeholder="List any allergies...">${escapeHtml(med.allergies||"")}</textarea>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Medical Conditions</label>
            <textarea id="p_medical_conditions" rows="2" placeholder="List any medical conditions...">${escapeHtml(med.medical_conditions||"")}</textarea>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Medication</label>
            <textarea id="p_medication" rows="2" placeholder="List any current medication...">${escapeHtml(med.medication||"")}</textarea>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Consent Signed</label>
            <select id="p_consent_signed">
              <option value="">Select...</option>
              <option value="Yes" ${med.consent_signed === 'Yes' ? 'selected' : ''}>Yes</option>
              <option value="No" ${med.consent_signed === 'No' ? 'selected' : ''}>No</option>
            </select>
          </div>
          <div>
            <label>Consent Date</label>
            <input type="date" id="p_consent_date" value="${med.consent_date ? med.consent_date.split('T')[0] : ''}" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Indemnity Signed (Read Only)</label>
            <input type="text" value="${escapeHtml(med.indemnity_signed||'Not Set')}" readonly style="background: #f3f4f6; cursor: not-allowed;" />
          </div>
          <div>
            <label>Media Release Signed (Read Only)</label>
            <input type="text" value="${escapeHtml(med.media_release_signed||'Not Set')}" readonly style="background: #f3f4f6; cursor: not-allowed;" />
          </div>
        </div>
        <div class="btnbar" style="margin-top: 15px;">
          <button class="btn primary" onclick="saveMedicalData()" type="button">Save Medical Data</button>
        </div>
      `;

      const prow = (points.length ? points : [{}]).map(p => `
        <tr>
          <td>${escapeHtml(p.season||"")}</td>
          <td>${escapeHtml(p.event||"")}</td>
          <td>${escapeHtml(p.round||"")}</td>
          <td>${escapeHtml(p.class||"")}</td>
          <td>${escapeHtml(p.total_points||"")}</td>
          <td>${escapeHtml(p.notes||"")}</td>
        </tr>
      `).join("");

      document.getElementById("p_pointsTable").innerHTML = `
        <table class="table">
          <thead><tr><th>Season</th><th>Event</th><th>Round</th><th>Class</th><th>Total</th><th>Notes</th></tr></thead>
          <tbody>${prow}</tbody>
        </table>
      `;

      // Keep buttons enabled - user is still logged in
      // Do NOT disable buttons when switching tabs
      
      // Load events data
      loadDriverEvents(d.driver_id);
      
      // Load points data
      loadDriverPoints(d.driver_id, d.class, d.championship);
      
      // Load notifications
      loadNotificationHistory();
      
      // Update the Next Race status box
      updateNextRaceBox(d);
    }

    // Function to save medical data
    async function saveMedicalData() {
      const btn = event.target;
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Saving...';
      
      try {
        const medicalData = {
          driver_id: currentProfile.driver.driver_id,
          allergies: document.getElementById('p_allergies')?.value || '',
          medical_conditions: document.getElementById('p_medical_conditions')?.value || '',
          medication: document.getElementById('p_medication')?.value || '',
          consent_signed: document.getElementById('p_consent_signed')?.value || '',
          consent_date: document.getElementById('p_consent_date')?.value || null
        };
        
        const response = await fetch('/api/medical-consent', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(medicalData)
        });
        
        if (!response.ok) {
          throw new Error('Failed to save medical data');
        }
        
        const result = await response.json();
        
        if (result.success) {
          btn.textContent = '\u2713 Saved!';
          btn.style.background = 'var(--spring)';
          setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = '';
            btn.disabled = false;
          }, 2000);
        } else {
          throw new Error(result.error?.message || 'Failed to save');
        }
      } catch (error) {
        console.error('Error saving medical data:', error);
        btn.textContent = '\u2717 Failed';
        btn.style.background = '#ef4444';
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = '';
          btn.disabled = false;
        }, 2000);
      }
    }

    // Function to load driver's registered events
    async function loadDriverEvents(driverId) {
      const container = document.getElementById('p_eventsBlock');
      if (!container) return;
      
      // Show skeleton screen
      container.innerHTML = `
        <div class="skeleton-container">
          <div class="skeleton skeleton-text-large" style="width: 40%;"></div>
          <div class="skeleton skeleton-table-row"></div>
          <div class="skeleton skeleton-table-row"></div>
          <div class="skeleton skeleton-table-row"></div>
          <div class="skeleton skeleton-table-row"></div>
        </div>
      `;
      
      try {
        const response = await fetch(`/api/driver-events/${driverId}`, {
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) {
          throw new Error('Failed to load events');
        }
        
        const data = await response.json();
        
        if (!data.success || !data.events || data.events.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: var(--muted);">
              <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></div>
              <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No Events Yet</div>
              <div style="font-size: 14px;">You haven't registered for any events. Visit the Events page to register!</div>
              <button onclick="window.location.href='index.html#events'" style="margin-top: 20px; padding: 12px 24px; background: var(--spring); color: white; border: none; border-radius: var(--radius); font-weight: 600; cursor: pointer;">Browse Events</button>
            </div>
          `;
          return;
        }
        
        // Build events table
        const eventsHtml = data.events.map(event => {
          const statusColors = {
            'confirmed': { bg: '#dcfce7', text: '#16a34a', label: ' Confirmed', glow: '#22c55e' },
            'pending': { bg: '#fef3c7', text: '#d97706', label: ' Pending', glow: '#f59e0b' },
            'cancelled': { bg: '#fee2e2', text: '#dc2626', label: ' Cancelled', glow: '#ef4444' },
            'submitted': { bg: '#dbeafe', text: '#2563eb', label: ' Submitted', glow: '#3b82f6' }
          };
          
          const paymentColors = {
            'Completed': { text: '#16a34a', icon: '' },
            'Pending': { text: '#d97706', icon: '' },
            'Failed': { text: '#dc2626', icon: '' }
          };
          
          const status = statusColors[event.entry_status?.toLowerCase()] || statusColors['pending'];
          const payment = paymentColors[event.payment_status] || paymentColors['Pending'];
          
          // Check if event is in the past
          const isPast = event.event_date && new Date(event.event_date) < new Date();
          const glowColor = isPast ? '#6b7280' : status.glow;
          const rowBg = isPast ? 'rgba(107, 114, 128, 0.05)' : 'rgba(255,255,255,0.03)';
          const hoverBg = isPast ? 'rgba(107, 114, 128, 0.1)' : 'rgba(255,255,255,0.08)';
          
          const eventDate = event.event_date ? new Date(event.event_date).toLocaleDateString('en-ZA', { 
            day: '2-digit', month: 'short' 
          }) : 'TBA';
          
          return `
            <tr style="border-bottom: 1px solid rgba(255,255,255,0.08); border-left: 4px solid ${glowColor}; background: ${rowBg}; transition: all 0.2s;" onmouseover="this.style.background='${hoverBg}'; this.style.transform='translateX(4px)'" onmouseout="this.style.background='${rowBg}'; this.style.transform='translateX(0)'">
              <td data-label="Event" style="padding: 12px 8px;">
                <div style="font-weight: 600; color: ${isPast ? '#6b7280' : '#ffffff'}; font-size: 14px;">${escapeHtml(event.event_name || 'Event')}${isPast ? ' <span style="font-size: 11px; color: #6b7280; font-weight: 400;">(Past)</span>' : ''}</div>
              </td>
              <td data-label="Date" style="padding: 12px 8px; white-space: nowrap;">
                <div style="font-size: 13px; color: ${isPast ? '#6b7280' : '#9ca3af'};">${eventDate}</div>
              </td>
              <td data-label="Location" style="padding: 12px 8px;">
                <div style="font-size: 13px; color: ${isPast ? '#6b7280' : '#9ca3af'};">${escapeHtml(event.location || 'TBA')}</div>
              </td>
              <td data-label="Status" style="padding: 12px 8px; text-align: center;">
                <div style="display: inline-block; padding: 4px 10px; background: ${isPast ? 'rgba(107, 114, 128, 0.2)' : status.glow}; color: #ffffff; font-size: 11px; font-weight: 700; border-radius: 4px; white-space: nowrap; box-shadow: 0 0 8px ${isPast ? 'rgba(107, 114, 128, 0.3)' : `${status.glow}80`};">
                  ${isPast ? ' Past' : status.label}
                </div>
              </td>
              <td data-label="Payment" style="padding: 12px 8px; text-align: center;">
                <div style="color: ${isPast ? '#6b7280' : payment.text}; font-size: 14px; font-weight: 600;">
                  ${payment.icon} ${event.payment_status || 'Pending'}
                </div>
              </td>
              <td data-label="Class" style="padding: 12px 8px; text-align: center;">
                <div style="font-weight: 600; color: ${isPast ? '#6b7280' : '#ffffff'}; font-size: 13px;">${escapeHtml(event.race_class || 'N/A')}</div>
              </td>
              <td data-label="Race #" style="padding: 12px 8px; text-align: center;">
                <div style="font-weight: 600; color: ${isPast ? '#6b7280' : '#9ca3af'}; font-size: 13px;">${event.race_number ? '#' + escapeHtml(event.race_number) : '-'}</div></div>
              </td>
            </tr>
          `;
        }).join('');
        
        container.innerHTML = `
          <div style="margin-bottom: 16px; padding: 12px 16px; background: #000000; border-radius: var(--radius); border: 2px solid #3b82f6; box-shadow: 0 0 20px rgba(59, 130, 246, 0.4); display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 18px;"></span>
            <div style="font-size: 14px; color: #3b82f6; font-weight: 600;">
              You have <strong>${data.events.length}</strong> event registration${data.events.length !== 1 ? 's' : ''}
            </div>
          </div>
          <div style="overflow-x: auto;">
            <table class="table" style="width: 100%; border-collapse: collapse; background: #000000; border-radius: var(--radius); box-shadow: var(--shadow);">
              <thead>
                <tr style="background: rgba(255,255,255,0.05); border-bottom: 2px solid rgba(255,255,255,0.1);">
                  <th style="padding: 12px 8px; text-align: left; font-weight: 700; color: #ffffff; font-size: 12px; text-transform: uppercase;">Event</th>
                  <th style="padding: 12px 8px; text-align: left; font-weight: 700; color: #ffffff; font-size: 12px; text-transform: uppercase;">Date</th>
                  <th style="padding: 12px 8px; text-align: left; font-weight: 700; color: #ffffff; font-size: 12px; text-transform: uppercase;">Location</th>
                  <th style="padding: 12px 8px; text-align: center; font-weight: 700; color: #ffffff; font-size: 12px; text-transform: uppercase;">Status</th>
                  <th style="padding: 12px 8px; text-align: center; font-weight: 700; color: #ffffff; font-size: 12px; text-transform: uppercase;">Payment</th>
                  <th style="padding: 12px 8px; text-align: center; font-weight: 700; color: #ffffff; font-size: 12px; text-transform: uppercase;">Class</th>
                  <th style="padding: 12px 8px; text-align: center; font-weight: 700; color: #ffffff; font-size: 12px; text-transform: uppercase;">Race #</th>
                </tr>
              </thead>
              <tbody>
                ${eventsHtml}
              </tbody>
            </table>
          </div>
        `;
        
      } catch (error) {
        console.error('Error loading driver events:', error);
        container.innerHTML = `
          <div style="text-align: center; padding: 40px 20px; color: var(--muted);">
            <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></div>
            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Failed to Load Events</div>
            <div style="font-size: 14px;">Unable to load your event registrations. Please try again later.</div>
          </div>
        `;
      }
    }

    // Function to load driver's points standings and history
    async function loadDriverPoints(driverId, driverClass, driverChampionship) {
      const container = document.getElementById('p_pointsTable');
      if (!container) return;
      
      // Show skeleton screen
      container.innerHTML = `
        <div class="skeleton-container">
          <div style="display: flex; gap: 16px; margin-bottom: 24px;">
            <div class="skeleton skeleton-card" style="flex: 1;"></div>
            <div class="skeleton skeleton-card" style="flex: 1;"></div>
          </div>
          <div class="skeleton skeleton-text-large" style="width: 30%; margin-bottom: 16px;"></div>
          <div class="skeleton skeleton-table-row"></div>
          <div class="skeleton skeleton-table-row"></div>
          <div class="skeleton skeleton-table-row"></div>
        </div>
      `;
      
      try {
        const response = await fetch(`/api/driver-points/${driverId}`, {
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) {
          throw new Error('Failed to load points');
        }
        
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.error || 'Failed to load points');
        }
        
        // If no points data
        if (!data.points || data.points.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: var(--muted);">
              <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></div>
              <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No Points Yet</div>
              <div style="font-size: 14px;">Your championship points will appear here after races are completed and results are published.</div>
            </div>
          `;
          return;
        }
        
        // Build season summary cards
        const seasonCards = data.seasonTotals.map(season => {
          const avgPoints = season.races_completed > 0 ? (season.total_points / season.races_completed).toFixed(1) : '0.0';
          
          return `
            <div style="flex: 1; min-width: 0; max-width: 100%; padding: 20px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 8px; border: 2px solid #f59e0b; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">
              <div style="font-size: 28px; font-weight: 800; color: #92400e; margin-bottom: 4px;">${escapeHtml(season.total_points || 0)}</div>
              <div style="font-size: 11px; font-weight: 700; color: #b45309; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px;">Total Points</div>
              <div style="display: flex; justify-content: space-between; padding-top: 12px; border-top: 1px solid #fbbf2480;">
                <div>
                  <div style="font-size: 18px; font-weight: 700; color: #92400e;">${escapeHtml(season.races_completed)}</div>
                  <div style="font-size: 10px; color: #b45309;">Races</div>
                </div>
                <div>
                  <div style="font-size: 18px; font-weight: 700; color: #92400e;">${avgPoints}</div>
                  <div style="font-size: 10px; color: #b45309;">Avg/Race</div>
                </div>
              </div>
              <div style="margin-top: 8px; font-size: 12px; font-weight: 600; color: #78350f;">
                ${escapeHtml(season.season)}  ${escapeHtml(season.class)}
              </div>
            </div>
          `;
        }).join('');
        
        // Build points history table with breakdown
        const pointsRows = data.points.map((point, index) => {
          const rowBg = index % 2 === 0 ? '#f9fafb' : 'white';
          const totalColor = point.total_points >= 25 ? '#16a34a' : point.total_points >= 15 ? '#d97706' : '#6b7280';
          
          return `
            <tr style="border-bottom: 1px solid #e5e7eb; background: ${rowBg}; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='${rowBg}'">
              <td style="padding: 12px 8px;">
                <div style="font-weight: 600; color: var(--ink); font-size: 14px;">${escapeHtml(point.event || 'Event')}</div>
                <div style="font-size: 11px; color: var(--muted); margin-top: 2px;">Round ${escapeHtml(point.round || 'N/A')}</div>
              </td>
              <td style="padding: 12px 8px; text-align: center;">
                <div style="font-size: 13px; color: var(--muted);">${escapeHtml(point.class || '-')}</div>
              </td>
              <td style="padding: 12px 8px; text-align: center;">
                <div style="font-size: 13px; color: var(--muted);">${point.qualifying_points || '-'}</div>
              </td>
              <td style="padding: 12px 8px; text-align: center;">
                <div style="font-size: 13px; color: var(--muted);">${point.heat1_points || '-'}</div>
              </td>
              <td style="padding: 12px 8px; text-align: center;">
                <div style="font-size: 13px; color: var(--muted);">${point.heat2_points || '-'}</div>
              </td>
              <td style="padding: 12px 8px; text-align: center;">
                <div style="font-size: 13px; color: var(--muted);">${point.final_points || '-'}</div>
              </td>
              <td style="padding: 12px 8px; text-align: center;">
                <div style="font-size: 13px; color: #dc2626;">${point.penalties_points || '-'}</div>
              </td>
              <td style="padding: 12px 8px; text-align: center;">
                <div style="font-size: 16px; font-weight: 700; color: ${totalColor};">${point.total_points || 0}</div>
              </td>
              <td style="padding: 12px 8px; text-align: center;">
                <div style="display: inline-block; padding: 4px 10px; background: #dbeafe; color: #1e40af; font-size: 12px; font-weight: 700; border-radius: 4px;">
                  ${point.position || '-'}
                </div>
              </td>
            </tr>
          `;
        }).join('');
        
        container.innerHTML = `
          <div style="margin-bottom: 24px;">
            <div style="display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 24px;">
              ${seasonCards}
            </div>
            
            ${data.seasonTotals.length > 0 ? `
            <div style="padding: 16px; background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%); border-radius: 8px; border-left: 4px solid #0ea5e9; margin-bottom: 24px;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <span style="font-size: 20px;"></span>
                <div style="font-weight: 700; color: #0c4a6e; font-size: 15px;">Season Summary</div>
              </div>
              <div style="font-size: 13px; color: #0c4a6e; line-height: 1.6;">
                You're competing in <strong>${escapeHtml(driverClass || 'N/A')}</strong> for the <strong>${escapeHtml(driverChampionship || 'Championship')}</strong>. 
                Keep racing to climb the standings!
              </div>
            </div>
            ` : ''}
          </div>
          
          <div style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 16px; font-weight: 700; color: var(--ink);">Race Results Breakdown</h3>
            <div style="font-size: 12px; color: var(--muted);">${data.points.length} result${data.points.length !== 1 ? 's' : ''}</div>
          </div>
          
          <div style="overflow-x: auto;">
            <table class="table" style="width: 100%; border-collapse: collapse; background: #0a0a0a; border-radius: 8px; box-shadow: var(--shadow);">
              <thead>
                <tr style="background: #0f0f0f; border-bottom: 2px solid #1f1f1f;">
                  <th style="padding: 12px 8px; text-align: left; font-weight: 700; color: var(--ink); font-size: 11px; text-transform: uppercase;">Event</th>
                  <th style="padding: 12px 8px; text-align: center; font-weight: 700; color: var(--ink); font-size: 11px; text-transform: uppercase;">Class</th>
                  <th style="padding: 12px 8px; text-align: center; font-weight: 700; color: var(--ink); font-size: 11px; text-transform: uppercase;">Quali</th>
                  <th style="padding: 12px 8px; text-align: center; font-weight: 700; color: var(--ink); font-size: 11px; text-transform: uppercase;">Heat 1</th>
                  <th style="padding: 12px 8px; text-align: center; font-weight: 700; color: var(--ink); font-size: 11px; text-transform: uppercase;">Heat 2</th>
                  <th style="padding: 12px 8px; text-align: center; font-weight: 700; color: var(--ink); font-size: 11px; text-transform: uppercase;">Final</th>
                  <th style="padding: 12px 8px; text-align: center; font-weight: 700; color: var(--ink); font-size: 11px; text-transform: uppercase;">Penalties</th>
                  <th style="padding: 12px 8px; text-align: center; font-weight: 700; color: var(--ink); font-size: 11px; text-transform: uppercase;">Total</th>
                  <th style="padding: 12px 8px; text-align: center; font-weight: 700; color: var(--ink); font-size: 11px; text-transform: uppercase;">Position</th>
                </tr>
              </thead>
              <tbody>
                ${pointsRows}
              </tbody>
            </table>
          </div>
        `;
        
      } catch (error) {
        console.error('Error loading driver points:', error);
        container.innerHTML = `
          <div style="text-align: center; padding: 40px 20px; color: var(--muted);">
            <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></div>
            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Failed to Load Points</div>
            <div style="font-size: 14px;">Unable to load your points data. Please try again later.</div>
          </div>
        `;
      }
    }

    // Function to load and display notification history
    async function loadNotificationHistory() {
      if (!currentDriverId) {
        console.warn('No driver ID available');
        return;
      }
      
      const container = document.getElementById('notificationHistoryList');
      if (!container) return;
      
      // Show skeleton screen
      container.innerHTML = `
        <div class="skeleton-container">
          <div class="skeleton skeleton-card"></div>
          <div class="skeleton skeleton-card"></div>
          <div class="skeleton skeleton-card"></div>
        </div>
      `;
      
      try {
        const response = await fetch(`/api/notifications/${currentDriverId}`, {
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) {
          throw new Error('Failed to load notifications');
        }
        
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.error || 'Failed to load notifications');
        }
        
        // Apply filters
        const typeFilter = document.getElementById('notifFilterType').value;
        const eventFilter = document.getElementById('notifFilterEvent').value;
        
        let notifications = data.notifications || [];
        
        if (typeFilter) {
          notifications = notifications.filter(n => n.notification_type === typeFilter);
        }
        
        if (eventFilter) {
          notifications = notifications.filter(n => n.event_id === eventFilter);
        }
        
        // If no notifications
        if (notifications.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: var(--muted);">
              <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></div>
              <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No Notifications Yet</div>
              <div style="font-size: 14px;">You'll see important updates and announcements here.</div>
            </div>
          `;
          return;
        }
        
        // Build notification cards
        const notifHtml = notifications.map((notif, index) => {
          const typeIcons = {
            'event': '',
            'registration': '',
            'payment': '',
            'general': '',
            'alert': '',
            'success': ''
          };
          
          const typeColors = {
            'event': { bg: '#dbeafe', border: '#3b82f6', text: '#1e40af' },
            'registration': { bg: '#fef3c7', border: '#f59e0b', text: '#92400e' },
            'payment': { bg: '#dcfce7', border: '#22c55e', text: '#166534' },
            'general': { bg: '#f3f4f6', border: '#6b7280', text: '#374151' },
            'alert': { bg: '#fee2e2', border: '#ef4444', text: '#991b1b' },
            'success': { bg: '#d1fae5', border: '#10b981', text: '#065f46' }
          };
          
          const type = notif.notification_type || 'general';
          const icon = typeIcons[type] || '';
          const colors = typeColors[type] || typeColors['general'];
          
          const sentDate = notif.sent_at ? new Date(notif.sent_at).toLocaleDateString('en-ZA', { 
            day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' 
          }) : 'Unknown date';
          
          const isNew = notif.sent_at && (new Date() - new Date(notif.sent_at)) < (24 * 60 * 60 * 1000); // 24 hours
          
          return `
            <div style="padding: 16px; margin-bottom: 12px; background: white; border: 2px solid ${colors.border}; border-left: 6px solid ${colors.border}; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); transition: all 0.2s; position: relative;" 
                 onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)'" 
                 onmouseout="this.style.boxShadow='0 2px 6px rgba(0,0,0,0.05)'; this.style.transform='translateY(0)'">
              
              ${isNew ? `<div style="position: absolute; top: 12px; right: 12px; padding: 4px 10px; background: #ef4444; color: white; font-size: 10px; font-weight: 700; border-radius: 12px; text-transform: uppercase;">NEW</div>` : ''}
              
              <div style="display: flex; align-items: start; gap: 12px;">
                <div style="font-size: 32px; line-height: 1;">${icon}</div>
                <div style="flex: 1;">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <div>
                      <div style="font-weight: 700; color: var(--ink); font-size: 15px; margin-bottom: 4px;">${escapeHtml(notif.title)}</div>
                      <div style="display: flex; gap: 8px; align-items: center;">
                        <div style="display: inline-block; padding: 3px 8px; background: ${colors.bg}; color: ${colors.text}; font-size: 10px; font-weight: 700; border-radius: 4px; text-transform: uppercase;">
                          ${type.replace('_', ' ')}
                        </div>
                        ${notif.event_name ? `<div style="font-size: 11px; color: var(--muted); font-weight: 600;"> ${escapeHtml(notif.event_name)}</div>` : ''}
                      </div>
                    </div>
                  </div>
                  
                  ${notif.body ? `
                  <div style="font-size: 13px; color: var(--muted); line-height: 1.6; margin-bottom: 10px; padding: 12px; background: #f9fafb; border-radius: 6px;">
                    ${escapeHtml(notif.body)}
                  </div>
                  ` : ''}
                  
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                    <div style="font-size: 11px; color: #9ca3af; font-weight: 600;">
                       ${sentDate}
                    </div>
                    ${notif.url ? `
                    <a href="${escapeHtml(notif.url)}" style="padding: 6px 12px; background: ${colors.border}; color: white; font-size: 12px; font-weight: 600; border-radius: 6px; text-decoration: none; transition: all 0.2s;" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">
                      View Details 
                    </a>
                    ` : ''}
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
        // Populate event filter dropdown with unique events
        const eventFilter_ = document.getElementById('notifFilterEvent');
        if (eventFilter_) {
          const uniqueEvents = [...new Set(notifications.map(n => n.event_id).filter(Boolean))];
          const eventOptions = notifications
            .filter((n, i, arr) => n.event_id && arr.findIndex(x => x.event_id === n.event_id) === i)
            .map(n => `<option value="${n.event_id}">${escapeHtml(n.event_name)}</option>`)
            .join('');
          
          eventFilter_.innerHTML = '<option value="">All Events</option>' + eventOptions;
        }
        
        container.innerHTML = `
          <div style="margin-bottom: 16px; padding: 12px 16px; background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%); border-radius: 8px; border: 2px solid #0ea5e9; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 18px;"></span>
            <div style="font-size: 14px; color: #0c4a6e; font-weight: 600;">
              ${notifications.length} notification${notifications.length !== 1 ? 's' : ''}
            </div>
          </div>
          ${notifHtml}
        `;
        
      } catch (error) {
        console.error('Error loading notifications:', error);
        container.innerHTML = `
          <div style="text-align: center; padding: 40px 20px; color: var(--muted);">
            <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></div>
            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Failed to Load Notifications</div>
            <div style="font-size: 14px;">Unable to load your notifications. Please try again later.</div>
          </div>
        `;
      }
    }

    // Function to update the "Next Race" status box based on driver profile
    function updateNextRaceBox(driver) {
      if (!driver) return;
      
      const entryStatus = driver.next_race_entry_status || 'Not Registered';
      const engineStatus = driver.next_race_engine_rental_status || 'No';
      
      // Determine colors and styling
      let boxBg, boxBorder, accentColor, statusText, statusColor;
      
      if (entryStatus === 'Registered' || entryStatus === 'Confirmed') {
        // Green for registered
        boxBg = '#000000';
        boxBorder = '#22c55e';
        accentColor = '#22c55e';
        statusText = ' Registered';
        statusColor = '#22c55e';
      } else {
        // Orange for pending or not registered
        boxBg = '#000000';
        boxBorder = '#fb923c';
        accentColor = '#fb923c';
        statusText = ' Not Registered';
        statusColor = '#fb923c';
      }
      
      // Update the Next Race box
      const nextRaceBox = document.getElementById('nextRaceBox');
      const statusDot = document.getElementById('nextRaceStatusDot');
      const statusText_ = document.getElementById('nextRaceStatusText');
      const entryStatusDiv = document.getElementById('nextRaceEntryStatus');
      const engineStatusDiv = document.getElementById('nextRaceEngineStatus');
      const accentBar = document.getElementById('nextRaceAccentBar');
      const dateDiv = document.getElementById('nextRaceEntryDate');
      
      if (nextRaceBox) {
        nextRaceBox.style.background = boxBg;
        nextRaceBox.style.borderColor = boxBorder;
      }
      
      if (statusDot) {
        statusDot.style.background = accentColor;
        statusDot.style.boxShadow = `0 0 8px rgba(${accentColor === '#22c55e' ? '34, 197, 94' : '251, 146, 60'}, 0.6)`;
      }
      
      if (statusText_) {
        statusText_.textContent = statusText;
        statusText_.style.color = statusColor;
      }
      
      if (accentBar) {
        accentBar.style.background = accentColor;
      }
      
      // Update entry and engine status displays
      if (entryStatusDiv) {
        if (entryStatus === 'Registered' || entryStatus === 'Confirmed') {
          entryStatusDiv.innerHTML = ' Registered';
          entryStatusDiv.style.color = '#16a34a';
        } else {
          entryStatusDiv.innerHTML = ' Not Registered';
          entryStatusDiv.style.color = '#dc2626';
        }
      }
      
      if (engineStatusDiv) {
        if (engineStatus === 'Yes' || engineStatus === 'Registered') {
          engineStatusDiv.innerHTML = ' Yes';
          engineStatusDiv.style.color = '#16a34a';
        } else {
          engineStatusDiv.innerHTML = ' No';
          engineStatusDiv.style.color = '#dc2626';
        }
      }
      
      // Add timestamp if registered
      if (dateDiv && (entryStatus === 'Registered' || entryStatus === 'Confirmed')) {
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-ZA', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
        const timeStr = now.toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' });
        dateDiv.textContent = ` Entered on ${dateStr} at ${timeStr}`;
        dateDiv.style.color = '#16a34a';
        dateDiv.style.fontWeight = '600';
      }
    }

    // Load available events into View Entries dropdown
    function loadEntriesEventDropdown() {
      const dropdown = document.getElementById('entriesEventSelect');
      if (!dropdown) return;

      fetch('/api/getAvailableEvents')
        .then(response => response.json())
        .then(data => {
          if (data.success && data.data) {
            // Clear existing options
            dropdown.innerHTML = '';
            
            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select an event...';
            dropdown.appendChild(defaultOption);
            
            // Add events from database
            data.data.forEach(event => {
              const option = document.createElement('option');
              option.value = event.event_id;
              const eventDate = new Date(event.event_date).toLocaleDateString('en-ZA');
              option.textContent = `${event.event_name} (${eventDate})`;
              dropdown.appendChild(option);
            });

            // Add event listener for selection
            dropdown.addEventListener('change', (e) => {
              if (e.target.value) {
                loadEventEntries(e.target.value);
              } else {
                document.getElementById('entriesTableContainer').innerHTML = '';
              }
            });
          }
        })
        .catch(error => {
          console.error('Error loading events:', error);
          dropdown.innerHTML = '<option value="">Error loading events</option>';
        });
    }

    // Load and display entries for selected event
    function loadEventEntries(eventId) {
      const container = document.getElementById('entriesTableContainer');
      if (!container) return;

      container.innerHTML = '<p>Loading entries...</p>';

      fetch(`/api/getEventRegistrations/${eventId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success && data.registrations) {
            const entries = data.registrations;
            
            if (entries.length === 0) {
              container.innerHTML = '<p style="color: #999; text-align: center;">No entries for this event yet.</p>';
              return;
            }

            // Create table HTML
            let tableHTML = `
              <table class="table" style="width: 100%;">
                <thead>
                  <tr>
                    <th>Driver Name</th>
                    <th>Email</th>
                    <th>Class</th>
                    <th>Status</th>
                    <th>Entry Date</th>
                    <th>Amount Paid</th>
                  </tr>
                </thead>
                <tbody>
            `;

            entries.forEach(entry => {
              const entryDate = new Date(entry.created_at).toLocaleDateString('en-ZA');
              const driverName = `${entry.driver_first_name || ''} ${entry.driver_last_name || ''}`.trim();
              const email = entry.driver_email || '';
              const driverClass = entry.driver_class || '';
              const status = entry.entry_status || 'Pending';
              const amountPaid = entry.amount_paid || '0';

              tableHTML += `
                <tr>
                  <td>${escapeHtml(driverName)}</td>
                  <td>${escapeHtml(email)}</td>
                  <td>${escapeHtml(driverClass)}</td>
                  <td>${escapeHtml(status)}</td>
                  <td>${escapeHtml(entryDate)}</td>
                  <td>R${parseFloat(amountPaid).toFixed(2)}</td>
                </tr>
              `;
            });

            tableHTML += `
                </tbody>
              </table>
            `;

            container.innerHTML = tableHTML;
          } else {
            container.innerHTML = '<p style="color: #999; text-align: center;">No entries found.</p>';
          }
        })
        .catch(error => {
          console.error('Error loading entries:', error);
          container.innerHTML = '<p style="color: #d32f2f;">Error loading entries. Please try again.</p>';
        });
    }

    function populatePaymentOptions(driverClass) {
      const container = document.getElementById("paymentsContainer");
      if (!container) return;

      let html = `
        <div style="padding: 20px; text-align: center; color: #6b7280;">
          <p style="margin: 0; font-weight: 600; font-size: 16px;">Registration Not Yet Open</p>
          <p style="margin: 8px 0 0 0; font-size: 14px;">Pricing and entry details will be available soon. Please check back later.</p>
        </div>
      `;

      container.innerHTML = html;
    }

    function handlePayment(title, price, reference) {
      // PayFast Redirect Integration with Payment Tracking
      // Extract amount from price string (e.g., "R3,500" -> 3500)
      const amount = parseFloat(price.replace(/[^\d.]/g, ''));
      
      if (!amount || isNaN(amount)) {
        toast('bad', 'Invalid payment amount');
        return;
      }

      // Get current driver info
      if (!currentEmail || !currentDriverId) {
        toast('bad', 'Please log in to proceed with payment');
        return;
      }

      const firstName = document.getElementById("p_first_name").value || currentEmail.split('@')[0];
      const lastName = document.getElementById("p_last_name").value || '';

      // PayFast merchant details (LIVE CREDENTIALS)
      const merchantId = '18906399';
      const merchantKey = 'fbxpiwtzoh1gg';
      
      // Validate credentials are configured
      if (!merchantId || !merchantKey) {
        toast('bad', ' PayFast credentials not configured. Admin must update merchant ID and key.');
        console.error('PayFast credentials missing');
        return;
      }

      // Store payment reference in localStorage for tracking
      const paymentRef = reference + '_' + Date.now();
      const paymentData = {
        reference: paymentRef,
        title: title,
        amount: amount,
        timestamp: new Date().toISOString()
      };
      
      // Store in localStorage
      try {
        let payments = JSON.parse(localStorage.getItem('pendingPayments') || '[]');
        payments.push(paymentData);
        localStorage.setItem('pendingPayments', JSON.stringify(payments));
      } catch (e) {
        console.warn('Could not store payment to localStorage:', e);
      }

      // Store payment in database
      fetch('/api/storePayment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          driver_id: currentDriverId,
          item_name: title,
          amount: amount,
          reference: paymentRef
        })
      }).then(r => r.json()).then(data => {
        if (data.success) {
          console.log(' Payment stored:', data.data.payment_id);
        } else {
          console.warn(' Failed to store payment:', data.error);
        }
      }).catch(err => console.warn('Error storing payment:', err));

      // Create hidden form for PayFast submission
      const form = document.createElement('form');
      form.method = 'POST';
      // Use LIVE PayFast URL (your credentials are for production)
      form.action = 'https://www.payfast.co.za/eng/process';
      form.style.display = 'none';

      // Determine the notify URL based on environment
      const notifyUrl = `${window.location.protocol}//${window.location.host}/api/payfast-itn`;

      // Build form fields in the order PayFast requires for signature
      const fields = {
        merchant_id: merchantId,
        merchant_key: merchantKey,
        return_url: window.location.origin + '/payment-success.html',
        cancel_url: window.location.origin + '/payment-cancel.html',
        notify_url: notifyUrl,
        name_first: firstName,
        name_last: lastName,
        email_address: currentEmail,
        item_name: title,
        item_description: title,
        amount: amount.toFixed(2),
        m_payment_id: paymentRef,
        custom_str1: currentDriverId
      };

      // Calculate MD5 signature for PayFast
      // Signature = md5(merchant_id + amount + currency + m_payment_id + merchant_key)
      const signatureString = `${merchantId}${amount.toFixed(2)}ZAR${paymentRef}${merchantKey}`;
      const signature = md5(signatureString);

      // Add fields to form
      for (const [key, value] of Object.entries(fields)) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = value;
        form.appendChild(input);
      }

      // Add signature field
      const sigInput = document.createElement('input');
      sigInput.type = 'hidden';
      sigInput.name = 'signature';
      sigInput.value = signature;
      form.appendChild(sigInput);

      // Submit form to PayFast
      document.body.appendChild(form);
      
      toast('good', `Redirecting to PayFast for payment of ${price}...`);
      
      // Submit after brief delay to show toast
      setTimeout(() => {
        form.submit();
      }, 500);
    }

    // Load and display payment history
    function loadPaymentHistory() {
      const container = document.getElementById('paymentHistoryContainer');
      if (!container || !currentDriverId) return;

      fetch('/api/getPaymentHistory', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ driver_id: currentDriverId })
      })
      .then(r => r.json())
      .then(data => {
        if (!data.success || !data.data?.payments || data.data.payments.length === 0) {
          container.innerHTML = '<div style="color: #6b7280; text-align: center; padding: 20px;">No payments yet. Make your first payment to get started.</div>';
          return;
        }

        const payments = data.data.payments;
        const completedPayments = payments.filter(p => p.payment_status === 'Complete');
        const pendingPayments = payments.filter(p => p.payment_status === 'Pending');
        
        const html = `
          <div style="margin-bottom: 16px;">
            <div style="display: flex; gap: 8px; margin-bottom: 16px;">
              <button type="button" class="paymentFilter" data-filter="completed" style="padding: 8px 16px; background: #22c55e; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">Completed (${completedPayments.length})</button>
              <button type="button" class="paymentFilter" data-filter="pending" style="padding: 8px 16px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; display: ${pendingPayments.length > 0 ? 'block' : 'none'};">Pending (${pendingPayments.length})</button>
            </div>
          </div>
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 2px solid var(--border-soft);">
                <th style="text-align: left; padding: 12px; font-weight: 600; color: var(--muted); font-size: 12px;">Date</th>
                <th style="text-align: left; padding: 12px; font-weight: 600; color: var(--muted); font-size: 12px;">Description</th>
                <th style="text-align: left; padding: 12px; font-weight: 600; color: var(--muted); font-size: 12px;">Amount</th>
                <th style="text-align: left; padding: 12px; font-weight: 600; color: var(--muted); font-size: 12px;">Status</th>
              </tr>
            </thead>
            <tbody id="paymentTableBody">
              ${completedPayments.map(p => {
                const date = new Date(p.created_at).toLocaleDateString('en-ZA');
                const statusColor = p.payment_status === 'Complete' ? '#22c55e' : 
                                   p.payment_status === 'Pending' ? '#f59e0b' : '#ef4444';
                const statusIcon = p.payment_status === 'Complete' ? '' : 
                                  p.payment_status === 'Pending' ? '' : '';
                return `
                  <tr style="border-bottom: 1px solid var(--border-soft);" class="payment-row completed">
                    <td style="padding: 12px; font-size: 13px;">${date}</td>
                    <td style="padding: 12px; font-size: 13px;">${p.item_name || 'Payment'}</td>
                    <td style="padding: 12px; font-size: 13px; font-weight: 600;">R${parseFloat(p.amount_gross).toLocaleString('en-ZA', {minimumFractionDigits: 2})}</td>
                    <td style="padding: 12px; font-size: 13px;">
                      <span style="display: inline-block; padding: 4px 8px; border-radius: 3px; background: ${statusColor}20; color: ${statusColor}; font-weight: 600; font-size: 11px;">
                        ${statusIcon} ${p.payment_status}
                      </span>
                    </td>
                  </tr>
                `;
              }).join('')}
              ${pendingPayments.map(p => {
                const date = new Date(p.created_at).toLocaleDateString('en-ZA');
                const statusColor = '#f59e0b';
                const statusIcon = '';
                return `
                  <tr style="border-bottom: 1px solid var(--border-soft); display: none;" class="payment-row pending">
                    <td style="padding: 12px; font-size: 13px;">${date}</td>
                    <td style="padding: 12px; font-size: 13px;">${p.item_name || 'Payment'}</td>
                    <td style="padding: 12px; font-size: 13px; font-weight: 600;">R${parseFloat(p.amount_gross).toLocaleString('en-ZA', {minimumFractionDigits: 2})}</td>
                    <td style="padding: 12px; font-size: 13px;">
                      <span style="display: inline-block; padding: 4px 8px; border-radius: 3px; background: ${statusColor}20; color: ${statusColor}; font-weight: 600; font-size: 11px;">
                        ${statusIcon} Pending
                      </span>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
          <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-soft);">
            <div style="display: flex; justify-content: space-between; font-weight: 600;" id="totalPaymentDisplay">
              <span>Total Payments (Completed):</span>
              <span style="color: var(--spring);">R${(completedPayments.reduce((sum, p) => sum + parseFloat(p.amount_gross), 0)).toLocaleString('en-ZA', {minimumFractionDigits: 2})}</span>
            </div>
          </div>
        `;
        container.innerHTML = html;
        
        // Add filter functionality
        const filterButtons = container.querySelectorAll('.paymentFilter');
        filterButtons.forEach(btn => {
          btn.addEventListener('click', function() {
            const filter = this.dataset.filter;
            filterButtons.forEach(b => b.style.opacity = '0.6');
            this.style.opacity = '1';
            
            const rows = container.querySelectorAll('.payment-row');
            rows.forEach(row => {
              row.style.display = row.classList.contains(filter) ? '' : 'none';
            });
            
            if (filter === 'pending') {
              const pendingTotal = pendingPayments.reduce((sum, p) => sum + parseFloat(p.amount_gross), 0);
              document.getElementById('totalPaymentDisplay').innerHTML = `
                <span>Total Payments (Pending):</span>
                <span style="color: var(--autumn);">R${pendingTotal.toLocaleString('en-ZA', {minimumFractionDigits: 2})}</span>
              `;
            } else {
              const completedTotal = completedPayments.reduce((sum, p) => sum + parseFloat(p.amount_gross), 0);
              document.getElementById('totalPaymentDisplay').innerHTML = `
                <span>Total Payments (Completed):</span>
                <span style="color: var(--spring);">R${completedTotal.toLocaleString('en-ZA', {minimumFractionDigits: 2})}</span>
              `;
            }
          });
        });
      })
      .catch(err => {
        console.error('Error loading payment history:', err);
        container.innerHTML = '<div style="color: #ef4444; padding: 12px;">Error loading payment history</div>';
      });
    }

    // ====== POOL ENGINE RENTAL SECTION ======
    function loadPoolEngineRentals() {
      const container = document.getElementById('paymentsContainer');
      if (!container || !currentDriverId) return;

      // Get driver's class - should be available in the portal context
      const driverClass = currentDriverData?.class || 'MINI ROK';
      
      // Pricing structure for pool engine rentals
      const pricingStructure = {
        'CADET': [
          { type: 'Full Season Entry', price: 23800, description: 'Full season championship entry' }
        ],
        'MINI ROK': [
          { type: 'Nationals', price: 23200, description: 'National championship (8 events)' },
          { type: 'CT Regionals', price: 23200, description: 'CT Regional events' },
          { type: 'ALL-IN National', price: 75640, description: 'Complete national season package' }
        ],
        'MINI ROK U/10': [
          { type: 'Nationals', price: 23200, description: 'National championship (8 events)' },
          { type: 'CT Regionals', price: 23200, description: 'CT Regional events' },
          { type: 'ALL-IN National', price: 75640, description: 'Complete national season package' }
        ],
        'OK-J': [
          { type: 'Engine Nationals', price: 44000, description: 'Engine rental for nationals' },
          { type: 'Engine Regionals (CT)', price: 44000, description: 'Engine rental for CT regionals' },
          { type: 'ALL-IN Nationals', price: 107760, description: 'Complete nationals package' }
        ],
        'OK-N': [
          { type: 'Engine Nationals', price: 44000, description: 'Engine rental for nationals' },
          { type: 'Engine Regionals (CT)', price: 44000, description: 'Engine rental for CT regionals' },
          { type: 'ALL-IN Nationals', price: 107760, description: 'Complete nationals package' }
        ],
        'KZ2': [
          { type: 'Full Season Entry', price: 23800, description: 'Full season championship entry' }
        ]
      };

      const options = pricingStructure[driverClass] || pricingStructure['MINI ROK'];

      // Fetch existing rentals to show status
      fetch(`/api/getPoolEngineRentals/${currentDriverId}`)
        .then(r => r.json())
        .then(data => {
          const rentals = data.data || [];
          
          // Find the highest priced rental they've paid for
          let highestPaidRental = null;
          let highestPrice = 0;
          
          rentals.forEach(rental => {
            const matchingOption = options.find(opt => opt.type === rental.rental_type);
            if (matchingOption && matchingOption.price > highestPrice) {
              highestPrice = matchingOption.price;
              highestPaidRental = rental;
            }
          });

          let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">';
          
          // If they have a paid rental, only show that one
          if (highestPaidRental) {
            const paidOption = options.find(opt => opt.type === highestPaidRental.rental_type);
            
            html += `
              <div style="background: #000000; border: 3px solid #10b981; border-radius: 8px; padding: 20px; box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <span style="font-size: 24px;"></span>
                  <div style="font-weight: 800; font-size: 16px; color: #10b981; text-transform: uppercase; letter-spacing: 0.05em;">${paidOption.type}</div>
                </div>
                <div style="color: #22c55e; font-size: 13px; margin-bottom: 16px; font-weight: 500;">${paidOption.description}</div>
                <div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 6px; text-align: center;">
                  <div style="color: #10b981; font-weight: 700; font-size: 14px; text-transform: uppercase; letter-spacing: 0.05em;">PAID & REGISTERED</div>
                  <div style="color: #22c55e; font-size: 12px; margin-top: 4px;">You're all set for this rental</div>
                  <div style="color: #4ade80; font-size: 10px; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(16, 185, 129, 0.2); line-height: 1.4;">Stand-alone northern regions races not included: 14 Feb & 7 Sep (Redstar), 11 Apr (VKC)</div>
                </div>
              </div>
            `;
          } else {
            // Show all options if nothing is paid
            options.forEach(option => {
              html += `
                <div style="background: #000000; border: 2px solid rgba(255,255,255,0.15); border-radius: 6px; padding: 16px; box-shadow: 0 0 15px rgba(255,255,255,0.05);">
                  <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px; color: #ffffff;">${option.type}</div>
                  <div style="color: #9ca3af; font-size: 12px; margin-bottom: 12px;">${option.description}</div>
                  <div style="font-size: 18px; font-weight: 700; color: #ef4444; margin-bottom: 12px;">R${option.price.toLocaleString('en-ZA')}</div>
                  <div style="margin-bottom: 12px; font-size: 12px;">
                    <span style="color: #9ca3af; font-weight: 600; font-size: 12px;">Not yet registered</span>
                  </div>
                  <button type="button" class="poolEngineRentalBtn" data-class="${driverClass}" data-type="${option.type}" data-price="${option.price}" style="width: 100%; padding: 10px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; transition: background 0.2s; box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);">
                    Pay Now
                  </button>
                </div>
              `;
            });
          }

          html += '</div>';
          container.innerHTML = html;

          // Hide Season Engine Rental and Season Entry Status if they have a paid rental
          if (highestPaidRental) {
            const seasonEngineSection = document.querySelector('#portalSections .panel [id="p_season_engine_rental_status"]')?.closest('div[style*="padding: 16px"]');
            const seasonEntrySection = document.querySelector('#portalSections .panel [id="p_season_entry_status"]')?.closest('div[style*="padding: 16px"]');
            
            if (seasonEngineSection) {
              seasonEngineSection.style.display = 'none';
            }
            if (seasonEntrySection) {
              seasonEntrySection.style.display = 'none';
            }
          } else {
            // Show them if no rental is paid
            const seasonEngineSection = document.querySelector('#portalSections .panel [id="p_season_engine_rental_status"]')?.closest('div[style*="padding: 16px"]');
            const seasonEntrySection = document.querySelector('#portalSections .panel [id="p_season_entry_status"]')?.closest('div[style*="padding: 16px"]');
            
            if (seasonEngineSection) {
              seasonEngineSection.style.display = 'block';
            }
            if (seasonEntrySection) {
              seasonEntrySection.style.display = 'block';
            }
          }

          // Attach click handlers to payment buttons
          const btns = container.querySelectorAll('.poolEngineRentalBtn:not([disabled])');
          btns.forEach(btn => {
            btn.addEventListener('click', async function() {
              const rentalClass = this.dataset.class;
              const rentalType = this.dataset.type;
              const amount = parseFloat(this.dataset.price);
              
              // Get email from multiple sources: currentDriverData, form input, or contacts
              let emailToUse = currentDriverData?.email;
              
              if (!emailToUse) {
                const emailEl = document.getElementById('p_email');
                if (emailEl && emailEl.value) {
                  emailToUse = emailEl.value;
                }
              }
              
              if (!emailToUse) {
                alert('Email address not found. Please update your profile.');
                return;
              }

              try {
                // Show loading overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                  position: fixed;
                  top: 0;
                  left: 0;
                  width: 100%;
                  height: 100%;
                  background: rgba(0, 0, 0, 0.7);
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  z-index: 9999;
                  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
                  animation: fadeIn 0.3s ease-in;
                `;
                
                const message = document.createElement('div');
                message.style.cssText = `
                  background: white;
                  padding: 40px;
                  border-radius: 12px;
                  text-align: center;
                  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
                  animation: slideInMessage 0.4s ease-out;
                `;
                
                // Add animation styles
                const styleEl = document.createElement('style');
                styleEl.textContent = `
                  @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                  }
                  @keyframes slideInMessage {
                    from { opacity: 0; transform: translateY(-20px); }
                    to { opacity: 1; transform: translateY(0); }
                  }
                `;
                document.head.appendChild(styleEl);
                
                message.innerHTML = `
                  <div style="font-size: 18px; font-weight: 600; color: #111827; margin-bottom: 16px;">Processing Payment</div>
                  <div style="font-size: 14px; color: #6b7280; margin-bottom: 24px;">Redirecting you to PayFast...</div>
                  <div style="
                    width: 40px;
                    height: 40px;
                    border: 4px solid #e5e7eb;
                    border-top-color: #ef4444;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin: 0 auto;
                  "></div>
                  <style>
                    @keyframes spin {
                      to { transform: rotate(360deg); }
                    }
                  </style>
                `;
                
                overlay.appendChild(message);
                document.body.appendChild(overlay);
                
                // Fetch payment form from server
                const params = new URLSearchParams({
                  class: rentalClass,
                  rentalType: rentalType,
                  amount: amount,
                  email: emailToUse,
                  driverId: currentDriverId
                });
                
                const response = await fetch(`/api/initiatePoolEnginePayment?${params}`);
                const htmlForm = await response.text();
                
                // Create a temporary form container and submit
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlForm;
                document.body.appendChild(tempDiv);
                
                const form = tempDiv.querySelector('form');
                if (form) {
                  form.submit();
                  
                  // Close overlay after form submits
                  setTimeout(() => {
                    overlay.remove();
                  }, 500);
                } else {
                  console.error('Form not found in response');
                  overlay.remove();
                  alert('Error initiating payment. Please try again.');
                }
              } catch (err) {
                console.error('Error:', err);
                alert('Error processing payment request');
              }
            });
          });
        })
        .catch(err => {
          console.error('Error loading pool engine rentals:', err);
          container.innerHTML = '<div style="color: #ef4444; padding: 12px;">Error loading rental options</div>';
        });
    }

    function looksLikeEmail_(s){
      const v = String(s || "").trim();
      return v.includes("@") && v.includes(".");
    }

    function showModalError(message) {
      const errorDiv = document.getElementById('modalErrorMessage');
      const errorText = document.getElementById('modalErrorText');
      if (errorDiv && errorText) {
        errorText.textContent = message;
        errorDiv.style.display = 'block';
        // Auto-hide after 5 seconds
        setTimeout(() => {
          errorDiv.style.display = 'none';
        }, 5000);
      }
    }

    function hideModalError() {
      const errorDiv = document.getElementById('modalErrorMessage');
      if (errorDiv) {
        errorDiv.style.display = 'none';
      }
    }

    // Tab switching - ensure elements exist before attaching listeners
    const tabButtons = document.querySelectorAll(".tab");
    console.log("Found", tabButtons.length, "tab buttons");
    tabButtons.forEach(btn=>{
      console.log("Attaching listener to tab button:", btn.dataset.tab);
      btn.addEventListener("click", function(e) {
        console.log("Tab clicked:", this.dataset.tab);
        setMode(this.dataset.tab);
      });
    });

    // Mobile carousel scroll handling
    const carousel = document.querySelector(".tabs-carousel");
    const carouselOptions = document.querySelectorAll(".carousel-option");
    const carouselDots = document.querySelectorAll(".carousel-dot");

    if (carousel) {
      // Snap carousel to options on scroll end
      carousel.addEventListener("scroll", debounce(function() {
        const scrollLeft = carousel.scrollLeft;
        const optionWidth = carouselOptions[0].offsetWidth;
        const index = Math.round(scrollLeft / optionWidth);
        const selectedOption = carouselOptions[Math.min(index, carouselOptions.length - 1)];
        
        if (selectedOption) {
          const mode = selectedOption.dataset.tab;
          setMode(mode);
        }
      }, 200));

      // Carousel option click
      carouselOptions.forEach(option => {
        option.addEventListener("click", function() {
          const mode = this.dataset.tab;
          setMode(mode);
          scrollCarouselToOption(mode);
        });
      });

      // Carousel dot click
      carouselDots.forEach(dot => {
        dot.addEventListener("click", function() {
          const mode = this.dataset.tab;
          setMode(mode);
          scrollCarouselToOption(mode);
        });
      });
    }

    function scrollCarouselToOption(mode) {
      if (!carousel) return;
      const option = document.querySelector(`.carousel-option[data-tab="${mode}"]`);
      if (option) {
        option.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "center" });
      }
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Portal sub-tabs
    document.addEventListener("click", (e)=>{
      const p = e.target.closest(".ptab");
      if(p) {
        setPortalTab(p.dataset.ptab);
        return;
      }
      
      const fab = e.target.closest(".portalTab-fab");
      if(fab) {
        const menu = document.querySelector(".portalTab-menu");
        if(menu) menu.classList.toggle("expanded");
        return;
      }

      const option = e.target.closest(".portalTab-option");
      if(option) {
        setPortalTab(option.dataset.ptab);
        return;
      }

      // Close menu if clicking backdrop
      const backdrop = e.target.closest(".portalTab-menu-backdrop");
      if(backdrop) {
        const menu = document.querySelector(".portalTab-menu");
        if(menu) menu.classList.remove("expanded");
        return;
      }
    });

    /* LOGIN (Email + Password) */
    document.getElementById("btnLogin").addEventListener("click", async ()=>{
      const btn = document.getElementById("btnLogin");

      try{
        toast("", "");

        const email = document.getElementById("login_identifier").value.trim().toLowerCase();
        const password = document.getElementById("login_password").value.trim();

        if(!email || !email.includes("@")) throw new Error("Enter your email address.");
        if(!password) throw new Error("Enter your password.");

        // Immediate acknowledgement
        setButtonLoading_(btn, true, "Login");
        setStatusCard_({
          chipText: "Authenticating",
          chipKind: "wait",
          driver: "",
          klass: "",
          ident: email,
          status: "",
          note: "Request received. Verifying credentials and loading your portal",
          spinner: true
        });

        const minDwellMs = 650;
        const t0 = Date.now();

        // Call new loginWithPassword endpoint
        const profile = await api('loginWithPassword', { email, password });
        
        // Try to get driver_id from profile.driver or profile.driver_id or profile.id
        let driverId = "";
        if (profile && profile.driver && profile.driver.driver_id) {
          driverId = String(profile.driver.driver_id);
        } else if (profile && profile.driver_id) {
          driverId = String(profile.driver_id);
        } else if (profile && profile.id) {
          driverId = String(profile.id);
        }
        
        window.currentDriverId = driverId;
        currentDriverId = driverId;  // Keep local scope version too for backwards compatibility
        
        currentEmail = email;
        currentPassword = password;
        // Generate and store driver token
        currentToken = 'driver-token-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('driverToken', currentToken);
        // Save login credentials for session persistence
        localStorage.setItem('driverEmail', email);
        localStorage.setItem('driverPassword', password);

        const elapsed = Date.now() - t0;
        if(elapsed < minDwellMs){
          await new Promise(r => setTimeout(r, minDwellMs - elapsed));
        }

        currentProfile = profile;
        renderPortal(profile, email);
        document.body.classList.add('logged-in'); // Show mobile logged-in state
        toast("good", "Login successful. Portal loaded.");
      }catch(err){
        setStatusCard_({
          chipText: "Login failed",
          chipKind: "bad",
          driver: "",
          klass: "",
          ident: document.getElementById("login_identifier").value.trim() || "",
          status: "",
          note: err.message || "Unable to log in."
        });
        toast("bad", err.message || "Unable to log in.");
        clearPortal();
      }finally{
        setButtonLoading_(btn, false, "Login");
      }
    });

    /* FORGOT PASSWORD */
    document.getElementById("forgotPasswordLink").addEventListener("click", (e) => {
      const modal = document.getElementById("forgotPasswordModal");
      const msgEl = document.getElementById("forgotMessage");
      const emailEl = document.getElementById("forgotEmail");
      
      // Reset modal state
      emailEl.value = "";
      msgEl.style.display = "none";
      msgEl.textContent = "";
      msgEl.className = "";
      
      // Show modal
      modal.style.display = "flex";
    });

    document.getElementById("btnCloseForgot").addEventListener("click", () => {
      document.getElementById("forgotPasswordModal").style.display = "none";
    });

    // Close modal when clicking outside
    document.getElementById("forgotPasswordModal").addEventListener("click", (e) => {
      if (e.target.id === "forgotPasswordModal") {
        document.getElementById("forgotPasswordModal").style.display = "none";
      }
    });

    document.getElementById("btnSendReset").addEventListener("click", async () => {
      const btn = document.getElementById("btnSendReset");
      const emailEl = document.getElementById("forgotEmail");
      const msgEl = document.getElementById("forgotMessage");
      const email = emailEl.value.trim().toLowerCase();

      try {
        if (!email || !email.includes("@")) {
          throw new Error("Please enter a valid email address.");
        }

        setButtonLoading_(btn, true, "Send Reset Link");
        msgEl.style.display = "none";

        // Call server
        await api("requestPasswordReset", { email });

        // Show success message
        msgEl.style.display = "block";
        msgEl.className = "hint" + " good";
        msgEl.style.padding = "12px";
        msgEl.style.borderRadius = "4px";
        msgEl.style.backgroundColor = "#d4edda";
        msgEl.style.color = "#155724";
        msgEl.style.border = "1px solid #c3e6cb";
        msgEl.textContent = "Check your email for a password reset link. It will expire in 24 hours.";

        emailEl.value = "";
      } catch (err) {
        msgEl.style.display = "block";
        msgEl.className = "hint" + " bad";
        msgEl.style.padding = "12px";
        msgEl.style.borderRadius = "4px";
        msgEl.style.backgroundColor = "#f8d7da";
        msgEl.style.color = "#721c24";
        msgEl.style.border = "1px solid #f5c6cb";
        msgEl.textContent = err.message || "Failed to send reset link.";
      } finally {
        setButtonLoading_(btn, false, "Send Reset Link");
      }
    });

    // Allow Enter key to send reset
    document.getElementById("forgotEmail").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        document.getElementById("btnSendReset").click();
      }
    });

    // Enter key to login
    ["login_identifier","login_pin"].forEach(id=>{
      const el = document.getElementById(id);
      if(el){
        el.addEventListener("keydown", (e)=>{
          if(e.key === "Enter"){
            e.preventDefault();
            document.getElementById("btnLogin").click();
          }
        });
      }
    });

    document.getElementById("btnLogout").addEventListener("click", ()=>{
      document.getElementById("login_identifier").value = "";
      document.getElementById("login_password").value = "";
      // Clear saved credentials for persistent login
      localStorage.removeItem('driverEmail');
      localStorage.removeItem('driverPassword');
      localStorage.removeItem('driverToken');
      clearPortal();
      toast("good", "Logged out.");
    });
    
    // Portal Status logout button (moved from bottom action buttons) - only if element exists
    const btnStatusLogout = document.getElementById("btnStatusLogout");
    if (btnStatusLogout) {
      btnStatusLogout.addEventListener("click", ()=>{
        document.getElementById("btnLogout").click();
      });
    }

    /* SAVE PROFILE */
    /* SEND REQUEST TO ADMIN */
    document.getElementById("btnSendRequest").addEventListener("click", async () => {
      const btn = document.getElementById("btnSendRequest");
      try {
        toast("", "");
        if (!currentEmail) throw new Error("Not logged in.");

        const name = document.getElementById("reqName").value.trim();
        const email = document.getElementById("reqEmail").value.trim();
        const phone = document.getElementById("reqPhone").value.trim();
        const subject = document.getElementById("reqSubject").value.trim();
        const message = document.getElementById("reqMessage").value.trim();

        if (!subject) throw new Error("Please enter a subject.");
        if (!message) throw new Error("Please enter a message.");

        setButtonLoading_(btn, true, "Sending...");

        // Send request to backend
        const result = await api('contactAdmin', {
          driver_id: currentDriverId,
          name: name || currentEmail.split('@')[0],
          email: email || currentEmail,
          registered_email: currentEmail,
          phone: phone,
          subject: subject,
          message: message
        });

        toast("good", "Message sent to admin! We'll respond soon.");
        document.getElementById("reqName").value = "";
        document.getElementById("reqEmail").value = "";
        document.getElementById("reqPhone").value = "";
        document.getElementById("reqSubject").value = "";
        document.getElementById("reqMessage").value = "";
      } catch (err) {
        toast("bad", err.message || "Failed to send message.");
      } finally {
        setButtonLoading_(btn, false, "Send to Admin");
      }
    });

    document.getElementById("btnSaveProfile").addEventListener("click", async ()=>{
      const btn = document.getElementById("btnSaveProfile");
      try {
        toast("", "");
        if(!currentEmail || !currentPassword) {
          console.error("Save failed: Not logged in. Email:", currentEmail, "Password set:", !!currentPassword);
          throw new Error("Not logged in.");
        }

        setButtonLoading_(btn, true, "Save Changes");

        const updatedProfile = {
          driver_id: currentDriverId,
          email: currentEmail,
          password: currentPassword,
          first_name: document.getElementById("p_first_name").value.trim(),
          last_name: document.getElementById("p_last_name").value.trim(),
          class: document.getElementById("p_class").value.trim(),
          race_number: document.getElementById("p_race_number").value.trim(),
          license_number: document.getElementById("p_license_number").value.trim(),
          transponder_number: document.getElementById("p_transponder_number").value.trim(),
          kart_brand: document.getElementById("p_kart_brand").value.trim(),
          team_name: document.getElementById("p_team_name").value.trim(),
          coach_name: document.getElementById("p_coach_name").value.trim()
        };

        console.log("Sending save profile request:", updatedProfile);

        // Call server to update profile - WAIT for DB confirmation
        // api() function throws if not successful, so if we get here, save succeeded
        const result = await api('updateDriver', updatedProfile);

        console.log("Profile save result:", result);

        // Only show success AFTER database confirmed
        await showConfirmation("Profile Saved", "Your changes have been saved successfully!");
        
        // Update form with returned driver data (database confirmed data)
        console.log("Updating form with saved data from database...");
        if (result.driver) {
          const d = result.driver;
          currentProfile = d;
          document.getElementById("p_first_name").value = d.first_name || "";
          document.getElementById("p_last_name").value = d.last_name || "";
          document.getElementById("p_class").value = d.class || "";
          document.getElementById("p_race_number").value = d.race_number || "";
          document.getElementById("p_license_number").value = d.license_number || "";
          document.getElementById("p_transponder_number").value = d.transponder_number || "";
          document.getElementById("p_kart_brand").value = d.kart_brand || "";
          document.getElementById("p_team_name").value = d.team_name || "";
          document.getElementById("p_coach_name").value = d.coach_name || "";
          console.log("Form updated with data verified from database", d);
        }
        
        setStatusCard_({
          chipText: "Updated",
          chipKind: "ok",
          driver: `${updatedProfile.first_name} ${updatedProfile.last_name}`,
          klass: updatedProfile.class || "",
          ident: currentEmail,
          status: "Approved",
          note: "Your profile has been saved."
        });
      } catch(err) {
        console.error("Save profile error:", err);
        toast("bad", err.message || "Failed to save profile.");
      } finally {
        setButtonLoading_(btn, false, "Save Changes");
      }
    });

    // Update status card when class is changed
    document.getElementById("p_class").addEventListener("change", function() {
      const selectedClass = this.value;
      const classColor = classColors[selectedClass] || '#9ca3af';
      
      // Update the class display in the status card if logged in
      if (currentProfile && currentProfile.driver) {
        setStatusCard_({
          chipText: "Logged in",
          chipKind: "ok",
          driver: `${currentProfile.driver.first_name || ''} ${currentProfile.driver.last_name || ''}`.trim() || '',
          klass: selectedClass || '',
          ident: currentEmail || currentProfile.driver.driver_id || '',
          status: currentProfile.driver.status || 'Approved',
          note: 'Portal loaded. Use the tabs above to review and manage your information.'
        });
      }
    });



    /* Registration */
    document.getElementById("btnRegister").addEventListener("click", async ()=>{
      try{
        toast("", "");
        const consent = document.getElementById("consent_signed").value === "Y";
        if(!consent) throw new Error("Consent must be accepted.");

        // Validate required ID/Passport
        const idPassport = document.getElementById("r_id").value.trim();
        if(!idPassport) throw new Error("ID / Passport is required.");

        // Optional: license file upload
        let license_b64 = "", license_name = "", license_mime = "";
        const licenseInput = document.getElementById("r_driverLicense");
        if(licenseInput && licenseInput.files && licenseInput.files.length > 0) {
          const licenseFile = licenseInput.files[0];
          license_name = licenseFile.name;
          license_mime = licenseFile.type;
          
          // Convert license to base64
          license_b64 = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(licenseFile);
          });
        }

        // Optional: profile photo upload
        let photo_b64 = "", photo_name = "", photo_mime = "";
        const photoInput = document.getElementById("r_profilePhoto");
        if(photoInput && photoInput.files && photoInput.files.length > 0) {
          const photoFile = photoInput.files[0];
          photo_name = photoFile.name;
          photo_mime = photoFile.type;
          photo_b64 = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(photoFile);
          });
        }

        // Note: Password is set during registration
        // Validate password BEFORE building payload
        const password = document.getElementById("r_password").value.trim();
        const confirmPassword = document.getElementById("r_password_confirm").value.trim();
        if (!password || password.length < 8) {
          throw new Error("Password must be at least 8 characters.");
        }
        if (password !== confirmPassword) {
          throw new Error("Passwords do not match.");
        }
        
        const payload = {
          first_name: document.getElementById("r_first_name").value.trim(),
          last_name: document.getElementById("r_last_name").value.trim(),
          email: document.getElementById("c_email").value.trim(),
          date_of_birth: document.getElementById("r_dob").value.trim(),
          nationality: document.getElementById("r_nat").value.trim(),
          gender: document.getElementById("r_gender").value.trim(),
          id_or_passport_number: document.getElementById("r_id").value.trim(),

          championship: document.getElementById("r_champ").value.trim(),
          class: document.getElementById("r_class").value.trim(),
          race_number: document.getElementById("r_race").value.trim(),
          team_name: document.getElementById("r_team").value.trim(),
          coach_name: document.getElementById("r_coach").value.trim(),
          kart_brand: document.getElementById("r_kart").value.trim(),
          transponder_number: document.getElementById("r_transponder").value.trim(),

          // Contact information
          contact_name: document.getElementById("c_name").value.trim(),
          contact_phone: document.getElementById("c_phone").value.trim(),
          contact_relationship: document.getElementById("c_rel").value.trim() || "Guardian",
          contact_emergency: document.getElementById("c_emergency").value,
          contact_consent: document.getElementById("c_consent").value,

          // Medical information
          medical_allergies: document.getElementById("m_allergies").value.trim(),
          medical_conditions: document.getElementById("m_conditions").value.trim(),
          medical_medication: document.getElementById("m_medication").value.trim(),
          medical_doctor_phone: document.getElementById("m_doctor_phone").value.trim(),
          consent_signed: document.getElementById("consent_signed").value,
          media_release_signed: document.getElementById("media_release_signed").value,

          // File uploads
          license_b64: license_b64,
          license_name: license_name,
          license_mime: license_mime,
          photo_b64: photo_b64,
          photo_name: photo_name,
          photo_mime: photo_mime,

          // Password for account login
          password: password
        };

        // Validate email
        if (!payload.email) {
          console.error('Email is empty!', 'c_email element:', document.getElementById("c_email"), 'value:', document.getElementById("c_email").value);
          throw new Error("Email is required - field appears empty.");
        }

        // Show progress UI
        const btn = document.getElementById("btnRegister");
        if(btn){ btn.classList.add('loading'); btn.disabled = true; }
        document.getElementById("regResult").value = 'Submitting registration...';
        toast("", "Submitting registration...");

        console.log(' Sending registration payload:', {
          first_name: payload.first_name,
          last_name: payload.last_name,
          email: payload.email,
          license_size: payload.license_b64.length,
          photo_size: payload.photo_b64.length,
          payload_size: JSON.stringify(payload).length
        });

        const data = await api("registerDriver", payload);

        console.log(' Registration response:', data);

        document.getElementById("regResult").value =
      `Registration submitted successfully!\n\nDriver ID: ${data.driver_id}\nStatus: Pending\n\nYour account has been created. You can log in with your email and password.\nAn admin will review your registration and contact you if any changes are needed.\n\n${data.message || ""}\n`;

        toast("good", "Registration submitted successfully!");
        if(btn){ btn.classList.remove('loading'); btn.disabled = false; }
      }catch(err){
        console.error(' Registration error:', err);
        toast("bad", err.message || 'Registration failed');
        const btn = document.getElementById("btnRegister");
        if(btn){ btn.classList.remove('loading'); btn.disabled = false; }
      }
    });

    // Championship selector wiring with interactive glow (multi-select enabled)
    document.querySelectorAll('.champ-option').forEach(option => {
      option.addEventListener('click', () => {
        // Toggle selection instead of single-select
        option.classList.toggle('selected');
        
        // Get all selected championships
        const selectedChamps = Array.from(document.querySelectorAll('.champ-option.selected'))
          .map(o => o.dataset.champ)
          .join(', ');
        
        // Update hidden field with comma-separated values
        document.getElementById('r_champ').value = selectedChamps || 'ROK NATS';
        
        // Ensure at least one is always selected
        if (selectedChamps === '') {
          option.classList.add('selected');
          document.getElementById('r_champ').value = option.dataset.champ;
        }
        
        // Also update dropdown if visible (mobile)
        const select = document.getElementById('champ-select');
        if(select && select.multiple) {
          Array.from(select.options).forEach(opt => {
            opt.selected = selectedChamps.includes(opt.value);
          });
        }
      });

      // Interactive radial gradient on mouse move
      option.addEventListener('mousemove', (e) => {
        const rect = option.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 100;
        const y = ((e.clientY - rect.top) / rect.height) * 100;
        option.style.setProperty('--x', x + '%');
        option.style.setProperty('--y', y + '%');
      });
    });

    // Championship dropdown wiring (for mobile - multi-select)
    const champSelect = document.getElementById('champ-select');
    if(champSelect) {
      champSelect.addEventListener('change', () => {
        const selectedOptions = Array.from(champSelect.selectedOptions).map(opt => opt.value);
        document.getElementById('r_champ').value = selectedOptions.join(', ');
      });
    }

    // Entrant-same-as-driver checkbox wiring
    const entrantChk = document.getElementById('entrant_same');
    if(entrantChk){
      entrantChk.addEventListener('change', ()=>{
        const checked = entrantChk.checked;
        const rFirst = document.getElementById('r_first_name');
        const rLast = document.getElementById('r_last_name');
        const cName = document.getElementById('c_name');
        const cRel = document.getElementById('c_rel');
        const cEmail = document.getElementById('c_email');
        const cPhone = document.getElementById('c_phone');
        if(checked){
          if(cName && rFirst && rLast) cName.value = (rFirst.value.trim() + ' ' + rLast.value.trim()).trim();
          if(cRel) cRel.value = 'Driver';
          // Only disable name and relationship, NOT email/phone (those are always needed)
          [cName,cRel].forEach(el=>{ if(el) el.disabled = true; });
        } else {
          [cName,cRel].forEach(el=>{ if(el) el.disabled = false; });
        }
      });
    }

    document.getElementById("btnResetReg").addEventListener("click", ()=>{
      [
        "r_first_name","r_last_name","r_dob","r_nat","r_gender","r_id","r_class","r_race","r_team","r_coach","r_kart","r_transponder",
        "c_name","c_rel","c_email","c_phone","m_allergies","m_conditions","m_medication","m_doctor_phone","regResult"
      ].forEach(id => { const el = document.getElementById(id); if(el) el.value = ""; });
      ["r_profilePhoto","r_driverLicense"].forEach(id => { const el = document.getElementById(id); if(el) el.value = ""; });
      document.getElementById("consent_signed").value = "Y";
      document.getElementById("media_release_signed").value = "Y";
      const chk = document.getElementById('entrant_same'); if(chk) chk.checked = false;
      toast("", "");
    });

    // Photo upload disabled  related helper functions removed.
    // JotForm submission removed  replaced with PayFast race entry system via portal

    /* ====== RACE ENTRY MODAL ====== */
    // Define pricing tiers for each class
    const racePricingTiers = {
      'CADET': {
        entry: { name: 'Race Entry', price: 1950 },
        items: [
          { name: 'Engine Rental', price: 0, optional: false, disabled: true, note: 'N/A' },
          { name: 'Controlled Fuel', price: 0, optional: false, disabled: true, note: 'N/A' },
          { name: 'Rent Transponder', price: 250, optional: true },
          { name: 'Tyres', price: 0, optional: true, disabled: true, note: 'N/A' }
        ]
      },
      'MINI ROK U/10': {
        entry: { name: 'Regional Entry', price: 2950 },
        items: [
          { name: 'Engine Rental', price: 3500, optional: false },
          { name: 'Controlled Fuel', price: 405, optional: false },
          { name: 'Tyres (Optional)', price: 3950, optional: true },
          { name: 'Rent Transponder', price: 250, optional: true }
        ]
      },
      'MINI ROK': {
        entry: { name: 'Regional Entry', price: 2950 },
        items: [
          { name: 'Engine Rental', price: 3500, optional: false },
          { name: 'Controlled Fuel', price: 405, optional: false },
          { name: 'Tyres (Optional)', price: 3950, optional: true },
          { name: 'Rent Transponder', price: 250, optional: true }
        ]
      },
      'OK-J': {
        entry: { name: 'Regional Entry', price: 2950 },
        items: [
          { name: 'Engine Rental', price: 6500, optional: false },
          { name: 'Controlled Fuel', price: 720, optional: false },
          { name: 'Tyres (Optional)', price: 4730, optional: true },
          { name: 'Rent Transponder', price: 250, optional: true }
        ]
      },
      'OK-N': {
        entry: { name: 'Regional Entry', price: 2950 },
        items: [
          { name: 'Engine Rental', price: 6500, optional: false },
          { name: 'Controlled Fuel', price: 720, optional: false },
          { name: 'Tyres (Optional)', price: 4730, optional: true },
          { name: 'Rent Transponder', price: 250, optional: true }
        ]
      },
      'KZ2': {
        entry: { name: 'Regional Entry', price: 2950 },
        items: [
          { name: 'Engine Rental', price: 0, optional: false, disabled: true, note: 'N/A' },
          { name: 'Controlled Fuel', price: 0, optional: false, disabled: true, note: 'N/A' },
          { name: 'Tyres (Required)', price: 4730, optional: false },
          { name: 'Rent Transponder', price: 250, optional: true }
        ]
      }
    };

    // Event selection modal
    const eventSelectionModal = document.createElement('div');
    eventSelectionModal.id = 'eventSelectionModal';
    eventSelectionModal.style.cssText = 'display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; padding: 16px; overflow-y: auto; align-items: center; justify-content: center;';
    eventSelectionModal.innerHTML = `
      <div style="background: white; max-width: 600px; margin: 40px auto; border-radius: 8px; box-shadow: 0 20px 25px rgba(0,0,0,0.15); max-height: 90vh; overflow-y: auto;">
        <!-- Header -->
        <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h2 style="margin: 0 0 4px 0; font-size: 20px; font-weight: 700; color: #1f2937;">Select Race Event</h2>
            <div style="font-size: 12px; color: #6b7280;">Choose which race you want to enter</div>
          </div>
          <button type="button" onclick="closeEventSelectionModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;"></button>
        </div>
        
        <!-- Events List -->
        <div style="padding: 20px;">
          <div id="eventsListContainer" style="display: grid; gap: 12px;">
            <div style="padding: 20px; text-align: center; color: #6b7280;">Loading available events...</div>
          </div>
        </div>
        
        <!-- Cancel Button -->
        <div style="padding: 20px; border-top: 1px solid #e5e7eb;">
          <button type="button" onclick="closeEventSelectionModal()" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; background: white; color: #374151; font-weight: 600; border-radius: 6px; cursor: pointer; font-size: 14px;">Cancel</button>
        </div>
      </div>
    `;
    document.body.appendChild(eventSelectionModal);

    const entryModal = document.createElement('div');
    entryModal.id = 'raceEntryModal';
    entryModal.style.cssText = 'display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; padding: 16px; overflow-y: auto; align-items: center; justify-content: center;';
    entryModal.innerHTML = `
      <div style="background: white; max-width: 500px; margin: 40px auto; border-radius: 8px; box-shadow: 0 20px 25px rgba(0,0,0,0.15); max-height: 90vh; overflow-y: auto;">
        <!-- Header -->
        <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h2 style="margin: 0 0 4px 0; font-size: 20px; font-weight: 700; color: #1f2937;">ENTER A RACE</h2>
            <div style="font-size: 12px; color: #6b7280;">Class: <strong id="modalRaceClass">CADET</strong></div>
          </div>
          <button type="button" onclick="closeRaceEntryModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;"></button>
        </div>

        <!-- Error Message -->
        <div id="modalErrorMessage" style="display: none; padding: 16px 20px; background: #fee2e2; border-left: 4px solid #ef4444; margin: 0;">
          <div style="font-size: 14px; color: #991b1b; font-weight: 600;" id="modalErrorText"></div>
        </div>

        <!-- Race Info -->
        <div style="padding: 20px; background: #f0fdf4; border-bottom: 1px solid #e5e7eb;">
          <div style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">EVENT</div>
          <div style="font-size: 18px; font-weight: 700; color: #1f2937;" id="selectedEventName">Loading...</div>
          <div style="font-size: 13px; color: #6b7280; margin-top: 8px;" id="selectedEventLocation"></div>
          <button type="button" onclick="showEventSelectionModal()" style="margin-top: 12px; padding: 6px 12px; background: #e0e7ff; color: #4338ca; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">Change Event</button>
        </div>

        <!-- Entry Items -->
        <div style="padding: 20px;">
          <div style="font-size: 13px; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 16px; letter-spacing: 0.05em;">Entry Details</div>

          <!-- Dynamic Items Container -->
          <div id="entryItemsContainer"></div>

          <!-- Friday Practice Note -->
          <div style="padding: 12px; background: #fef3c7; border: 1px solid #fcd34d; border-radius: 6px; margin-bottom: 16px;">
            <div style="font-size: 12px; color: #92400e; font-weight: 600;"> Friday Practice Fee</div>
            <div style="font-size: 12px; color: #92400e; margin-top: 4px;">Please arrange Friday practice fees directly with track administration.</div>
          </div>

          <!-- Team Code -->
          <div style="margin-bottom: 16px;">
            <label style="font-size: 13px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; display: block; margin-bottom: 6px;">Team Code (Optional)</label>
            <input type="text" id="teamCodeInput" placeholder="Enter team code" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; box-sizing: border-box;" onchange="validateTeamCode()" oninput="validateTeamCode()">
            <div id="codeMessage" style="margin-top: 6px; font-size: 12px; display: none;"></div>
          </div>

          <!-- Total -->
          <div style="padding: 16px; background: #f3f4f6; border-radius: 6px; margin-bottom: 16px;">
            <div id="totalBreakdown"></div>
            <div style="border-top: 2px solid #e5e7eb; padding-top: 8px; display: flex; justify-content: space-between; align-items: center;">
              <span style="font-weight: 700; color: #1f2937;">TOTAL</span>
              <span style="font-size: 18px; font-weight: 700; color: #22c55e;" id="totalPrice">R1,950.00</span>
            </div>
          </div>

          <!-- Action Buttons -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <button type="button" onclick="closeRaceEntryModal()" style="padding: 12px; border: 2px solid #e5e7eb; background: white; color: #374151; font-weight: 600; border-radius: 6px; cursor: pointer; font-size: 14px;">Cancel</button>
            <button type="button" id="proceedToPayment" style="padding: 12px; background: #22c55e; color: white; font-weight: 600; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">Proceed to Payment</button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(entryModal);

    // ============= EVENT SELECTION FUNCTIONS =============
    
    async function loadAvailableEvents() {
      try {
        const response = await fetch('/api/getAvailableEvents');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        if (!data.success || !data.data) throw new Error(data.error || 'No events data');
        
        const events = data.data;
        const eventsListContainer = document.getElementById('eventsListContainer');
        eventsListContainer.innerHTML = '';
        
        if (events.length === 0) {
          eventsListContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #6b7280;">No upcoming events available</div>';
          return;
        }
        
        events.forEach(event => {
          const eventCard = document.createElement('div');
          eventCard.style.cssText = 'border: 1px solid #e5e7eb; border-radius: 6px; padding: 16px; background: #f9fafb; cursor: pointer; transition: all 0.2s;';
          eventCard.onmouseover = () => eventCard.style.background = '#f3f4f6';
          eventCard.onmouseout = () => eventCard.style.background = '#f9fafb';
          
          const eventDate = new Date(event.event_date).toLocaleDateString('en-ZA');
          const deadline = event.registration_deadline ? new Date(event.registration_deadline).toLocaleDateString('en-ZA') : 'N/A';
          
          eventCard.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
              <div>
                <h3 style="margin: 0 0 4px 0; font-size: 16px; font-weight: 700; color: #1f2937;">${event.event_name}</h3>
                <div style="font-size: 13px; color: #6b7280; margin-bottom: 2px;"> ${eventDate}</div>
                <div style="font-size: 13px; color: #6b7280;"> ${event.location || 'TBA'}</div>
              </div>
              <div style="text-align: right; margin-left: 24px;">
                <div style="font-size: 18px; font-weight: 700; color: #22c55e;">R${parseFloat(event.entry_fee).toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Entry Fee</div>
              </div>
            </div>
            <div style="padding-top: 12px; border-top: 1px solid #e5e7eb;">
              <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">Deadline: ${deadline}</div>
              <button type="button" style="width: 100%; padding: 8px; background: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600;">Select Event</button>
            </div>
          `;
          
          eventCard.addEventListener('click', () => {
            selectEvent(event.event_id, event.event_name, event.location);
          });
          
          eventsListContainer.appendChild(eventCard);
        });
      } catch (error) {
        console.error('Error loading events:', error);
        const eventsListContainer = document.getElementById('eventsListContainer');
        eventsListContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #dc2626;">Failed to load events. Please try again.</div>';
      }
    }
    
    function showEventSelectionModal() {
      document.getElementById('eventSelectionModal').style.display = 'flex';
      loadAvailableEvents();
    }
    
    function closeEventSelectionModal() {
      document.getElementById('eventSelectionModal').style.display = 'none';
    }
    
    function selectEvent(eventId, eventName, location) {
      window.selectedEventId = eventId;
      window.selectedEventName = eventName;
      window.selectedEventLocation = location;
      
      // Update race entry modal with selected event
      document.getElementById('selectedEventName').textContent = eventName;
      document.getElementById('selectedEventLocation').textContent = location ? (' ' + location) : '';
      
      closeEventSelectionModal();
      
      // Open race entry modal with proper class initialization
      openRaceEntryModal();
    }
    
    function closeRaceEntryModal() {
      document.getElementById('raceEntryModal').style.display = 'none';
      // Clear discount code when modal closes
      window.appliedDiscountCode = null;
      const codeInput = document.getElementById('teamCodeInput');
      const codeMessage = document.getElementById('codeMessage');
      if (codeInput) codeInput.value = '';
      if (codeMessage) codeMessage.style.display = 'none';
    }

    // Function to validate team/discount code
    async function validateTeamCode() {
      const codeInput = document.getElementById('teamCodeInput');
      const codeMessage = document.getElementById('codeMessage');
      const totalPriceEl = document.getElementById('totalPrice');
      const proceedBtn = document.getElementById('proceedToPayment');
      const code = codeInput.value.trim();
      
      if (!code) {
        codeMessage.style.display = 'none';
        totalPriceEl.style.color = '#22c55e';
        proceedBtn.textContent = 'Proceed to Payment';
        proceedBtn.style.background = '#22c55e';
        window.appliedDiscountCode = null; // Clear discount BEFORE recalculating
        updateRaceTotal();
        return;
      }

      try {
        const response = await fetch('/api/validateDiscountCode', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code: code })
        });
        const data = await response.json();

        if (data.success && data.valid) {
          const discountCode = data.code;
          codeMessage.style.display = 'block';
          codeMessage.style.color = '#22c55e';
          
          // Calculate discount - handle South African format (R6 855,00)
          const totalText = totalPriceEl.textContent;
          // Remove R, remove spaces, replace comma with period
          const cleanedTotal = totalText.replace('R', '').replace(/\s/g, '').replace(',', '.');
          const currentTotal = parseFloat(cleanedTotal);
          let newTotal = currentTotal;
          
          console.log(' Discount Code Applied:');
          console.log('  Code:', discountCode.code);
          console.log('  Type:', discountCode.discount_type);
          console.log('  Value:', discountCode.discount_value);
          console.log('  Total Text:', totalText);
          console.log('  Cleaned:', cleanedTotal);
          console.log('  Current Total (parsed):', currentTotal);
          
          if (discountCode.discount_type === 'free') {
            newTotal = 0;
            codeMessage.textContent = ` ${discountCode.description || 'Valid code'} - Registration fee waived!`;
            proceedBtn.textContent = 'Enter Race';
            proceedBtn.style.background = '#3b82f6';
          } else if (discountCode.discount_type === 'percentage') {
            newTotal = currentTotal * (1 - discountCode.discount_value / 100);
            codeMessage.textContent = ` ${discountCode.description || 'Valid code'} - ${discountCode.discount_value}% discount applied!`;
            proceedBtn.textContent = 'Proceed to Payment';
            proceedBtn.style.background = '#22c55e';
          } else if (discountCode.discount_type === 'fixed') {
            // Handle both positive discounts (500) and negative amounts (-500)
            // If negative, treat as absolute value to subtract
            const discountAmount = Math.abs(discountCode.discount_value);
            newTotal = Math.max(0, currentTotal - discountAmount);
            codeMessage.textContent = ` ${discountCode.description || 'Valid code'} - R${discountAmount.toFixed(2)} discount applied!`;
            proceedBtn.textContent = newTotal === 0 ? 'Enter Race' : 'Proceed to Payment';
            proceedBtn.style.background = newTotal === 0 ? '#3b82f6' : '#22c55e';
          }
          
          totalPriceEl.textContent = `R${newTotal.toFixed(2)}`;
          totalPriceEl.style.color = newTotal === 0 ? '#3b82f6' : '#22c55e';
          
          // Store discount code for later use
          window.appliedDiscountCode = discountCode;
        } else {
          codeMessage.style.display = 'block';
          codeMessage.style.color = '#dc2626';
          codeMessage.textContent = ' ' + (data.message || 'Invalid code');
          totalPriceEl.style.color = '#22c55e';
          proceedBtn.textContent = 'Proceed to Payment';
          proceedBtn.style.background = '#22c55e';
          window.appliedDiscountCode = null;
          updateRaceTotal();
        }
      } catch (err) {
        console.error('Error validating code:', err);
        codeMessage.style.display = 'block';
        codeMessage.style.color = '#dc2626';
        codeMessage.textContent = ' Error validating code';
        window.appliedDiscountCode = null;
        updateRaceTotal();
      }
    }

    // Function to populate modal with correct pricing based on driver class
    function openRaceEntryModal() {
      // Clear any previous errors when opening modal
      hideModalError();
      
      const driverClass = (document.getElementById('p_class') && document.getElementById('p_class').value) || 'CADET';
      const tierConfig = racePricingTiers[driverClass] || racePricingTiers['CADET'];
      
      // Reset team code field when opening modal
      document.getElementById('teamCodeInput').value = '';
      document.getElementById('codeMessage').style.display = 'none';
      
      document.getElementById('modalRaceClass').textContent = driverClass;
      
      // Build entry items HTML
      let itemsHtml = `
        <div style="padding: 16px; border: 2px solid #22c55e; border-radius: 6px; margin-bottom: 12px; background: #f0fdf4; box-shadow: 0 0 12px rgba(34, 197, 94, 0.3);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
            <div style="font-weight: 600; color: #1f2937; font-size: 14px;">${tierConfig.entry.name}</div>
            <div style="font-weight: 700; color: #22c55e; font-size: 14px;">R${tierConfig.entry.price.toLocaleString('en-ZA')}</div>
          </div>
          <div style="font-size: 12px; color: #6b7280;">Base race entry fee</div>
        </div>
      `;
      
      tierConfig.items.forEach((item, idx) => {
        const isDisabled = item.disabled || false;
        const priceDisplay = item.price === 0 ? (item.note || 'N/A') : `R${item.price.toLocaleString('en-ZA')}`;
        
        // Color coding: Blue for required, Red for optional
        const borderColor = item.optional ? '#ef4444' : '#3b82f6';
        const bgColor = item.optional ? '#fef2f2' : '#eff6ff';
        const shadowColor = item.optional ? 'rgba(239, 68, 68, 0.3)' : 'rgba(59, 130, 246, 0.3)';
        const labelColor = item.optional ? 'Optional' : 'Required';
        const labelStyle = item.optional ? 'color: #dc2626;' : 'color: #1d4ed8;';
        
        // Pre-check required (non-optional) items by default
        const checkedAttr = (!item.optional && !isDisabled) ? 'checked' : '';
        
        itemsHtml += `
          <div style="padding: 16px; border: 2px solid ${borderColor}; border-radius: 6px; margin-bottom: 12px; background: ${bgColor}; box-shadow: 0 0 12px ${shadowColor};">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
              <div>
                <div style="font-weight: 600; color: #1f2937; font-size: 14px; margin-bottom: 4px;">${item.name}</div>
                <div style="font-size: 12px; ${labelStyle} font-weight: 600;">${labelColor}</div>
              </div>
              <div style="display: flex; gap: 8px; align-items: center;">
                <div style="font-weight: 700; color: #2563eb; font-size: 14px;">${priceDisplay}</div>
                <input type="checkbox" id="item_${idx}" ${isDisabled ? 'disabled' : ''} ${checkedAttr} onchange="updateRaceTotal()" style="cursor: pointer; width: 18px; height: 18px; ${isDisabled ? 'opacity: 0.5;' : ''}">
              </div>
            </div>
          </div>
        `;
      });
      
      document.getElementById('entryItemsContainer').innerHTML = itemsHtml;
      updateRaceTotal();
      document.getElementById('raceEntryModal').style.display = 'flex';
    }

    // Function to update total price
    function updateRaceTotal() {
      const driverClass = (document.getElementById('p_class') && document.getElementById('p_class').value) || 'CADET';
      const tierConfig = racePricingTiers[driverClass];
      
      let total = tierConfig.entry.price;
      let breakdownHtml = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <span style="color: #6b7280; font-size: 14px;">${tierConfig.entry.name}</span>
          <span style="color: #1f2937; font-weight: 600;">R${tierConfig.entry.price.toLocaleString('en-ZA')}</span>
        </div>
      `;
      
      tierConfig.items.forEach((item, idx) => {
        const checkbox = document.getElementById(`item_${idx}`);
        if (checkbox && checkbox.checked) {
          total += item.price;
          breakdownHtml += `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span style="color: #6b7280; font-size: 14px;">+ ${item.name}</span>
              <span style="color: #1f2937; font-weight: 600;">R${item.price.toLocaleString('en-ZA')}</span>
            </div>
          `;
        }
      });
      
      document.getElementById('totalBreakdown').innerHTML = breakdownHtml;
      
      // Apply discount if one is active
      if (window.appliedDiscountCode) {
        const discountCode = window.appliedDiscountCode;
        let discountedTotal = total;
        
        console.log(' Applying discount:');
        console.log('  Original Total:', total);
        console.log('  Discount Type:', discountCode.discount_type);
        console.log('  Discount Value:', discountCode.discount_value);
        
        if (discountCode.discount_type === 'free') {
          discountedTotal = 0;
          console.log('  Result: FREE (0)');
        } else if (discountCode.discount_type === 'percentage') {
          discountedTotal = total * (1 - discountCode.discount_value / 100);
          console.log('  Calculation:', total, '* (1 -', discountCode.discount_value, '/ 100) =', discountedTotal);
        } else if (discountCode.discount_type === 'fixed') {
          const discountAmount = Math.abs(discountCode.discount_value);
          discountedTotal = Math.max(0, total - discountAmount);
          console.log('  Discount Amount:', discountAmount);
          console.log('  Calculation:', total, '-', discountAmount, '=', discountedTotal);
        }
        
        console.log('  Final Discounted Total:', discountedTotal);
        
        document.getElementById('totalPrice').textContent = 'R' + discountedTotal.toLocaleString('en-ZA', {minimumFractionDigits: 2});
        document.getElementById('totalPrice').style.color = discountedTotal === 0 ? '#3b82f6' : '#22c55e';
      } else {
        document.getElementById('totalPrice').textContent = 'R' + total.toLocaleString('en-ZA', {minimumFractionDigits: 2});
        document.getElementById('totalPrice').style.color = '#22c55e';
      }
    }

    // Show/hide engine rental based on season status
    function updateEngineRentalOption() {
      // Engine rental option handled in openRaceEntryModal()
    }

    // Open entry modal - show event selection first
    document.getElementById('btnQuickEntry').addEventListener('click', function() {
      showEventSelectionModal();
    });

    // Setup race entry modal listeners after a brief delay to ensure DOM is ready
    setTimeout(() => {
      const paymentBtn = document.getElementById('proceedToPayment');
      
      if (paymentBtn) {
        paymentBtn.addEventListener('click', function() {
          const driverClass = (document.getElementById('p_class') && document.getElementById('p_class').value) || 'CADET';
          const teamCode = document.getElementById('teamCodeInput').value;
          const totalPrice = document.getElementById('totalPrice').textContent;
          
          console.log(' Button clicked - totalPrice element textContent:', totalPrice);
          console.log(' Driver class:', driverClass);
          console.log(' Team code:', teamCode);
          
          // Check if required fields are selected
          let hasEngineRental = false;
          let hasControlledFuel = false;
          const tierConfig = racePricingTiers[driverClass];
          const selectedItems = [];
          tierConfig.items.forEach((item, idx) => {
            const checkbox = document.getElementById(`item_${idx}`);
            if (checkbox && checkbox.checked) {
              selectedItems.push(item.name);
              if (item.name.toLowerCase().includes('engine') || item.name.toLowerCase().includes('rental')) {
                hasEngineRental = true;
              }
              if (item.name.toLowerCase().includes('fuel')) {
                hasControlledFuel = true;
              }
            }
          });

          // Check for required fields (Engine Rental and Controlled Fuel for applicable classes)
          const engineItem = tierConfig.items.find(i => i.name.toLowerCase().includes('engine'));
          const fuelItem = tierConfig.items.find(i => i.name.toLowerCase().includes('fuel'));
          
          // Engine rental required if not disabled
          if (engineItem && !engineItem.disabled && !hasEngineRental) {
            showModalError('Engine rental is a required field. Please select engine rental.');
            return;
          }
          
          // Controlled fuel required if not disabled
          if (fuelItem && !fuelItem.disabled && !hasControlledFuel) {
            showModalError('Controlled fuel is a required field. Please select controlled fuel.');
            return;
          }
          
          // Clear any previous errors
          hideModalError();
          
          // Check if valid discount code was entered (free or discounted)
          const appliedDiscount = window.appliedDiscountCode;
          const isFreeEntry = totalPrice === 'R0.00' || totalPrice === 'R 0.00';
          
          if (isFreeEntry && appliedDiscount) {
            // Free registration with discount code
            console.log('Free registration with discount code for class:', driverClass, 'Items:', selectedItems);
            console.log('Event ID:', window.selectedEventId);
            console.log('Driver ID:', window.currentDriverId);
            console.log('Email:', currentEmail);
            console.log('Current Profile:', currentProfile);
            
            // Validate required fields
            if (!window.selectedEventId) {
              showModalError('Missing event ID. Please select an event first.');
              setButtonLoading_(paymentBtn, false, 'Proceed to Payment');
              return;
            }
            if (!window.currentDriverId) {
              showModalError('Missing driver ID. Please refresh and login again.');
              setButtonLoading_(paymentBtn, false, 'Proceed to Payment');
              return;
            }
            if (!currentEmail) {
              showModalError('Missing email. Please refresh and login again.');
              setButtonLoading_(paymentBtn, false, 'Proceed to Payment');
              return;
            }
            
            // Submit free entry via API
            setButtonLoading_(paymentBtn, true, 'Registering...');
            
            fetch('/api/registerFreeRaceEntry', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                eventId: window.selectedEventId,
                driverId: window.currentDriverId,
                raceClass: driverClass,
                selectedItems: selectedItems,
                email: currentEmail,
                firstName: currentProfile?.driver?.first_name || 'Driver',
                lastName: currentProfile?.driver?.last_name || '',
                teamCode: teamCode
              })
            })
            .then(r => r.json())
            .then(data => {
              if (data.success) {
                console.log(' Free race entry successful:', data);
                
                // Increment discount code usage if applied
                if (appliedDiscount && appliedDiscount.code) {
                  fetch('/api/useDiscountCode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: appliedDiscount.code })
                  }).catch(err => console.error('Failed to increment code usage:', err));
                }
                
                toast('good', 'Race entry confirmed! Welcome to the event.');
                document.getElementById('raceEntryModal').style.display = 'none';
                
                // Reload profile from server to get updated engine rental status
                api('getProfile', { email: currentEmail })
                  .then(profileData => {
                    if (profileData && profileData.driver) {
                      currentProfile = profileData;
                      // Re-render portal with updated data
                      renderPortalData(currentProfile);
                      updateNextRaceBox(currentProfile.driver);
                      
                      // Update status card to show registration success
                      setStatusCard_({
                        chipText: "Entry Confirmed",
                        chipKind: "good",
                        driver: `${currentProfile.driver.first_name || ""} ${currentProfile.driver.last_name || ""}`.trim() || "",
                        klass: currentProfile.driver.class || "",
                        ident: currentEmail,
                        status: "Entered for Race",
                        note: `You are registered for ${window.selectedEventName || 'the event'}. Engine rental: ${currentProfile.driver.next_race_engine_rental_status || 'No'}`
                      });
                      
                      // Switch to Entries tab to show updated status
                      setTimeout(() => {
                        const entriesTab = document.querySelector('[data-ptab="payments"]');
                        if (entriesTab) {
                          entriesTab.click();
                        }
                      }, 500);
                    }
                  })
                  .catch(err => {
                    console.error('Failed to reload profile:', err);
                    // Still show success message even if profile reload fails
                  });
              } else {
                toast('bad', data.error || 'Registration failed');
              }
            })
            .catch(err => {
              console.error('Free entry error:', err);
              toast('bad', 'Failed to register: ' + err.message);
            })
            .finally(() => {
              setButtonLoading_(paymentBtn, false, 'Proceed to Payment');
            });
          } else {
            // Proceed to PayFast payment
            if (totalPrice === 'R0.00' || totalPrice === 'R 0.00') {
              console.log('Zero amount for class:', driverClass);
              toast('good', 'Registration confirmed! No payment required.');
              document.getElementById('raceEntryModal').style.display = 'none';
              setTimeout(() => {
                location.reload();
              }, 1000);
            } else {
              console.log('PayFast payment for class:', driverClass, 'Amount raw:', totalPrice);
              const amount = totalPrice.replace('R', '').replace(/\s/g, '').replace(',', '.').trim();
              console.log(' Amount after cleaning:', amount);
              console.log(' selectedItems being sent:', selectedItems);
              console.log(' selectedItems JSON:', JSON.stringify(selectedItems));
              console.log(' selectedItems encoded:', encodeURIComponent(JSON.stringify(selectedItems)));
              toast('info', 'Redirecting to PayFast payment...');
              // Redirect to PayFast payment with driver email, event, driver ID, and selected items
              const itemsParam = encodeURIComponent(JSON.stringify(selectedItems));
              window.location.href = '/api/initiateRacePayment?class=' + encodeURIComponent(driverClass) + '&amount=' + amount + '&email=' + encodeURIComponent(currentEmail) + '&eventId=' + encodeURIComponent(window.selectedEventId) + '&driverId=' + encodeURIComponent(window.currentDriverId) + '&items=' + itemsParam;
            }
          }
        });
      }
    }, 100);

    /* Init */
    
    // Function to determine next race and set background color
    function initializeNextRaceColor() {
      const races = [
        { seasonId: 'northern', date: new Date(2026, 1, 14), color: '#1e40af' },
        { seasonId: 'summer', date: new Date(2026, 2, 20), color: '#facc15' },
        { seasonId: 'northern', date: new Date(2026, 2, 21), color: '#1e40af' },
        { seasonId: 'northern', date: new Date(2026, 2, 22), color: '#1e40af' },
        { seasonId: 'northern', date: new Date(2026, 3, 11), color: '#1e40af' },
        { seasonId: 'autumn', date: new Date(2026, 4, 8), color: '#f97316' },
        { seasonId: 'winter', date: new Date(2026, 6, 10), color: '#0ea5e9' },
        { seasonId: 'northern', date: new Date(2026, 6, 11), color: '#1e40af' },
        { seasonId: 'northern', date: new Date(2026, 6, 12), color: '#1e40af' },
        { seasonId: 'spring', date: new Date(2026, 8, 10), color: '#4ade80' },
        { seasonId: 'northern', date: new Date(2026, 10, 7), color: '#1e40af' }
      ];
      
      const now = new Date();
      const upcoming = races.filter(r => r.date > now).sort((a, b) => a.date - b.date);
      const nextRace = upcoming.length > 0 ? upcoming[0] : races[0];
      
      // Set the background color CSS variable
      document.documentElement.style.setProperty('--bg', nextRace.color);
      document.body.style.background = nextRace.color;
    }
    
    // Initialize background color based on next race
    initializeNextRaceColor();
    
    clearPortal();
    const initial = (location.hash || "").replace("#","").trim();
    if(initial === "portal" || initial === "register"){
      setMode(initial);
    }else{
      setMode(null);
    }

    // Handle password reset token if present in URL (deployed Apps Script can include ?reset_token=...)
    (async function handleResetTokenFromUrl(){
      try{
        const params = new URLSearchParams(location.search || "");
        const token = params.get('reset_token') || params.get('token');
        const driver_id = params.get('driver_id');
        
        if(!token) {
          // normal ping
          api("ping", {}).catch(()=>{});
          return;
        }

        // Build strong password requirement message
        const pwPrompt = 'Enter a new password to reset your account.\n\n' +
          'Requirements:\n' +
          ' At least 8 characters\n' +
          ' At least one uppercase letter (A-Z)\n' +
          ' At least one lowercase letter (a-z)\n' +
          ' At least one number (0-9)\n' +
          ' At least one special character (!@#$%^&*)';
        
        const pw = prompt(pwPrompt);
        if(!pw) { alert('Password reset cancelled.'); return; }

        // call server reset
        const result = await api('resetPassword', { token: token, email: currentEmail || email, newPassword: pw });
        alert('Password reset successful! You can now log in with your email and new password.');
        // remove token from URL
        try { history.replaceState(null,'', location.pathname); } catch(e){}
        // redirect to login
        try { location.hash = '#portal'; } catch(e){}
      }catch(err){
        alert('Password reset failed: ' + (err.message || err));
      }
    })();

    /* ====== MSA LICENSE UPLOAD ====== */
    let selectedMSAFile = null;

    function handleMSAFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Validate file size (max 10MB)
      const maxSize = 10 * 1024 * 1024;
      if (file.size > maxSize) {
        document.getElementById('selectedFileName').textContent = ' File too large (max 10MB)';
        document.getElementById('btnUploadMSA').disabled = true;
        selectedMSAFile = null;
        return;
      }

      selectedMSAFile = file;
      document.getElementById('selectedFileName').textContent = ` ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`;
      document.getElementById('btnUploadMSA').disabled = false;
    }

    async function uploadMSALicense() {
      if (!selectedMSAFile) {
        toast("warn", "Please select a file first");
        return;
      }

      if (!currentDriverId) {
        toast("error", "Not logged in");
        return;
      }

      try {
        const statusDiv = document.getElementById('msaUploadStatus');
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#dbeafe';
        statusDiv.style.color = '#1e40af';
        statusDiv.textContent = 'Uploading...';
        document.getElementById('btnUploadMSA').disabled = true;

        // Read file as base64 using a safer method
        const base64Data = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            const result = reader.result;
            const base64 = result.split(',')[1] || result;
            resolve(base64);
          };
          reader.onerror = () => reject(new Error('File read failed'));
          reader.readAsDataURL(selectedMSAFile);
        });

        const token = localStorage.getItem('driverToken') || currentToken;
        const response = await fetch('/api/uploadMSALicense', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            driver_id: currentDriverId,
            file_name: selectedMSAFile.name,
            file_data: base64Data,
            file_type: selectedMSAFile.type
          })
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
          throw new Error(result.error?.message || 'Upload failed');
        }

        statusDiv.style.background = '#dcfce7';
        statusDiv.style.color = '#166534';
        statusDiv.textContent = ' MSA License uploaded successfully!';
        
        toast("good", "MSA License uploaded successfully!");
        
        // Reset form
        selectedMSAFile = null;
        document.getElementById('msaFileInput').value = '';
        document.getElementById('selectedFileName').textContent = '';
        document.getElementById('btnUploadMSA').disabled = true;

        // Reload MSA documents
        await loadMSADocument();

        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 3000);
      } catch (err) {
        console.error('MSA upload error:', err);
        const statusDiv = document.getElementById('msaUploadStatus');
        statusDiv.style.background = '#fee2e2';
        statusDiv.style.color = '#991b1b';
        statusDiv.textContent = ` ${err.message}`;
        document.getElementById('btnUploadMSA').disabled = false;
        toast("error", err.message);
      }
    }

    async function loadMSADocument() {
      if (!currentDriverId) return;

      try {
        const token = localStorage.getItem('driverToken') || currentToken;
        const response = await fetch(`/api/getMSALicense/${currentDriverId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const result = await response.json();

        if (!result.success || !result.data) {
          document.getElementById('msaDocumentsList').innerHTML = 
            '<div style="color: #6b7280; text-align: center;">No document uploaded yet</div>';
          return;
        }

        const doc = result.data;
        const uploadDate = new Date(doc.upload_date).toLocaleDateString('en-ZA');

        document.getElementById('msaDocumentsList').innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0;">
            <div>
              <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;"> ${doc.file_name}</div>
              <div style="font-size: 12px; color: #6b7280;">Uploaded: ${uploadDate}</div>
              <div style="font-size: 11px; color: #9ca3af; margin-top: 2px;">Size: ${(doc.file_size / 1024).toFixed(2)}KB</div>
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="btn" onclick="downloadMSALicense('${doc.document_id}', '${doc.file_name}')" style="padding: 8px 12px; font-size: 12px;">
                 Download
              </button>
              <button class="btn" onclick="deleteMSALicense('${doc.document_id}')" style="padding: 8px 12px; font-size: 12px; background: #fee2e2; color: #991b1b;">
                 Delete
              </button>
            </div>
          </div>
        `;
      } catch (err) {
        console.error('Error loading MSA document:', err);
        document.getElementById('msaDocumentsList').innerHTML = 
          '<div style="color: #991b1b;">Error loading document</div>';
      }
    }

    async function downloadMSALicense(documentId, fileName) {
      try {
        const token = localStorage.getItem('driverToken') || currentToken;
        const response = await fetch(`/api/downloadMSALicense/${documentId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Download failed');

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.click();
        window.URL.revokeObjectURL(url);

        toast("good", "MSA License downloaded");
      } catch (err) {
        console.error('Download error:', err);
        toast("error", "Download failed");
      }
    }

    async function deleteMSALicense(documentId) {
      if (!confirm('Are you sure you want to delete your MSA License document?')) return;

      try {
        const token = localStorage.getItem('driverToken') || currentToken;
        const response = await fetch('/api/deleteMSALicense', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ document_id: documentId })
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
          throw new Error(result.error?.message || 'Delete failed');
        }

        toast("good", "MSA License deleted");
        await loadMSADocument();
      } catch (err) {
        console.error('Delete error:', err);
        toast("error", err.message);
      }
    }

    // Attach event listener to upload button
    document.addEventListener('DOMContentLoaded', () => {
      // Apply seasonal theming based on current date
      const now = new Date();
      const month = now.getMonth(); // 0-11
      let season = 'winter'; // default
      
      // Determine season based on approximate NATS calendar
      if (month >= 2 && month <= 3) {
        season = 'summer'; // March-April (Summer NATS)
      } else if (month >= 4 && month <= 5) {
        season = 'autumn'; // May-June (Autumn NATS)
      } else if (month >= 6 && month <= 7) {
        season = 'winter'; // July-August (Winter NATS)
      } else if (month >= 8 && month <= 9) {
        season = 'spring'; // September-October (Spring NATS)
      }
      
      document.body.setAttribute('data-season', season);
      
      const uploadBtn = document.getElementById('btnUploadMSA');
      if (uploadBtn) {
        uploadBtn.addEventListener('click', uploadMSALicense);
      }

      // Add listener to MSA tab to load document when clicked
      const msaSection = document.querySelector('[data-psection="msa"]');
      if (msaSection) {
        let lastLoadTime = 0;
        const observer = new MutationObserver(() => {
          const now = Date.now();
          // Only load if 500ms has passed since last load to prevent rapid recursion
          if (msaSection.classList.contains('active') && currentDriverId && (now - lastLoadTime) > 500) {
            lastLoadTime = now;
            loadMSADocument();
          }
        });
        observer.observe(msaSection, { attributes: true, attributeFilter: ['class'] });
      }
    });

    // PWA Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const registration = await navigator.serviceWorker.register('/service-worker.js');
          console.log(' ServiceWorker registered:', registration.scope);
          
          // Subscribe to push notifications after service worker is ready
          await subscribeToPushNotifications(registration);
          
          // Check for updates
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                // New version available - show update banner
                showUpdateBanner(newWorker);
              }
            });
          });
          
          // Also check for waiting service worker on page load
          if (registration.waiting) {
            showUpdateBanner(registration.waiting);
          }
        } catch (err) {
          console.log('ServiceWorker registration failed:', err);
        }
      });
      
      // Listen for messages from service worker
      navigator.serviceWorker.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'SW_UPDATED') {
          console.log('Service Worker updated to:', event.data.version);
          // Reload to get the latest version
          window.location.reload();
        }
      });
    }
    
    // Show update banner
    function showUpdateBanner(newWorker) {
      const banner = document.createElement('div');
      banner.id = 'updateBanner';
      banner.style.cssText = 'position:fixed;bottom:0;left:0;right:0;background:#2563eb;color:white;padding:16px;text-align:center;z-index:10000;display:flex;justify-content:center;align-items:center;gap:16px;';
      banner.innerHTML = `
        <span> A new version is available!</span>
        <button onclick="applyUpdate()" style="background:white;color:#2563eb;border:none;padding:8px 16px;border-radius:4px;font-weight:bold;cursor:pointer;">Update Now</button>
        <button onclick="this.parentElement.remove()" style="background:transparent;color:white;border:1px solid white;padding:8px 16px;border-radius:4px;cursor:pointer;">Later</button>
      `;
      document.body.appendChild(banner);
      window.pendingWorker = newWorker;
    }
    
    // Apply the update
    function applyUpdate() {
      if (window.pendingWorker) {
        window.pendingWorker.postMessage({ type: 'SKIP_WAITING' });
      }
      window.location.reload();
    }

    // PWA Install Prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      console.log('PWA: Install prompt available');
      
      // Show install button in header
      showInstallButton();
      
      // Also show banner after a delay
      setTimeout(() => {
        showInstallPrompt();
      }, 5000); // Show after 5 seconds
    });
    
    function showInstallButton() {
      // Add install button to header if not already there
      if (document.getElementById('pwa-install-btn')) return;
      
      const header = document.querySelector('.header-content') || document.querySelector('header');
      if (header) {
        const btn = document.createElement('button');
        btn.id = 'pwa-install-btn';
        btn.innerHTML = ' Install';
        btn.style.cssText = 'background: white; color: #e74c3c; border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; cursor: pointer; margin-left: 10px; font-size: 14px;';
        btn.onclick = installPWA;
        header.appendChild(btn);
      }
    }

    function showInstallPrompt() {
      if (!deferredPrompt) return;
      
      // Create install banner
      const banner = document.createElement('div');
      banner.id = 'pwa-install-banner';
      banner.innerHTML = `
        <div style="position: fixed; bottom: 20px; left: 20px; right: 20px; background: white; color: #333; padding: 20px; border-radius: 0; box-shadow: 0 18px 40px rgba(15,23,42,0.15), 0 0 0 1px rgba(15,23,42,0.12); z-index: 10000; border: 1px solid rgba(15,23,42,0.35);">
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
            <img src="/icons/icon-192.png" style="width: 60px; height: 60px; border-radius: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div>
              <div style="font-size: 11px; letter-spacing: 0.18em; text-transform: uppercase; color: #6b7280;">ROK Cup South Africa</div>
              <div style="font-size: 16px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: #111827; margin-top: 4px;">Install App</div>
              <div style="font-size: 12px; color: #6b7280; margin-top: 4px; letter-spacing: 0.05em;">Add to your home screen for quick access</div>
            </div>
          </div>
          <div style="display: flex; gap: 10px;">
            <button onclick="dismissInstall()" style="flex: 1; background: #fff; border: 1px solid rgba(15,23,42,0.12); color: #111827; padding: 10px 12px; border-radius: 0; cursor: pointer; font-size: 11px; font-weight: 500; letter-spacing: 0.18em; text-transform: uppercase; box-shadow: 0 14px 30px rgba(15,23,42,0.09);">Not Now</button>
            <button onclick="installPWA()" style="flex: 1; background: #0ea5e9; border: 1px solid rgba(15,23,42,0.35); color: white; padding: 10px 12px; border-radius: 0; cursor: pointer; font-size: 11px; font-weight: 600; letter-spacing: 0.18em; text-transform: uppercase; box-shadow: 0 18px 40px rgba(15,23,42,0.12);">Install</button>
          </div>
        </div>
      `;
      document.body.appendChild(banner);
    }

    async function installPWA() {
      console.log(' Install button clicked, deferredPrompt:', deferredPrompt);
      
      if (!deferredPrompt) {
        // Check if already installed
        if (window.matchMedia('(display-mode: standalone)').matches) {
          alert(' App is already installed!\n\nLook for the ROK Cup app on your home screen.');
          dismissInstall();
          return;
        }
        
        // Detect platform and show appropriate instructions
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isAndroid = /Android/.test(navigator.userAgent);
        const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
        
        let instructions = '';
        if (isIOS || isSafari) {
          instructions = ' On iPhone/iPad Safari:\n\n' +
            '1. Tap the Share button () at the bottom\n' +
            '2. Scroll down and tap "Add to Home Screen"\n' +
            '3. Tap "Add" to confirm';
        } else if (isAndroid) {
          instructions = ' On Android:\n\n' +
            '1. Tap the menu button () in the top right\n' +
            '2. Tap "Add to Home Screen" or "Install App"\n' +
            '3. Tap "Add" or "Install" to confirm';
        } else {
          instructions = ' On Desktop Chrome/Edge:\n\n' +
            '1. Look for the install icon () in the address bar\n' +
            '2. Click it and select "Install"\n\n' +
            'Or use the browser menu  "Install ROK Cup..."';
        }
        
        alert('To install this app:\n\n' + instructions);
        return;
      }
      
      try {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log('PWA install outcome:', outcome);
        
        if (outcome === 'accepted') {
          console.log(' PWA installed successfully');
        }
        
        deferredPrompt = null;
        dismissInstall();
      } catch (err) {
        console.error('Install error:', err);
        alert('Installation failed. Please try using the browser menu to install.');
      }
    }

    function dismissInstall() {
      const banner = document.getElementById('pwa-install-banner');
      if (banner) banner.remove();
    }

    // ==================== PUSH NOTIFICATIONS ====================
    
    async function subscribeToPushNotifications(registration) {
      try {
        // Check if push is supported
        if (!('PushManager' in window)) {
          console.log('Push notifications not supported');
          return;
        }
        
        // Get VAPID public key from server
        const keyResponse = await fetch('/api/push/vapid-public-key');
        const keyData = await keyResponse.json();
        
        if (!keyData.success || !keyData.publicKey) {
          console.log('No VAPID key available');
          return;
        }
        
        // Check existing subscription
        let subscription = await registration.pushManager.getSubscription();
        
        if (!subscription) {
          // Check permission
          const permission = await Notification.requestPermission();
          
          if (permission !== 'granted') {
            console.log('Push notification permission denied');
            return;
          }
          
          // Subscribe
          const applicationServerKey = urlBase64ToUint8Array(keyData.publicKey);
          subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey
          });
          
          console.log(' Push subscription created');
        } else {
          console.log(' Existing push subscription found');
        }
        
        // Send subscription to server
        const driverId = localStorage.getItem('loggedInDriverId');
        await fetch('/api/push/subscribe', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            subscription,
            driverId: driverId ? parseInt(driverId) : null
          })
        });
        
        console.log(' Push notifications enabled');
      } catch (err) {
        console.error('Push subscription error:', err);
      }
    }
    
    // Helper function to convert base64 to Uint8Array
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding)
        .replace(/-/g, '+')
        .replace(/_/g, '/');
      
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }
    
    // Check and update notification UI status
    async function updateNotificationUI() {
      const statusEl = document.getElementById('notificationStatus');
      const btnEl = document.getElementById('notificationToggleBtn');
      
      if (!statusEl || !btnEl) return;
      
      try {
        // Detect iOS
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                      (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        const isInStandaloneMode = window.matchMedia('(display-mode: standalone)').matches || 
                                   window.navigator.standalone === true;
        const isSecureContext = window.isSecureContext || location.protocol === 'https:' || location.hostname === 'localhost';
        
        // Debug logging
        console.log('Notification check:', {
          isIOS,
          isInStandaloneMode,
          isSecureContext,
          protocol: location.protocol,
          hostname: location.hostname,
          hasServiceWorker: 'serviceWorker' in navigator,
          hasPushManager: 'PushManager' in window,
          hasNotification: 'Notification' in window
        });
        
        // Check if we're in a secure context (HTTPS or localhost)
        if (!isSecureContext) {
          statusEl.innerHTML = '<strong>HTTPS Required</strong><br>Push notifications require a secure connection. Access via HTTPS or localhost.';
          statusEl.style.color = '#ef4444';
          btnEl.style.display = 'none';
          return;
        }
        
        // Check if basic requirements are met
        if (!('serviceWorker' in navigator)) {
          statusEl.textContent = 'Service Worker not supported on this browser';
          statusEl.style.color = '#ef4444';
          btnEl.style.display = 'none';
          return;
        }
        
        // For iOS, we need to wait for SW to be ready before checking PushManager
        if (isIOS && isInStandaloneMode) {
          // Check Notification API first (iOS 16.4+ requirement)
          if (!('Notification' in window)) {
            statusEl.textContent = 'Update to iOS 16.4 or later for notifications';
            statusEl.style.color = '#ef4444';
            btnEl.style.display = 'none';
            return;
          }
        }
        
        // Check if push is supported
        if (!('PushManager' in window)) {
          if (isIOS && !isInStandaloneMode) {
            // iOS user not in PWA mode
            statusEl.innerHTML = '<strong>iOS Instructions:</strong><br>1. Tap the Share button (square with arrow)<br>2. Select "Add to Home Screen"<br>3. Open the app from your home screen<br>4. Then enable notifications here';
            statusEl.style.color = '#f59e0b';
            btnEl.textContent = 'Not Available';
            btnEl.disabled = true;
            btnEl.style.background = '#9ca3af';
          } else if (isIOS) {
            // iOS in PWA mode but PushManager not available
            statusEl.textContent = 'Tap Enable to request permission';
            statusEl.style.color = '#6b7280';
            btnEl.textContent = 'Enable';
            btnEl.disabled = false;
            btnEl.onclick = requestIOSNotificationPermission;
          } else {
            statusEl.textContent = 'Not supported on this browser';
            btnEl.style.display = 'none';
          }
          return;
        }
        
        // Check permission
        const permission = Notification.permission;
        
        if (permission === 'denied') {
          statusEl.textContent = 'Blocked - enable in browser settings';
          statusEl.style.color = '#ef4444';
          btnEl.textContent = 'Blocked';
          btnEl.disabled = true;
          btnEl.style.background = '#9ca3af';
          return;
        }
        
        // Check subscription
        const registration = await navigator.serviceWorker.ready;
        const subscription = await registration.pushManager.getSubscription();
        
        if (subscription) {
          statusEl.textContent = 'Enabled - you will receive race updates';
          statusEl.style.color = '#10b981';
          btnEl.textContent = 'Disable';
          btnEl.classList.remove('primary');
          btnEl.style.background = '#ef4444';
        } else {
          statusEl.textContent = 'Disabled - tap to enable';
          statusEl.style.color = '#6b7280';
          btnEl.textContent = 'Enable';
          btnEl.classList.add('primary');
          btnEl.style.background = '';
        }
      } catch (err) {
        console.error('Error checking notification status:', err);
        statusEl.textContent = 'Unable to check status';
      }
    }
    
    // iOS-specific notification permission request
    async function requestIOSNotificationPermission() {
      const statusEl = document.getElementById('notificationStatus');
      const btnEl = document.getElementById('notificationToggleBtn');
      
      try {
        btnEl.disabled = true;
        btnEl.textContent = 'Requesting...';
        
        // On iOS, we must request Notification permission first
        const permission = await Notification.requestPermission();
        console.log('iOS Notification permission:', permission);
        
        if (permission === 'granted') {
          statusEl.textContent = 'Permission granted! Setting up...';
          statusEl.style.color = '#10b981';
          // Now try to subscribe to push
          await togglePushNotifications();
        } else if (permission === 'denied') {
          statusEl.textContent = 'Permission denied. Check Settings > Safari > Notifications';
          statusEl.style.color = '#ef4444';
          btnEl.textContent = 'Blocked';
          btnEl.disabled = true;
        } else {
          statusEl.textContent = 'Permission not granted';
          btnEl.textContent = 'Enable';
          btnEl.disabled = false;
        }
      } catch (err) {
        console.error('iOS permission error:', err);
        statusEl.textContent = 'Error: ' + err.message;
        btnEl.textContent = 'Try Again';
        btnEl.disabled = false;
      }
    }
    
    // Load notification history for the current driver
    async function loadNotificationHistory() {
      const container = document.getElementById('notificationHistoryList');
      const filterType = document.getElementById('notifFilterType');
      const filterEvent = document.getElementById('notifFilterEvent');
      
      if (!currentDriverId) {
        container.innerHTML = `
          <div class="notification-empty">
            <div class="notification-empty-icon"></div>
            <div>Please log in to view your notifications.</div>
          </div>
        `;
        return;
      }
      
      try {
        // Get notification history from server
        const response = await fetch(`/api/notifications/history?driverId=${currentDriverId}&type=${filterType?.value || ''}&eventId=${filterEvent?.value || ''}`);
        const data = await response.json();
        
        if (!data.success || !data.notifications || data.notifications.length === 0) {
          container.innerHTML = `
            <div class="notification-empty">
              <div class="notification-empty-icon"></div>
              <div>No notifications yet.</div>
              <div style="font-size: 12px; margin-top: 8px; color: #9ca3af;">
                Push notifications will appear here when you receive them.
              </div>
            </div>
          `;
          return;
        }
        
        // Populate event filter dropdown if not already done
        if (filterEvent && filterEvent.options.length <= 1) {
          const events = [...new Set(data.notifications.filter(n => n.event_name).map(n => JSON.stringify({ id: n.event_id, name: n.event_name })))];
          events.forEach(e => {
            const ev = JSON.parse(e);
            const opt = document.createElement('option');
            opt.value = ev.id;
            opt.textContent = ev.name;
            filterEvent.appendChild(opt);
          });
        }
        
        // Group notifications by date
        const grouped = {};
        data.notifications.forEach(n => {
          const date = new Date(n.created_at);
          const dateKey = date.toLocaleDateString('en-ZA', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
          if (!grouped[dateKey]) grouped[dateKey] = [];
          grouped[dateKey].push(n);
        });
        
        let html = '';
        Object.keys(grouped).forEach(dateKey => {
          html += `<div class="notification-group-header">${dateKey}</div>`;
          grouped[dateKey].forEach(n => {
            const time = new Date(n.created_at).toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' });
            const typeClass = n.notification_type || 'general';
            const typeLabel = {
              'event': 'Event Update',
              'registration': 'Registration',
              'payment': 'Payment',
              'general': 'General'
            }[typeClass] || 'General';
            
            html += `
              <div class="notification-item">
                <div class="notification-item-header">
                  <div class="notification-item-title">${escapeHtml(n.title)}</div>
                  <span class="notification-item-badge ${typeClass}">${typeLabel}</span>
                </div>
                <div class="notification-item-body">${escapeHtml(n.body)}</div>
                <div class="notification-item-footer">
                  <span>${time}</span>
                  ${n.event_name ? `<span class="notification-item-event">${escapeHtml(n.event_name)}</span>` : ''}
                </div>
              </div>
            `;
          });
        });
        
        container.innerHTML = html;
      } catch (err) {
        console.error('Error loading notifications:', err);
        container.innerHTML = `
          <div class="notification-empty">
            <div class="notification-empty-icon"></div>
            <div>Could not load notifications.</div>
          </div>
        `;
      }
    }
    
    // Helper function to escape HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Add filter change listeners
    document.addEventListener('DOMContentLoaded', function() {
      const filterType = document.getElementById('notifFilterType');
      const filterEvent = document.getElementById('notifFilterEvent');
      if (filterType) filterType.addEventListener('change', loadNotificationHistory);
      if (filterEvent) filterEvent.addEventListener('change', loadNotificationHistory);
    });
    
    // Toggle push notifications
    async function togglePushNotifications() {
      const statusEl = document.getElementById('notificationStatus');
      const btnEl = document.getElementById('notificationToggleBtn');
      
      try {
        btnEl.disabled = true;
        btnEl.textContent = '...';
        
        const registration = await navigator.serviceWorker.ready;
        let subscription = await registration.pushManager.getSubscription();
        
        if (subscription) {
          // Unsubscribe
          await subscription.unsubscribe();
          
          // Tell server
          await fetch('/api/push/unsubscribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ endpoint: subscription.endpoint })
          });
          
          statusEl.textContent = 'Notifications disabled';
          statusEl.style.color = '#6b7280';
        } else {
          // Request permission
          const permission = await Notification.requestPermission();
          
          if (permission !== 'granted') {
            statusEl.textContent = 'Permission denied - enable in browser settings';
            statusEl.style.color = '#ef4444';
            btnEl.disabled = false;
            updateNotificationUI();
            return;
          }
          
          // Get VAPID key
          const keyResponse = await fetch('/api/push/vapid-public-key');
          const keyData = await keyResponse.json();
          
          if (!keyData.success || !keyData.publicKey) {
            statusEl.textContent = 'Server not configured for notifications';
            btnEl.disabled = false;
            return;
          }
          
          // Subscribe
          const applicationServerKey = urlBase64ToUint8Array(keyData.publicKey);
          subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey
          });
          
          // Send to server
          const driverId = localStorage.getItem('loggedInDriverId');
          await fetch('/api/push/subscribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              subscription,
              driverId: driverId || null
            })
          });
          
          statusEl.textContent = 'Notifications enabled!';
          statusEl.style.color = '#10b981';
        }
        
        btnEl.disabled = false;
        updateNotificationUI();
      } catch (err) {
        console.error('Toggle notification error:', err);
        statusEl.textContent = 'Error: ' + err.message;
        statusEl.style.color = '#ef4444';
        btnEl.disabled = false;
      }
    }
    
    // Update notification UI when page loads
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(updateNotificationUI, 1000);
      
      // Auto-login if saved session exists
      const savedEmail = localStorage.getItem('driverEmail');
      const savedPassword = localStorage.getItem('driverPassword');
      if (savedEmail && savedPassword) {
        console.log(' Found saved session, attempting auto-login...');
        // Fill in the login fields
        const emailField = document.getElementById('login_identifier');
        const passField = document.getElementById('login_password');
        if (emailField && passField) {
          emailField.value = savedEmail;
          passField.value = savedPassword;
          // Trigger login after a short delay to let page initialize
          setTimeout(() => {
            const loginBtn = document.getElementById('btnLogin');
            if (loginBtn) {
              loginBtn.click();
            }
          }, 500);
        }
      }
    });

  </script>
</body>
</html>
